<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Invoice vs Bank Reconciliation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      * {
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #ffffff 100%);
        min-height: 100vh;
        padding: 20px;
        color: #1e3a5f;
        position: relative;
        overflow-x: hidden;
      }
      
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
          radial-gradient(circle at 20% 50%, rgba(37, 99, 235, 0.05) 0%, transparent 50%),
          radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.03) 0%, transparent 50%);
        pointer-events: none;
        z-index: 0;
      }
      
      .container {
        max-width: 1400px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }
      
      .header {
        text-align: center;
        margin-bottom: 50px;
        color: #1e3a5f;
        position: relative;
      }
      
      .header h1 {
        font-size: 3rem;
        font-weight: 800;
        margin: 0 0 15px 0;
        background: linear-gradient(135deg, #1e40af 0%, #2563eb 50%, #3b82f6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.5px;
      }
      
      .header .subtitle {
        font-size: 1.2rem;
        opacity: 0.85;
        font-weight: 400;
        color: #475569;
        margin-bottom: 15px;
      }
      
      .badge {
        display: inline-block;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(59, 130, 246, 0.08) 100%);
        padding: 8px 20px;
        border-radius: 25px;
        font-size: 0.875rem;
        margin-top: 10px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(37, 99, 235, 0.3);
        color: #2563eb;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      
      .main-card {
        background: #ffffff;
        border-radius: 24px;
        padding: 50px;
        box-shadow: 
          0 4px 20px rgba(37, 99, 235, 0.1),
          0 0 0 1px rgba(37, 99, 235, 0.1);
        margin-bottom: 40px;
        border: 1px solid rgba(37, 99, 235, 0.15);
      }
      
      .section-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1e40af;
        margin-bottom: 18px;
        display: flex;
        align-items: center;
        gap: 12px;
        letter-spacing: 0.3px;
      }
      
      .section-title i {
        color: #2563eb;
        font-size: 1.3rem;
      }
      
      .upload-section {
        margin-bottom: 35px;
      }
      
      .drop-zone {
        border: 2px dashed rgba(37, 99, 235, 0.3);
        border-radius: 16px;
        padding: 50px 30px;
        text-align: center;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.02) 0%, rgba(59, 130, 246, 0.05) 100%);
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      
      .drop-zone::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.1), transparent);
        transition: left 0.6s;
      }
      
      .drop-zone:hover::before {
        left: 100%;
      }
      
      .drop-zone:hover {
        border-color: rgba(37, 99, 235, 0.6);
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.08) 0%, rgba(59, 130, 246, 0.05) 100%);
        transform: translateY(-3px);
        box-shadow: 
          0 8px 25px rgba(37, 99, 235, 0.15),
          0 0 0 1px rgba(37, 99, 235, 0.2);
      }
      
      .drop-zone.dragover {
        border-color: #2563eb;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.12) 0%, rgba(59, 130, 246, 0.08) 100%);
        box-shadow: 
          0 0 0 4px rgba(37, 99, 235, 0.2),
          0 12px 30px rgba(37, 99, 235, 0.2);
        transform: scale(1.02);
      }
      
      .drop-zone-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #2563eb;
        opacity: 0.9;
        transition: all 0.3s ease;
      }
      
      .drop-zone:hover .drop-zone-icon {
        transform: scale(1.1);
        opacity: 1;
      }
      
      .drop-zone-text {
        color: #1e40af;
        font-size: 1.1rem;
        font-weight: 600;
        margin: 12px 0;
        letter-spacing: 0.2px;
      }
      
      .drop-zone-hint {
        color: #64748b;
        font-size: 0.9rem;
        margin-top: 10px;
      }
      
      .file-list {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      
      .file-item {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        color: #1e3a5f;
        padding: 14px 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 14px;
        font-size: 0.925rem;
        box-shadow: 
          0 2px 8px rgba(37, 99, 235, 0.1),
          0 0 0 1px rgba(37, 99, 235, 0.15);
        animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(37, 99, 235, 0.2);
      }
      
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-15px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      
      .file-item-icon {
        font-size: 1.3rem;
        color: #2563eb;
      }
      
      .file-item-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 300px;
        font-weight: 500;
        color: #1e3a5f;
      }
      
      .file-item-remove {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        transition: all 0.2s;
        font-weight: bold;
      }
      
      .file-item-remove:hover {
        background: rgba(220, 38, 38, 0.9);
        border-color: rgba(220, 38, 38, 1);
        color: white;
        transform: scale(1.15);
      }
      
      .submit-section {
        text-align: center;
        margin-top: 40px;
      }
      
      .submit-btn {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        color: #ffffff;
        border: none;
        padding: 18px 56px;
        border-radius: 14px;
        font-size: 1.15rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 
          0 4px 15px rgba(37, 99, 235, 0.3),
          0 0 0 1px rgba(37, 99, 235, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        gap: 12px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-size: 1rem;
      }
      
      .submit-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 
          0 8px 25px rgba(37, 99, 235, 0.4),
          0 0 0 1px rgba(37, 99, 235, 0.3);
        background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
      }
      
      .submit-btn:active:not(:disabled) {
        transform: translateY(-1px);
      }
      
      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .btn-delete, .btn-view {
        padding: 6px 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s ease;
        background: #ffffff;
      }
      
      .btn-delete {
        color: #ef4444;
        border-color: #fecaca;
      }
      
      .btn-delete:hover {
        background: #fef2f2;
        border-color: #ef4444;
      }
      
      .btn-view {
        color: #2563eb;
        border-color: #bfdbfe;
      }
      
      .btn-view:hover {
        background: #eff6ff;
        border-color: #2563eb;
      }
      
      .status {
        margin-top: 25px;
        padding: 16px 24px;
        border-radius: 12px;
        font-weight: 600;
        text-align: center;
        display: none;
        border: 1px solid;
      }
      
      .status.show {
        display: block;
        animation: fadeIn 0.4s ease;
      }
      
      @keyframes fadeIn {
        from { 
          opacity: 0; 
          transform: translateY(-10px);
        }
        to { 
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .status.processing {
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa;
        border-color: rgba(59, 130, 246, 0.3);
        border-left: 4px solid #3b82f6;
      }
      
      .progress-container {
        margin-top: 15px;
        display: none;
      }
      
      .progress-container.show {
        display: block;
      }
      
      .progress-bar-wrapper {
        width: 100%;
        height: 8px;
        background: rgba(37, 99, 235, 0.1);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 8px;
      }
      
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #2563eb 0%, #3b82f6 50%, #2563eb 100%);
        background-size: 200% 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
        animation: progress-shimmer 2s infinite;
      }
      
      @keyframes progress-shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
      
      .progress-text {
        font-size: 0.85rem;
        color: #475569;
        text-align: center;
        margin-top: 5px;
      }
      
      .search-filter-container {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      
      .search-input {
        flex: 1;
        min-width: 200px;
        padding: 10px 15px;
        background: #ffffff;
        border: 1px solid rgba(37, 99, 235, 0.2);
        border-radius: 8px;
        color: #1e3a5f;
        font-size: 0.9rem;
      }
      
      .search-input:focus {
        outline: none;
        border-color: #2563eb;
        background: #ffffff;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      
      .search-input::placeholder {
        color: #94a3b8;
      }
      
      .status.success {
        background: rgba(34, 197, 94, 0.15);
        color: #4ade80;
        border-color: rgba(34, 197, 94, 0.3);
        border-left: 4px solid #22c55e;
      }
      
      .status.error {
        background: rgba(239, 68, 68, 0.15);
        color: #f87171;
        border-color: rgba(239, 68, 68, 0.3);
        border-left: 4px solid #ef4444;
      }
      
      .results-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
        margin-top: 40px;
      }
      
      .results-secondary {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
        margin-top: 30px;
      }
      
      @media (min-width: 968px) {
        .results-secondary {
          grid-template-columns: 1fr 1fr;
        }
      }
      
      @media (max-width: 968px) {
        .header h1 {
          font-size: 2.2rem;
        }
        
        .main-card {
          padding: 30px 20px;
        }
      }
      
      .result-card {
        background: #ffffff;
        border-radius: 20px;
        padding: 35px;
        box-shadow: 
          0 4px 20px rgba(37, 99, 235, 0.1),
          0 0 0 1px rgba(37, 99, 235, 0.1);
        border: 1px solid rgba(37, 99, 235, 0.15);
      }
      
      .result-card h2 {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1e40af;
        margin: 0 0 25px 0;
        display: flex;
        align-items: center;
        gap: 12px;
        padding-bottom: 18px;
        border-bottom: 2px solid rgba(37, 99, 235, 0.2);
        letter-spacing: 0.3px;
      }
      
      .result-card h2 i {
        color: #2563eb;
      }
      
      .json-output {
        background: #f8fafc;
        color: #1e3a5f;
        padding: 25px;
        border-radius: 12px;
        max-height: 500px;
        overflow: auto;
        font-family: 'Courier New', 'Fira Code', monospace;
        font-size: 0.875rem;
        line-height: 1.7;
        border: 1px solid rgba(37, 99, 235, 0.2);
        box-shadow: inset 0 2px 8px rgba(37, 99, 235, 0.05);
      }
      
      .json-toggle {
        background: rgba(37, 99, 235, 0.1);
        border: 1px solid rgba(37, 99, 235, 0.3);
        color: #2563eb;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      
      .json-toggle:hover {
        background: rgba(37, 99, 235, 0.15);
        border-color: rgba(37, 99, 235, 0.5);
      }
      
      .json-container {
        display: none;
      }
      
      .json-container.show {
        display: block;
      }
      
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
        margin-bottom: 30px;
      }
      
      .summary-item {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(59, 130, 246, 0.08) 100%);
        padding: 24px;
        border-radius: 14px;
        border-left: 4px solid #2563eb;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(37, 99, 235, 0.15);
        border-left: 4px solid #2563eb;
      }
      
      .summary-item:hover {
        transform: translateY(-3px);
        box-shadow: 
          0 8px 25px rgba(37, 99, 235, 0.15),
          0 0 0 1px rgba(37, 99, 235, 0.2);
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(59, 130, 246, 0.12) 100%);
      }
      
      .summary-label {
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
      }
      
      .summary-value {
        font-size: 2rem;
        font-weight: 800;
        color: #1e40af;
        letter-spacing: -0.5px;
      }
      
      .summary-value.highlight {
        color: #2563eb;
      }
      
      .summary-value.success {
        color: #22c55e;
      }
      
      .summary-value.warning {
        color: #f59e0b;
      }
      
      .results-section {
        margin-top: 30px;
      }
      
      .results-section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e40af;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid rgba(37, 99, 235, 0.2);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .results-section-title i {
        color: #2563eb;
        font-size: 1.2rem;
      }
      
      .matches-table, .unmatched-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        background: #ffffff;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(37, 99, 235, 0.15);
      }
      
      .matches-table thead, .unmatched-table thead {
        background: rgba(37, 99, 235, 0.1);
      }
      
      .matches-table th, .unmatched-table th {
        padding: 16px;
        text-align: left;
        font-weight: 700;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #1e40af;
        border-bottom: 2px solid rgba(37, 99, 235, 0.3);
      }
      
      .matches-table td, .unmatched-table td {
        padding: 14px 16px;
        border-bottom: 1px solid rgba(37, 99, 235, 0.1);
        color: #1e3a5f;
        font-size: 0.9rem;
      }
      
      .matches-table tbody tr:hover, .unmatched-table tbody tr:hover {
        background: rgba(37, 99, 235, 0.05);
      }
      
      .unmatched-row:hover {
        background: rgba(37, 99, 235, 0.08) !important;
        transform: translateX(2px);
        transition: all 0.2s ease;
      }
      
      .unmatched-row.selected {
        background: rgba(37, 99, 235, 0.15) !important;
        border-left: 4px solid #2563eb;
      }
      
      .matches-table tbody tr:last-child td, .unmatched-table tbody tr:last-child td {
        border-bottom: none;
      }
      
      .amount-cell {
        font-weight: 700;
        color: #2563eb;
        font-family: 'Courier New', monospace;
      }
      
      .description-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .match-score {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 700;
        background: rgba(34, 197, 94, 0.2);
        color: #4ade80;
        border: 1px solid rgba(34, 197, 94, 0.3);
      }
      
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #64748b;
        font-size: 0.95rem;
      }
      
      .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.3;
        color: #2563eb;
      }
      
      .section-toggle {
        background: transparent;
        border: 1px solid rgba(37, 99, 235, 0.2);
        color: #2563eb;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: 15px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      
      .section-toggle:hover {
        background: rgba(37, 99, 235, 0.1);
        border-color: rgba(37, 99, 235, 0.4);
        color: #1e40af;
      }
      
      .toggleable-section {
        display: none;
        margin-top: 15px;
      }
      
      .toggleable-section.show {
        display: block;
      }
      
      input[type="file"] {
        display: none;
      }
      
      .upload-hint {
        background: rgba(37, 99, 235, 0.05);
        padding: 18px 20px;
        border-radius: 12px;
        margin-top: 25px;
        font-size: 0.9rem;
        color: #475569;
        line-height: 1.7;
        border: 1px solid rgba(37, 99, 235, 0.15);
      }
      
      .upload-hint strong {
        color: #2563eb;
        font-weight: 700;
      }
      
      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      
      ::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 5px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-file-invoice-dollar"></i> Invoice Reconciliation</h1>
        <div class="subtitle">Automated Invoice vs Bank Statement Matching</div>
        <div class="badge">
          <i class="fas fa-robot"></i> AI-Powered OCR & Matching
        </div>
      </div>

      <div class="main-card">
        <form id="recon-form">
          <div class="upload-section">
            <div class="section-title">
              <i class="fas fa-file-invoice"></i>
              Invoice Files
            </div>
            <div class="drop-zone" id="invoice-drop-zone">
              <div class="drop-zone-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <div class="drop-zone-text">
                Drag & Drop Invoice Files Here
              </div>
              <div class="drop-zone-hint">or click to browse</div>
              <input
                id="invoice"
                name="invoice"
                type="file"
                multiple
                accept="application/pdf,image/*,.xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
              />
            </div>
            <div id="invoice-file-list" class="file-list"></div>
          </div>

          <div class="upload-section">
            <div class="section-title">
              <i class="fas fa-university"></i>
              Bank Statement File(s) <span style="font-size: 0.85rem; color: #64748b; font-weight: 400;">(Multiple files supported)</span>
            </div>
            <div class="drop-zone" id="bank-drop-zone">
              <div class="drop-zone-icon">
                <i class="fas fa-file-alt"></i>
              </div>
              <div class="drop-zone-text">
                Drag & Drop Bank Statement(s) Here
              </div>
              <div class="drop-zone-hint">or click to browse (you can select multiple files)</div>
              <input
                id="bank"
                name="bank"
                type="file"
                multiple
                accept=".csv,application/pdf,image/*,.xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
              />
            </div>
            <div id="bank-file-list" class="file-list"></div>
          </div>

          <div class="upload-hint">
            <strong>Supported Formats:</strong> PDF, Excel (.xlsx, .xls), CSV, Images (PNG, JPG, etc.)
          </div>

          <div class="submit-section">
            <button type="submit" id="submit-btn" class="submit-btn">
              <i class="fas fa-play"></i>
              Run Reconciliation
            </button>
            <div id="status" class="status"></div>
            <div id="progress-container" class="progress-container">
              <div class="progress-bar-wrapper">
                <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
              </div>
              <div id="progress-text" class="progress-text">0%</div>
            </div>
          </div>
        </form>
      </div>

      <div class="results-grid">
        <div class="result-card">
          <h2>
            <i class="fas fa-chart-line"></i>
            Reconciliation Summary
          </h2>
          <div id="summary">
            <div style="text-align: center; color: #64748b; padding: 50px;">
              <i class="fas fa-chart-bar" style="font-size: 3.5rem; opacity: 0.2; margin-bottom: 20px; color: #2563eb;"></i>
              <div style="font-size: 1rem; font-weight: 500;">Run reconciliation to see results</div>
            </div>
          </div>
        </div>
        
        <div class="result-card">
          <h2>
            <i class="fas fa-history"></i>
            Reconciliation History
          </h2>
          <div id="history">
            <div style="text-align: center; color: #64748b; padding: 24px 16px 8px 16px;">
              <i class="fas fa-clock-rotate-left" style="font-size: 2.3rem; opacity: 0.25; margin-bottom: 10px; color: #2563eb;"></i>
              <div style="font-size: 0.95rem; font-weight: 500; margin-bottom: 6px;">
                Click the button to view reconciliation history
              </div>
              <div style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 10px;">
                Shows your past reconciliation runs with match counts & accuracy
              </div>
              <button
                type="button"
                id="history-load-btn"
                class="submit-btn"
                style="margin-top: 4px; padding: 8px 18px; font-size: 0.9rem;"
              >
                <i class="fas fa-clock-rotate-left"></i>
                View Reconciliation History
              </button>
            </div>
            <div id="history-search-container" style="display: none; margin-top: 15px; margin-bottom: 15px;">
              <div class="search-filter-container">
                <input
                  type="text"
                  id="history-search-input"
                  class="search-input"
                  placeholder="ðŸ” Search by invoice or bank file name..."
                  onkeyup="filterHistoryTable()"
                />
                <input
                  type="date"
                  id="history-date-from"
                  class="search-input"
                  style="flex: 0 0 150px;"
                  placeholder="From Date"
                  onchange="filterHistoryTable()"
                />
                <input
                  type="date"
                  id="history-date-to"
                  class="search-input"
                  style="flex: 0 0 150px;"
                  placeholder="To Date"
                  onchange="filterHistoryTable()"
                />
                <button
                  type="button"
                  class="json-toggle"
                  onclick="clearHistoryFilters()"
                  style="padding: 10px 15px;"
                  title="Clear all filters"
                >
                  <i class="fas fa-times"></i> Clear
                </button>
              </div>
            </div>
            <div id="history-table-container" style="margin-top: 12px;"></div>
          </div>
        </div>
      </div>
      
      <div class="results-secondary" id="results-secondary" style="display: none;">
        <div class="result-card">
          <h2>
            <i class="fas fa-code"></i>
            JSON Response
          </h2>
          <button class="json-toggle" id="json-toggle">
            <i class="fas fa-chevron-down"></i>
            <span>Show JSON</span>
          </button>
          <div class="json-container" id="json-container">
            <pre id="json-output" class="json-output">{}</pre>
          </div>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("recon-form");
      const statusEl = document.getElementById("status");
      const jsonOutput = document.getElementById("json-output");
      const summaryEl = document.getElementById("summary");
      const historyEl = document.getElementById("history");
      const historyBtn = document.getElementById("history-load-btn");
      const historyTableEl = document.getElementById("history-table-container");
      const submitBtn = document.getElementById("submit-btn");
      
      let historyData = [];
      let historyCurrentPage = 1;
      const historyPageSize = 10;

      // Prevent default drag behavior
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        document.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      function getFileIcon(fileName) {
        const ext = fileName.split('.').pop().toLowerCase();
        if (['pdf'].includes(ext)) return 'fa-file-pdf';
        if (['xlsx', 'xls'].includes(ext)) return 'fa-file-excel';
        if (['csv'].includes(ext)) return 'fa-file-csv';
        if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'fa-file-image';
        return 'fa-file';
      }

      function setupDragAndDrop(dropZoneId, inputId, fileListId, allowMultiple = false) {
        const dropZone = document.getElementById(dropZoneId);
        const input = document.getElementById(inputId);
        const fileList = document.getElementById(fileListId);

        if (!dropZone || !input || !fileList) return;

        dropZone.addEventListener("click", (e) => {
          e.stopPropagation();
          input.click();
        });

        dropZone.addEventListener("dragenter", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.add("dragover");
        });

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.add("dragover");
        });

        dropZone.addEventListener("dragleave", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!dropZone.contains(e.relatedTarget)) {
            dropZone.classList.remove("dragover");
          }
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.remove("dragover");

          const files = Array.from(e.dataTransfer.files);
          if (files.length === 0) return;

          try {
            if (allowMultiple) {
              const existingFiles = Array.from(input.files);
              const allFiles = [...existingFiles, ...files];
              const dataTransfer = new DataTransfer();
              allFiles.forEach((file) => dataTransfer.items.add(file));
              input.files = dataTransfer.files;
            } else {
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(files[0]);
              input.files = dataTransfer.files;
            }
            updateFileList(input, fileList, allowMultiple);
          } catch (err) {
            console.error("Error handling dropped files:", err);
            alert("Error adding files. Please try again.");
          }
        });

        input.addEventListener("change", () => {
          updateFileList(input, fileList, allowMultiple);
        });

        updateFileList(input, fileList, allowMultiple);
      }

      function updateFileList(input, fileListEl, allowMultiple) {
        const files = Array.from(input.files);
        if (files.length === 0) {
          fileListEl.innerHTML = "";
          return;
        }

        if (allowMultiple) {
          fileListEl.innerHTML = files
            .map(
              (file, index) => `
            <div class="file-item">
              <i class="fas ${getFileIcon(file.name)} file-item-icon"></i>
              <span class="file-item-name" title="${file.name}">${file.name}</span>
              <button type="button" class="file-item-remove" data-index="${index}">Ã—</button>
            </div>
          `
            )
            .join("");

          fileListEl.querySelectorAll(".file-item-remove").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const index = parseInt(btn.dataset.index);
              const dataTransfer = new DataTransfer();
              Array.from(input.files)
                .filter((_, i) => i !== index)
                .forEach((file) => dataTransfer.items.add(file));
              input.files = dataTransfer.files;
              updateFileList(input, fileListEl, allowMultiple);
            });
          });
        } else {
          fileListEl.innerHTML = `
            <div class="file-item">
              <i class="fas ${getFileIcon(files[0].name)} file-item-icon"></i>
              <span class="file-item-name" title="${files[0].name}">${files[0].name}</span>
              <button type="button" class="file-item-remove">Ã—</button>
            </div>
          `;
          fileListEl.querySelector(".file-item-remove").addEventListener("click", () => {
            input.value = "";
            fileListEl.innerHTML = "";
          });
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          setupDragAndDrop("invoice-drop-zone", "invoice", "invoice-file-list", true);
          setupDragAndDrop("bank-drop-zone", "bank", "bank-file-list", true); // Enable multiple bank files
          
           // History button click: load & show paginated history list on demand
          if (historyBtn) {
            historyBtn.addEventListener("click", () => {
              loadReconciliationHistory(500).catch(err => {
                console.error("Failed to load reconciliation history:", err);
              });
            });
          }
        });
      } else {
        setupDragAndDrop("invoice-drop-zone", "invoice", "invoice-file-list", true);
        setupDragAndDrop("bank-drop-zone", "bank", "bank-file-list", false);
        
        if (historyBtn) {
          historyBtn.addEventListener("click", () => {
            loadReconciliationHistory(500).catch(err => {
              console.error("Failed to load reconciliation history:", err);
            });
          });
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        statusEl.className = "status";
        statusEl.textContent = "";
        summaryEl.innerHTML = "";
        jsonOutput.textContent = "{}";
        document.getElementById("results-secondary").style.display = "none";

        const invoiceFiles = document.getElementById("invoice").files;
        const bankFiles = document.getElementById("bank").files;

        if (!invoiceFiles.length || !bankFiles.length) {
          statusEl.textContent = "Please select at least one invoice file and one bank file.";
          statusEl.className = "status error show";
          return;
        }

        const formData = new FormData();
        for (const file of invoiceFiles) {
          formData.append("invoice", file);
        }
        for (const file of bankFiles) {
          formData.append("bank", file);
        }

        submitBtn.disabled = true;
        const startTime = Date.now();
        let statusUpdateInterval;
        
        // Calculate PRE-PROCESSING estimate based on file sizes and types
        let totalFileSize = 0;
        let invoiceFileSizes = [];
        let invoiceFileTypes = [];
        let bankFileSizes = [];
        let bankFileTypes = [];
        
        for (const file of invoiceFiles) {
          totalFileSize += file.size;
          invoiceFileSizes.push(file.size);
          const fileName = file.name.toLowerCase();
          if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            invoiceFileTypes.push('.xlsx');
          } else if (fileName.endsWith('.csv')) {
            invoiceFileTypes.push('.csv');
          } else if (fileName.endsWith('.pdf')) {
            invoiceFileTypes.push('.pdf');
          } else {
            invoiceFileTypes.push('.image');
          }
        }
        
        for (const file of bankFiles) {
          totalFileSize += file.size;
          bankFileSizes.push(file.size);
          const bankFileName = file.name.toLowerCase();
          if (bankFileName.endsWith('.xlsx') || bankFileName.endsWith('.xls')) {
            bankFileTypes.push('.xlsx');
          } else if (bankFileName.endsWith('.csv')) {
            bankFileTypes.push('.csv');
          } else if (bankFileName.endsWith('.pdf')) {
            bankFileTypes.push('.pdf');
          } else {
            bankFileTypes.push('.image');
          }
        }
        
        const bankFileType = bankFileTypes[0] || '.pdf'; // Use first bank file type for estimation
        
        // Smart estimation based on file types
        let estimatedTimeSeconds = 0;
        let invoiceTxEstimate = 0;
        let bankTxEstimate = 0;
        
        // Estimate transactions and time based on file type
        for (let i = 0; i < invoiceFileSizes.length; i++) {
          const sizeMB = invoiceFileSizes[i] / (1024 * 1024);
          const fileType = invoiceFileTypes[i];
          
          if (fileType === '.xlsx') {
            invoiceTxEstimate += sizeMB * 800;
            estimatedTimeSeconds += sizeMB * 0.2; // Parsing
          } else if (fileType === '.csv') {
            invoiceTxEstimate += sizeMB * 1500;
            estimatedTimeSeconds += sizeMB * 0.1;
          } else if (fileType === '.pdf') {
            invoiceTxEstimate += sizeMB * 80;
            estimatedTimeSeconds += sizeMB * 0.5;
          } else {
            invoiceTxEstimate += sizeMB * 20;
            estimatedTimeSeconds += sizeMB * 5.0; // OCR is slow
          }
        }
        
        const totalBankSizeMB = bankFileSizes.reduce((sum, size) => sum + size, 0) / (1024 * 1024);
        if (bankFileType === '.xlsx') {
          bankTxEstimate = totalBankSizeMB * 800;
          estimatedTimeSeconds += totalBankSizeMB * 0.2;
        } else if (bankFileType === '.csv') {
          bankTxEstimate = totalBankSizeMB * 1500;
          estimatedTimeSeconds += totalBankSizeMB * 0.1;
        } else if (bankFileType === '.pdf') {
          bankTxEstimate = totalBankSizeMB * 80;
          estimatedTimeSeconds += totalBankSizeMB * 0.5;
        } else {
          bankTxEstimate = totalBankSizeMB * 20;
          estimatedTimeSeconds += totalBankSizeMB * 5.0;
        }
        
        // Estimate reconciliation time (based on transaction counts)
        // Rough formula: ~0.0006 seconds per comparison, but with optimization ~85% reduction
        const totalComparisons = invoiceTxEstimate * bankTxEstimate;
        const optimizedComparisons = totalComparisons * 0.15; // 85% reduction
        const reconciliationTime = 0.5 + (optimizedComparisons * 0.0006) + ((invoiceTxEstimate + bankTxEstimate) * 0.0002);
        estimatedTimeSeconds += reconciliationTime;
        
        // Minimum time
        estimatedTimeSeconds = Math.max(3, estimatedTimeSeconds);
        
        let estimatedTimeDisplay = estimatedTimeSeconds < 60 
          ? `${estimatedTimeSeconds.toFixed(0)} seconds` 
          : `${Math.floor(estimatedTimeSeconds / 60)} minute${Math.floor(estimatedTimeSeconds / 60) !== 1 ? 's' : ''} ${Math.floor(estimatedTimeSeconds % 60)} second${Math.floor(estimatedTimeSeconds % 60) !== 1 ? 's' : ''}`;
        
        // Show pre-processing estimate immediately
        statusEl.textContent = `â±ï¸ Estimated processing time: ${estimatedTimeDisplay} (${Math.round(invoiceTxEstimate)} invoices, ${Math.round(bankTxEstimate)} bank transactions estimated). Starting processing...`;
        statusEl.className = "status processing show";
        
        // Update status message periodically to show it's still processing
        let statusCounter = 0;
        const statusMessages = [
          `Processing files and running reconciliation... (Estimated: ${estimatedTimeDisplay})`,
          "Reading invoice files...",
          "Reading bank statement...",
          "Extracting transactions...",
          "Matching transactions...",
          "Finalizing results...",
        ];
        
        const updateStatusMessage = () => {
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
          const msgIndex = Math.min(statusCounter, statusMessages.length - 1);
          let msg = statusMessages[msgIndex];
          if (msgIndex > 0) {
            msg += ` (Elapsed: ${elapsed}s, Estimated: ${estimatedTimeDisplay})`;
          }
          statusEl.textContent = msg;
          statusCounter++;
        };
        
        // Start updating after 2 seconds
        setTimeout(() => {
          statusUpdateInterval = setInterval(updateStatusMessage, 3000);
        }, 2000);

        // Progress tracking variables
        let progressId = null;
        let progressInterval = null;
        const progressContainer = document.getElementById("progress-container");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");
        
        // Function to poll progress
        const pollProgress = async (id) => {
          try {
            const response = await fetch(`/api/progress/${id}`);
            if (!response.ok) return;
            
            const progress = await response.json();
            
            if (progress.status === "completed" || progress.status === "error") {
              clearInterval(progressInterval);
              progressContainer.classList.remove("show");
              return;
            }
            
            // Update progress bar
            const progressPercent = Math.round(progress.progress * 100);
            progressBar.style.width = `${progressPercent}%`;
            progressText.textContent = `${progressPercent}% - ${progress.message || "Processing..."}`;
            progressContainer.classList.add("show");
          } catch (error) {
            console.error("Error polling progress:", error);
          }
        };
        
        try {
          // Generate progress ID
          progressId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          
          // Start polling progress (will start after response)
          const res = await fetch(`/api/reconcile?progress_id=${progressId}`, {
            method: "POST",
            body: formData,
          });
          
          // Start polling progress immediately
          if (progressId) {
            progressInterval = setInterval(() => pollProgress(progressId), 1000); // Poll every second
          }

          clearInterval(statusUpdateInterval);
          
          // Stop progress polling
          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
          
          // Hide progress bar
          if (progressContainer) {
            progressContainer.classList.remove("show");
          }
          
          let data;
          try {
            data = await res.json();
          } catch (jsonErr) {
            console.error("Failed to parse JSON response:", jsonErr);
            const text = await res.text();
            console.error("Response text:", text.substring(0, 500));
            statusEl.textContent = "Error: Server returned invalid response. Check console for details.";
            statusEl.className = "status error show";
            submitBtn.disabled = false;
            return;
          }
          
          // Update detected currency from response
          if (data.currency) {
            detectedCurrency = data.currency;
            console.log(`Currency detected: ${detectedCurrency}`);
          }
          
          // Always show JSON output for debugging
          try {
            jsonOutput.textContent = JSON.stringify(data, null, 2);
          } catch (jsonErr) {
            console.error("Failed to stringify JSON:", jsonErr);
            jsonOutput.textContent = "Error displaying JSON output";
          }

          // Check if response has progress_id
          if (data.progress_id && progressId !== data.progress_id) {
            progressId = data.progress_id;
            // Continue polling with new ID
            if (progressId) {
              progressInterval = setInterval(() => pollProgress(progressId), 1000);
            }
          }
          
          if (!res.ok) {
            const processingTime = data.processing_time_seconds 
              ? ` (took ${data.processing_time_seconds.toFixed(2)}s)` 
              : "";
            statusEl.textContent = (data.error || "Something went wrong.") + processingTime;
            statusEl.className = "status error show";
            // Still try to show results if available
            if (data.reconciliation) {
              renderSummary(data);
              document.getElementById("results-secondary").style.display = "grid";
            }
            submitBtn.disabled = false;
            return;
          }

          // Get processing time from response
          const processingTime = data.reconciliation?.processing_time_formatted 
            || (data.reconciliation?.processing_time_seconds 
              ? `${data.reconciliation.processing_time_seconds.toFixed(2)} seconds` 
              : "");
          
          // Get pre-processing estimate (from file sizes)
          const preEstimate = data.pre_processing_estimate || {};
          const preEstTime = preEstimate.total_estimated_time_formatted || '';
          
          // Get estimated time (after parsing, more accurate)
          const estimatedTime = data.reconciliation?.estimated_time_formatted 
            || (data.reconciliation?.estimated_time_seconds 
              ? `${data.reconciliation.estimated_time_seconds.toFixed(2)} seconds` 
              : "");
          
          let timeComparison = "";
          if (preEstTime && processingTime) {
            const preEstSeconds = preEstimate.total_estimated_time || 0;
            const actSeconds = data.reconciliation?.processing_time_seconds || 0;
            if (preEstSeconds > 0 && actSeconds > 0) {
              const diff = ((actSeconds - preEstSeconds) / preEstSeconds * 100).toFixed(0);
              if (Math.abs(diff) > 5) {
                timeComparison = ` (Pre-estimate: ${preEstTime}, ${diff > 0 ? '+' : ''}${diff}% ${diff > 0 ? 'slower' : 'faster'})`;
              } else {
                timeComparison = ` (Pre-estimate: ${preEstTime}, very accurate!)`;
              }
            }
          }
          
          statusEl.textContent = `âœ“ Reconciliation completed successfully! ${processingTime ? `(Processing time: ${processingTime}${timeComparison})` : ''}`;
          statusEl.className = "status success show";
          
          // Store reconciliation data for manual matching
          currentReconciliationData = data;
          
          // Always render summary - even if empty
          try {
            renderSummary(data);
            // After initial render, refresh using DB-joined matches so invoice numbers/IDs are authoritative
            try {
              const rid = data?.reconciliation?.reconciliation_id || data?.reconciliation?.id;
              if (rid) {
                await refreshReconciliation(rid);
              }
            } catch (refreshErr) {
              console.warn('Could not refresh reconciliation from DB:', refreshErr);
            }
          } catch (renderErr) {
            console.error("Error rendering summary:", renderErr);
            summaryEl.innerHTML = `
              <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <div>Error displaying results. Check console for details.</div>
                <div style="font-size: 0.8rem; margin-top: 10px; color: #64748b;">
                  Data received: ${data ? 'Yes' : 'No'}
                </div>
              </div>
            `;
          }
          
          // If user has already loaded history once, refresh it in the background
          if (historyData && historyData.length > 0) {
            try {
              await loadReconciliationHistory();
            } catch (err) {
              console.error("Failed to refresh reconciliation history:", err);
            }
          }
          document.getElementById("results-secondary").style.display = "grid";
        } catch (err) {
          clearInterval(statusUpdateInterval);
          console.error("Reconciliation error:", err);
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
          statusEl.textContent = `Network error. Please check the server connection. (Took ${elapsed}s)`;
          statusEl.className = "status error show";
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Global currency variable (set from API response)
      let detectedCurrency = 'â‚¹'; // Default to â‚¹
      
      function formatCurrency(amount, currency = null) {
        const curr = currency || detectedCurrency;
        if (amount === null || amount === undefined) return curr + '0.00';
        const num = parseFloat(amount);
        if (isNaN(num)) return curr + '0.00';
        const sign = num < 0 ? '-' : '';
        const absNum = Math.abs(num);
        return sign + curr + absNum.toLocaleString('en-IN', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }
      
      function renderHistoryTablePage(page) {
        if (!historyTableEl) return;
        
        if (!historyData || historyData.length === 0) {
          historyTableEl.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-circle-info"></i>
              <div>No reconciliation history found yet.</div>
            </div>
          `;
          return;
        }
        
        const totalItems = historyData.length;
        const totalPages = Math.max(1, Math.ceil(totalItems / historyPageSize));
        const safePage = Math.min(Math.max(1, page), totalPages);
        historyCurrentPage = safePage;
        
        const startIndex = (safePage - 1) * historyPageSize;
        const endIndex = Math.min(startIndex + historyPageSize, totalItems);
        const pageItems = historyData.slice(startIndex, endIndex);

        const rowsHtml = pageItems.map(item => {
          const createdAt = formatDate(item.created_at);
          const matchCount = item.match_count ?? 0;
          const onlyInv = item.only_in_invoices_count ?? 0;
          const onlyBank = item.only_in_bank_count ?? 0;
          const invRows = item.total_invoice_rows ?? (matchCount + onlyInv);
          const bankRows = item.total_bank_rows ?? (matchCount + onlyBank);

          const invAcc = invRows > 0 ? (matchCount / invRows * 100) : 0;
          const bankAcc = bankRows > 0 ? (matchCount / bankRows * 100) : 0;

          const invAccClass = invAcc >= 80 ? "success" : invAcc >= 50 ? "warning" : "";
          const bankAccClass = bankAcc >= 80 ? "success" : bankAcc >= 50 ? "warning" : "";

          return `
            <tr data-reconciliation-id="${item.id}">
              <td>#${item.id}</td>
              <td title="${item.invoice_file || '-'}">${truncateText(item.invoice_file || '-', 28)}</td>
              <td title="${item.bank_file || '-'}">${truncateText(item.bank_file || '-', 28)}</td>
              <td>${createdAt}</td>
              <td class="amount-cell">${matchCount}</td>
              <td class="amount-cell">${onlyInv}</td>
              <td class="amount-cell">${onlyBank}</td>
              <td class="amount-cell ${invAccClass}">${invAcc.toFixed(1)}%</td>
              <td class="amount-cell ${bankAccClass}">${bankAcc.toFixed(1)}%</td>
              <td>
                <button
                  type="button"
                  class="json-toggle"
                  style="padding: 4px 10px; font-size: 0.75rem; background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.4); color: #f87171;"
                  onclick="deleteReconciliation(${item.id}, event)"
                  title="Delete this reconciliation"
                >
                  <i class="fas fa-trash"></i> Delete
                </button>
              </td>
            </tr>
          `;
        }).join('');

        historyTableEl.innerHTML = `
          <div style="width: 100%; overflow-x: auto;">
            <table class="matches-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Invoice File(s)</th>
                  <th>Bank File</th>
                  <th>Created At</th>
                  <th>Matches</th>
                  <th>Only In Invoices</th>
                  <th>Only In Bank</th>
                  <th>Invoice Accuracy</th>
                  <th>Bank Accuracy</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 0.85rem; color: #475569;">
            <div>
              Showing <strong>${startIndex + 1}</strong>â€“<strong>${endIndex}</strong> of <strong>${totalItems}</strong> runs
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <button
                type="button"
                class="json-toggle"
                id="history-prev-page"
                ${safePage === 1 ? 'disabled style="opacity:0.4; cursor:not-allowed;"' : ''}
              >
                <i class="fas fa-chevron-left"></i>
                <span>Prev</span>
              </button>
              <span>Page ${safePage} of ${totalPages}</span>
              <button
                type="button"
                class="json-toggle"
                id="history-next-page"
                ${safePage === totalPages ? 'disabled style="opacity:0.4; cursor:not-allowed;"' : ''}
              >
                <span>Next</span>
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        `;
        
        const prevBtn = document.getElementById("history-prev-page");
        const nextBtn = document.getElementById("history-next-page");
        
        if (prevBtn) {
          prevBtn.addEventListener("click", () => {
            if (historyCurrentPage > 1) {
              renderHistoryTablePage(historyCurrentPage - 1);
            }
          });
        }
        
        if (nextBtn) {
          nextBtn.addEventListener("click", () => {
            const maxPages = Math.max(1, Math.ceil(historyData.length / historyPageSize));
            if (historyCurrentPage < maxPages) {
              renderHistoryTablePage(historyCurrentPage + 1);
            }
          });
        }
      }
      
      // Delete reconciliation function
      async function deleteReconciliation(reconciliationId, event) {
        event.stopPropagation();
        
        if (!confirm(`Are you sure you want to delete reconciliation #${reconciliationId}? This will also delete all associated matches. This action cannot be undone.`)) {
          return;
        }
        
        try {
          const statusEl = document.getElementById("status");
          if (statusEl) {
            statusEl.textContent = `Deleting reconciliation #${reconciliationId}...`;
            statusEl.className = "status processing show";
          }
          
          const response = await fetch(`/api/reconciliations/${reconciliationId}`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            if (statusEl) {
              statusEl.textContent = `Error: ${result.error || 'Unknown error'}`;
              statusEl.className = "status error show";
            }
            alert(`Error deleting reconciliation: ${result.error || 'Unknown error'}`);
            return;
          }
          
          if (statusEl) {
            statusEl.textContent = `âœ“ Reconciliation #${reconciliationId} deleted successfully!`;
            statusEl.className = "status success show";
            setTimeout(() => {
              statusEl.className = "status success";
            }, 3000);
          }
          
          // Remove the row from UI immediately
          const row = document.querySelector(`tr[data-reconciliation-id="${reconciliationId}"]`);
          if (row) {
            row.style.opacity = '0.5';
            row.style.transition = 'opacity 0.3s';
            setTimeout(() => {
              row.remove();
              // Reload history to refresh the table
              loadReconciliationHistory();
            }, 300);
          } else {
            // If row not found, just reload history
            loadReconciliationHistory();
          }
        } catch (error) {
          console.error('Error deleting reconciliation:', error);
          const statusEl = document.getElementById("status");
          if (statusEl) {
            statusEl.textContent = "Error deleting reconciliation. Please try again.";
            statusEl.className = "status error show";
          }
          alert('Error deleting reconciliation. Please try again.');
        }
      }
      
      async function loadReconciliationHistory(limit = 20, search = null, dateFrom = null, dateTo = null) {
        if (!historyTableEl) return;
        
        try {
          if (historyBtn) {
            historyBtn.disabled = true;
            historyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span style="margin-left:6px;">Loading...</span>';
          }
          
          // Build query parameters
          let url = `/api/reconciliations?limit=${encodeURIComponent(limit)}`;
          if (search) url += `&search=${encodeURIComponent(search)}`;
          if (dateFrom) url += `&date_from=${encodeURIComponent(dateFrom)}`;
          if (dateTo) url += `&date_to=${encodeURIComponent(dateTo)}`;
          
          const res = await fetch(url);
          const data = await res.json();
          
          if (!res.ok) {
            console.error("Failed to load reconciliation history:", data);
            return;
          }
          
          historyData = data.reconciliations || [];
          
          // Show search container if history is loaded
          const searchContainer = document.getElementById("history-search-container");
          if (searchContainer && historyData.length > 0) {
            searchContainer.style.display = "block";
          }
          
          renderHistoryTablePage(1);
        } catch (err) {
          console.error("Error loading reconciliation history:", err);
        } finally {
          if (historyBtn) {
            historyBtn.disabled = false;
            historyBtn.innerHTML = '<i class="fas fa-rotate"></i><span style="margin-left:6px;">Refresh History</span>';
          }
        }
      }
      
      // Filter history table
      function filterHistoryTable() {
        const searchInput = document.getElementById("history-search-input");
        const dateFromInput = document.getElementById("history-date-from");
        const dateToInput = document.getElementById("history-date-to");
        
        const search = searchInput ? searchInput.value.trim() : null;
        const dateFrom = dateFromInput ? dateFromInput.value : null;
        const dateTo = dateToInput ? dateToInput.value : null;
        
        // Reload history with filters
        loadReconciliationHistory(50, search || null, dateFrom || null, dateTo || null);
      }
      
      // Clear history filters
      function clearHistoryFilters() {
        const searchInput = document.getElementById("history-search-input");
        const dateFromInput = document.getElementById("history-date-from");
        const dateToInput = document.getElementById("history-date-to");
        
        if (searchInput) searchInput.value = "";
        if (dateFromInput) dateFromInput.value = "";
        if (dateToInput) dateToInput.value = "";
        
        // Reload without filters
        loadReconciliationHistory(50);
      }
      
      function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
          const tryFormat = (d) => d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });

          // First try native Date parsing
          let date = new Date(dateStr);
          if (!Number.isNaN(date.getTime())) {
            return tryFormat(date);
          }

          // Try common non-ISO formats that native Date() often fails on
          const s = String(dateStr).trim();

          // DD-MM-YYYY or DD/MM/YYYY
          let m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
          if (m) {
            const dd = parseInt(m[1], 10);
            const mm = parseInt(m[2], 10);
            const yyyy = parseInt(m[3], 10);
            date = new Date(yyyy, mm - 1, dd);
            if (!Number.isNaN(date.getTime())) return tryFormat(date);
          }

          // YYYY-MM-DD
          m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
          if (m) {
            const yyyy = parseInt(m[1], 10);
            const mm = parseInt(m[2], 10);
            const dd = parseInt(m[3], 10);
            date = new Date(yyyy, mm - 1, dd);
            if (!Number.isNaN(date.getTime())) return tryFormat(date);
          }

          return s || '-';
        } catch {
          return dateStr;
        }
      }
      
      function truncateText(text, maxLength = 50) {
        if (!text) return '-';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
      }

      function renderSummary(data) {
        const recon = data.reconciliation || {};
        const matches = recon.matches || [];
        const onlyInv = recon.only_in_invoices || [];
        const onlyBank = recon.only_in_bank || [];
        const acc = recon.accuracy || {};
        const invAcc = acc.invoice_match_percentage ?? 0;
        const bankAcc = acc.bank_match_percentage ?? 0;
        const reconId = recon.reconciliation_id ?? "-";
        const processingTime = recon.processing_time_formatted || 
          (recon.processing_time_seconds ? `${recon.processing_time_seconds.toFixed(2)} seconds` : "");

        const invAccClass = invAcc >= 80 ? "success" : invAcc >= 50 ? "warning" : "";
        const bankAccClass = bankAcc >= 80 ? "success" : bankAcc >= 50 ? "warning" : "";
        
        // Pre-processing estimate (from file sizes, before parsing)
        const preEstimate = data.pre_processing_estimate || {};
        const preEstTime = preEstimate.total_estimated_time_formatted || '';
        const preEstParsing = preEstimate.estimated_parsing_time || 0;
        const preEstRecon = preEstimate.estimated_reconciliation_time || 0;
        const preEstTx = preEstimate.estimated_transactions || {};
        
        // Post-parsing estimate (more accurate, after we know actual transaction counts)
        const estimatedTime = recon.estimated_time_formatted || 
          (recon.estimated_time_seconds ? `${recon.estimated_time_seconds.toFixed(2)} seconds` : "");

        let matchesTableHTML = '';
        if (matches.length > 0) {
          matchesTableHTML = `
            <table class="matches-table">
              <thead>
                <tr>
                  <th>Invoice ID</th>
                  <th>Invoice Number</th>
                  <th>Invoice Date</th>
                  <th>Invoice Description</th>
                  <th>Invoice Amount</th>
                  <th>Transaction ID</th>
                  <th>Bank Date</th>
                  <th>Bank Description</th>
                  <th>Bank Amount</th>
                  <th>Balance</th>
                  <th>Credit/Debit</th>
                  <th>Match Score</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${matches.map((match, matchIndex) => {
                  const inv = match.invoice || {};
                  const bank = match.bank || {};
                  const score = (match.match_score * 100).toFixed(1);
                  const isManual = match.is_manual_match || false;
                  // Use match_id from database (can be 0, which is valid)
                  // Fallback to matchIndex only if match_id is truly missing (undefined/null)
                  let matchId;
                  if (match.match_id !== undefined && match.match_id !== null) {
                    matchId = match.match_id;
                  } else {
                    matchId = matchIndex;
                    console.warn(`Match at index ${matchIndex} missing match_id. Using index ${matchIndex} as fallback. This may cause delete to fail.`);
                  }
                  
                  // Get invoice_id, transaction_id, and invoice_file_id from match
                  const invoiceId = match.invoice_id || inv.id || 'N/A';
                  const transactionId = match.transaction_id || bank.id || 'N/A';
                  const invoiceFileId = match.invoice_file_id;
                  const hasInvoiceImage = invoiceFileId !== null && invoiceFileId !== undefined;

                  let pageFragment = '';
                  if (inv.file_name && inv.file_name.includes('#')) {
                    pageFragment = '#' + inv.file_name.split('#')[1];
                  }
                  
                  const bankDirection = bank.direction || (bank.amount && bank.amount > 0 ? 'credit' : 'debit');
                  const bankBalance = bank.balance || 'N/A';

                  return `
                    <tr data-match-id="${match.id || ''}">
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${invoiceId}</td>
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${inv.invoice_number || match.invoice_number || 'N/A'}</td>
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${formatDate(inv.date)}</td>
                      <td class="description-cell" title="${(inv.description || '').replace(/"/g, '&quot;')}">${truncateText(inv.description, 30)}</td>
                      <td class="amount-cell">${formatCurrency(inv.amount || 0)}</td>
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${transactionId}</td>
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${formatDate(bank.date)}</td>
                      <td class="description-cell" title="${(bank.description || '').replace(/"/g, '&quot;')}">${truncateText(bank.description, 30)}</td>
                      <td class="amount-cell">${formatCurrency(bank.amount || 0)}</td>
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${bankBalance}</td>
                      <td style="font-size: 0.85rem; color: ${bankDirection === 'credit' ? '#059669' : '#dc2626'}; font-weight: 600;">
                        <i class="fas fa-arrow-${bankDirection === 'credit' ? 'up' : 'down'}" style="margin-right: 4px;"></i>
                        ${bankDirection.toUpperCase()}
                      </td>
                      <td>
                        <span class="match-score">${score}%</span>
                        ${isManual ? '<span style="margin-left: 6px; font-size: 0.7rem; color: #2563eb; font-weight: 600;" title="Manual Match">(Manual)</span>' : ''}
                      </td>
                      <td>
                        <button 
                          class="btn-delete" 
                          onclick="deleteMatch(${recon.id}, ${match.id || 'null'})"
                          title="Delete match"
                        >
                          <i class="fas fa-trash"></i>
                        </button>
                        <button 
                          class="btn-view" 
                          onclick="viewInvoiceImage('${inv.file_path || ''}', '${inv.invoice_number || 'N/A'}')"
                          title="View Invoice Image"
                          style="margin-left: 5px;"
                        >
                          <i class="fas fa-eye"></i>
                        </button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        }

        let unmatchedInvHTML = '';
        if (onlyInv.length > 0) {
          unmatchedInvHTML = `
            <table class="unmatched-table" id="unmatched-invoices-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${onlyInv.map((item, index) => `
                  <tr class="unmatched-row" data-type="invoice" data-index="${index}" style="cursor: pointer;">
                    <td class="description-cell" title="${(item.description || '').replace(/"/g, '&quot;')}">${truncateText(item.description, 50)}</td>
                    <td class="amount-cell">${formatCurrency(item.amount || 0)}</td>
                    <td>${formatDate(item.date)}</td>
                    <td>
                      <div style="display: flex; gap: 6px;">
                        <button 
                          type="button" 
                          class="json-toggle" 
                          style="padding: 6px 12px; font-size: 0.8rem;"
                          onclick="selectForManualMatch('invoice', ${index}, event)"
                          title="Match with existing bank transaction"
                        >
                          <i class="fas fa-link"></i> Match Existing
                        </button>
                        <button 
                          type="button" 
                          class="json-toggle" 
                          style="padding: 6px 12px; font-size: 0.8rem; background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #4ade80;"
                          onclick="uploadDocumentToMatch('invoice', ${index}, event)"
                          title="Upload bank statement document to match"
                        >
                          <i class="fas fa-upload"></i> Upload Bank Doc
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }

        let unmatchedBankHTML = '';
        if (onlyBank.length > 0) {
          unmatchedBankHTML = `
            <table class="unmatched-table" id="unmatched-bank-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${onlyBank.map((item, index) => `
                  <tr class="unmatched-row" data-type="bank" data-index="${index}" style="cursor: pointer;">
                    <td class="description-cell" title="${(item.description || '').replace(/"/g, '&quot;')}">${truncateText(item.description, 50)}</td>
                    <td class="amount-cell">${formatCurrency(item.amount || 0)}</td>
                    <td>${formatDate(item.date)}</td>
                    <td>
                      <div style="display: flex; gap: 6px;">
                        <button 
                          type="button" 
                          class="json-toggle" 
                          style="padding: 6px 12px; font-size: 0.8rem;"
                          onclick="selectForManualMatch('bank', ${index}, event)"
                          title="Match with existing invoice"
                        >
                          <i class="fas fa-link"></i> Match Existing
                        </button>
                        <button 
                          type="button" 
                          class="json-toggle" 
                          style="padding: 6px 12px; font-size: 0.8rem; background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #4ade80;"
                          onclick="uploadDocumentToMatch('bank', ${index}, event)"
                          title="Upload invoice document to match"
                        >
                          <i class="fas fa-upload"></i> Upload Invoice Doc
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }

        const totalInvoiceTxs = matches.length + onlyInv.length;
        const totalBankTxs = matches.length + onlyBank.length;
        
        summaryEl.innerHTML = `
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">Reconciliation ID</div>
              <div class="summary-value highlight">#${reconId}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total Matches</div>
              <div class="summary-value ${matches.length > 0 ? 'success' : ''}">${matches.length}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Only in Invoices</div>
              <div class="summary-value">${onlyInv.length}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Only in Bank</div>
              <div class="summary-value">${onlyBank.length}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Invoice Accuracy</div>
              <div class="summary-value ${invAccClass}">${invAcc.toFixed(2)}%</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
                ${matches.length} of ${totalInvoiceTxs} matched
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Bank Accuracy</div>
              <div class="summary-value ${bankAccClass}">${bankAcc.toFixed(2)}%</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
                ${matches.length} of ${totalBankTxs} matched
              </div>
            </div>
            ${preEstTime || estimatedTime || processingTime ? `
            <div class="summary-item" style="grid-column: 1 / -1; border-top: 2px solid rgba(37, 99, 235, 0.3); padding-top: 20px; margin-top: 10px;">
              ${preEstTime ? `
              <div class="summary-label">
                <i class="fas fa-hourglass-start" style="margin-right: 6px;"></i>
                Pre-Processing Estimate (Based on File Sizes)
              </div>
              <div class="summary-value" style="color: #2563eb; font-size: 1.6rem; margin-bottom: 8px;">${preEstTime}</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px; margin-bottom: 12px;">
                Estimated before processing started (${preEstTx.invoice || '?'} invoices, ${preEstTx.bank || '?'} bank transactions estimated)
                ${preEstParsing ? ` | Parsing: ${preEstParsing.toFixed(1)}s` : ''}
                ${preEstRecon ? ` | Reconciliation: ${preEstRecon.toFixed(1)}s` : ''}
              </div>
              ` : ''}
              ${estimatedTime ? `
              <div class="summary-label">
                <i class="fas fa-clock" style="margin-right: 6px;"></i>
                Post-Parsing Estimate (After Reading Files)
              </div>
              <div class="summary-value" style="color: #2563eb; font-size: 1.6rem; margin-bottom: 8px;">${estimatedTime}</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px; margin-bottom: ${processingTime ? '12px' : '0'};">
                More accurate estimate after parsing files (based on actual transaction counts)
              </div>
              ` : ''}
              ${processingTime ? `
              <div class="summary-label">
                <i class="fas fa-check-circle" style="margin-right: 6px;"></i>
                Actual Processing Time
              </div>
              <div class="summary-value highlight" style="font-size: 2rem;">${processingTime}</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
                Actual time taken to process and reconcile all transactions
                ${(() => {
                  let comparison = '';
                  if (preEstTime && recon.processing_time_seconds && preEstimate.total_estimated_time) {
                    const preEst = preEstimate.total_estimated_time;
                    const act = recon.processing_time_seconds;
                    const diff = ((act - preEst) / preEst * 100).toFixed(0);
                    if (Math.abs(diff) > 5) {
                      comparison = ` | ${diff > 0 ? '+' : ''}${diff}% ${diff > 0 ? 'slower' : 'faster'} than pre-estimate`;
                    } else {
                      comparison = ' | Very close to pre-estimate!';
                    }
                  } else if (estimatedTime && recon.estimated_time_seconds && recon.processing_time_seconds) {
                    const est = recon.estimated_time_seconds;
                    const act = recon.processing_time_seconds;
                    const diff = ((act - est) / est * 100).toFixed(0);
                    if (Math.abs(diff) > 5) {
                      comparison = ` | ${diff > 0 ? '+' : ''}${diff}% ${diff > 0 ? 'slower' : 'faster'} than post-estimate`;
                    } else {
                      comparison = ' | Very close to estimate!';
                    }
                  }
                  return comparison;
                })()}
              </div>
              ` : ''}
            </div>
            ` : ''}
          </div>
          
          ${matches.length > 0 ? `
            <div class="results-section">
              <div class="results-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-check-circle"></i>
                  Matched Transactions (${matches.length})
                </div>
                <div style="display: flex; gap: 8px;">
                  <button
                    type="button"
                    class="json-toggle"
                    id="export-matches-csv-btn"
                    style="margin: 0; background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #4ade80;"
                    onclick="exportMatches('csv', ${reconId})"
                    title="Export matches to CSV"
                  >
                    <i class="fas fa-file-csv"></i>
                    <span>CSV</span>
                  </button>
                  <button
                    type="button"
                    class="json-toggle"
                    id="export-matches-excel-btn"
                    style="margin: 0; background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #4ade80;"
                    onclick="exportMatches('xlsx', ${reconId})"
                    title="Export matches to Excel"
                  >
                    <i class="fas fa-file-excel"></i>
                    <span>Excel</span>
                  </button>
                  <button
                    type="button"
                    class="json-toggle"
                    id="export-matches-pdf-btn"
                    style="margin: 0; background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.4); color: #f87171;"
                    onclick="exportMatches('pdf', ${reconId})"
                    title="Export matches to PDF"
                  >
                    <i class="fas fa-file-pdf"></i>
                    <span>PDF</span>
                  </button>
                </div>
              </div>
              ${matchesTableHTML}
            </div>
          ` : ''}
          
          ${onlyInv.length > 0 ? `
            <div class="results-section">
              <div class="results-section-title">
                <i class="fas fa-exclamation-triangle"></i>
                Unmatched Invoices (${onlyInv.length})
              </div>
              <div style="margin-bottom: 15px; font-size: 0.9rem; color: #475569; padding: 12px; background: rgba(37, 99, 235, 0.1); border-radius: 8px; border-left: 4px solid #2563eb;">
                <i class="fas fa-info-circle" style="margin-right: 6px; color: #2563eb;"></i>
                <strong style="color: #2563eb;">Manual Matching Options:</strong><br>
                â€¢ <strong>Match Existing:</strong> Match with existing unmatched bank transactions<br>
                â€¢ <strong>Upload Bank Doc:</strong> Upload a bank statement document to extract and match transactions
              </div>
              ${unmatchedInvHTML}
            </div>
          ` : ''}
          
          ${onlyBank.length > 0 ? `
            <div class="results-section">
              <div class="results-section-title">
                <i class="fas fa-exclamation-triangle"></i>
                Unmatched Bank Transactions (${onlyBank.length})
              </div>
              <div style="margin-bottom: 15px; font-size: 0.9rem; color: #475569; padding: 12px; background: rgba(37, 99, 235, 0.1); border-radius: 8px; border-left: 4px solid #2563eb;">
                <i class="fas fa-info-circle" style="margin-right: 6px; color: #2563eb;"></i>
                <strong style="color: #2563eb;">Manual Matching Options:</strong><br>
                â€¢ <strong>Match Existing:</strong> Match with existing unmatched invoices<br>
                â€¢ <strong>Upload Invoice Doc:</strong> Upload an invoice document to extract and match transactions
              </div>
              ${unmatchedBankHTML}
            </div>
          ` : ''}
          
          ${matches.length === 0 && onlyInv.length === 0 && onlyBank.length === 0 ? `
            <div class="empty-state">
              <i class="fas fa-info-circle"></i>
              <div>No transactions found. Please check your uploaded files.</div>
            </div>
          ` : ''}
        `;
      }
      
      // JSON toggle functionality
      function initJsonToggle() {
        const jsonToggle = document.getElementById('json-toggle');
        const jsonContainer = document.getElementById('json-container');
        
        if (jsonToggle && jsonContainer) {
          jsonToggle.addEventListener('click', () => {
            const isShowing = jsonContainer.classList.contains('show');
            if (isShowing) {
              jsonContainer.classList.remove('show');
              jsonToggle.querySelector('span').textContent = 'Show JSON';
              jsonToggle.querySelector('i').className = 'fas fa-chevron-down';
            } else {
              jsonContainer.classList.add('show');
              jsonToggle.querySelector('span').textContent = 'Hide JSON';
              jsonToggle.querySelector('i').className = 'fas fa-chevron-up';
            }
          });
        }
      }
      
      // Initialize JSON toggle when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initJsonToggle);
      } else {
        initJsonToggle();
      }
      
      // Global variables for manual matching
      let currentReconciliationData = null;
      let selectedInvoiceIndex = null;
      let selectedBankIndex = null;
      
      // Export matches to CSV, Excel, or PDF
      async function exportMatches(format, reconciliationId) {
        const formatNames = {
          'csv': 'CSV',
          'xlsx': 'Excel',
          'pdf': 'PDF'
        };
        const formatIcons = {
          'csv': 'fa-file-csv',
          'xlsx': 'fa-file-excel',
          'pdf': 'fa-file-pdf'
        };
        const formatColors = {
          'csv': { bg: 'rgba(34, 197, 94, 0.2)', border: 'rgba(34, 197, 94, 0.4)', text: '#4ade80' },
          'xlsx': { bg: 'rgba(34, 197, 94, 0.2)', border: 'rgba(34, 197, 94, 0.4)', text: '#4ade80' },
          'pdf': { bg: 'rgba(239, 68, 68, 0.2)', border: 'rgba(239, 68, 68, 0.4)', text: '#f87171' }
        };
        
        try {
          const btn = document.getElementById(`export-matches-${format}-btn`);
          if (btn) {
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i><span> Exporting...</span>`;
          }
          
          const response = await fetch(`/api/reconciliations/${reconciliationId}/matches/export?format=${format}`);
          
          if (!response.ok) {
            const error = await response.json();
            alert(`Error exporting ${formatNames[format]}: ${error.error || 'Unknown error'}`);
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = `<i class="fas ${formatIcons[format]}"></i><span> ${formatNames[format]}</span>`;
            }
            return;
          }
          
          // Download the file
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const extension = format === 'xlsx' ? 'xlsx' : format;
          a.download = `reconciliation_${reconciliationId}_matches.${extension}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          
          // Show success message
          const statusEl = document.getElementById("status");
          if (statusEl) {
            statusEl.textContent = `âœ“ Successfully exported to ${formatNames[format]}!`;
            statusEl.className = "status success show";
            setTimeout(() => {
              statusEl.className = "status success";
            }, 3000);
          }
          
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas ${formatIcons[format]}"></i><span> ${formatNames[format]}</span>`;
          }
        } catch (error) {
          console.error(`Error exporting ${formatNames[format]}:`, error);
          alert(`Error exporting ${formatNames[format]}. Please try again.`);
          const btn = document.getElementById(`export-matches-${format}-btn`);
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas ${formatIcons[format]}"></i><span> ${formatNames[format]}</span>`;
          }
        }
      }
      
      // Keep old function for backward compatibility
      async function exportMatchesToCSV(reconciliationId) {
        return exportMatches('csv', reconciliationId);
      }
      
      // Manual matching functionality
      function selectForManualMatch(type, index, event) {
        event.stopPropagation();
        
        if (!currentReconciliationData) {
          alert('No reconciliation data available. Please run a reconciliation first.');
          return;
        }
        
        const recon = currentReconciliationData.reconciliation || {};
        const onlyInv = recon.only_in_invoices || [];
        const onlyBank = recon.only_in_bank || [];
        
        if (type === 'invoice') {
          selectedInvoiceIndex = index;
          const invoice = onlyInv[index];
          
          // Show bank transactions for selection
          showBankSelectionModal(invoice, onlyBank);
        } else if (type === 'bank') {
          selectedBankIndex = index;
          const bank = onlyBank[index];
          
          // Show invoices for selection
          showInvoiceSelectionModal(bank, onlyInv);
        }
      }
      
      // Upload document to match functionality
      function uploadDocumentToMatch(type, index, event) {
        event.stopPropagation();
        event.preventDefault();
        
        console.log('uploadDocumentToMatch called', type, index);
        
        if (!currentReconciliationData) {
          alert('No reconciliation data available. Please run a reconciliation first.');
          return;
        }
        
        const recon = currentReconciliationData.reconciliation || {};
        const onlyInv = recon.only_in_invoices || [];
        const onlyBank = recon.only_in_bank || [];
        
        const documentType = type === 'invoice' ? 'bank' : 'invoice'; // Opposite type
        const unmatchedItem = type === 'invoice' ? onlyInv[index] : onlyBank[index];
        
        if (!unmatchedItem) {
          alert('Selected item not found. Please try again.');
          return;
        }
        
        console.log('Showing upload modal for:', documentType, unmatchedItem);
        showDocumentUploadModal(type, index, unmatchedItem, documentType);
      }
      
      function showDocumentUploadModal(unmatchedType, unmatchedIndex, unmatchedItem, documentType) {
        const modal = document.createElement('div');
        modal.id = 'document-upload-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 10001;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: #ffffff;
          border-radius: 20px;
          padding: 30px;
          max-width: 900px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          border: 1px solid rgba(37, 99, 235, 0.3);
          box-shadow: 0 20px 60px rgba(37, 99, 235, 0.2);
        `;
        
        const documentTypeLabel = documentType === 'invoice' ? 'Invoice' : 'Bank Statement';
        const unmatchedTypeLabel = unmatchedType === 'invoice' ? 'Invoice' : 'Bank Transaction';
        
        modalContent.innerHTML = `
          <h2 style="color: #2563eb; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <span><i class="fas fa-upload"></i> Upload ${documentTypeLabel} Document to Match</span>
            <button onclick="closeDocumentUploadModal()" style="background: transparent; border: none; color: #1e3a5f; font-size: 1.5rem; cursor: pointer;">Ã—</button>
          </h2>
          <div style="background: rgba(37, 99, 235, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2563eb;">
            <div style="font-weight: 600; color: #2563eb; margin-bottom: 8px;">Unmatched ${unmatchedTypeLabel}:</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Description:</strong> ${unmatchedItem.description || 'N/A'}</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Amount:</strong> ${formatCurrency(unmatchedItem.amount || 0)}</div>
            <div style="color: #1e3a5f;"><strong>Date:</strong> ${formatDate(unmatchedItem.date)}</div>
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #1e40af; font-weight: 600; margin-bottom: 10px;">
              <i class="fas fa-file-upload"></i> Select ${documentTypeLabel} Document (PDF, Excel, CSV, Image):
            </label>
            <div id="file-upload-area" style="position: relative; border: 2px dashed rgba(37, 99, 235, 0.5); border-radius: 8px; padding: 20px; background: rgba(37, 99, 235, 0.05); transition: all 0.3s ease; cursor: pointer;" onclick="document.getElementById('document-upload-input').click();">
            <input 
              type="file" 
              id="document-upload-input" 
              accept="${documentType === 'invoice' ? 'application/pdf,image/*,.xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel' : 'application/pdf,image/*,.xlsx,.xls,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel'}"
                style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; z-index: 1;"
              />
              <div style="text-align: center; pointer-events: none;">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #2563eb; margin-bottom: 10px; opacity: 0.7;"></i>
                <div style="color: #1e40af; font-weight: 600; margin-bottom: 5px;">Click to Upload or Drag & Drop</div>
                <div style="color: #64748b; font-size: 0.85rem;">PDF, Excel, CSV, or Image files</div>
              </div>
              <div id="selected-file-name" style="margin-top: 12px; padding: 10px; background: rgba(37, 99, 235, 0.15); border-radius: 6px; color: #2563eb; font-size: 0.9rem; display: none; text-align: center; border: 1px solid rgba(37, 99, 235, 0.3);">
                <i class="fas fa-file-check"></i> <span id="file-name-text"></span>
            </div>
            </div>
            <div style="margin-top: 10px; font-size: 0.85rem; color: #64748b; padding: 8px; background: rgba(37, 99, 235, 0.05); border-radius: 6px;">
              <i class="fas fa-info-circle"></i> Supported formats: PDF, Excel (.xlsx, .xls), ${documentType === 'bank' ? 'CSV, ' : ''}Images (PNG, JPG, etc.)
            </div>
          </div>
          <button 
            type="button" 
            id="process-document-btn"
            class="submit-btn" 
            style="width: 100%; padding: 14px; font-size: 1rem;"
            onclick="processUploadedDocument('${unmatchedType}', ${unmatchedIndex}, '${documentType}')"
          >
            <i class="fas fa-cog"></i> Process Document & Extract Transactions
          </button>
          <div id="document-processing-status" style="margin-top: 15px; display: none;"></div>
          <div id="extracted-transactions-container" style="margin-top: 20px; display: none;">
            <h3 style="color: #2563eb; margin-bottom: 15px;">Extracted Transactions:</h3>
            <div id="extracted-transactions-list"></div>
          </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Add event listeners for file input (after modal is added to DOM)
        setTimeout(() => {
          const fileInput = document.getElementById('document-upload-input');
          const fileNameDiv = document.getElementById('selected-file-name');
          const fileNameText = document.getElementById('file-name-text');
          const fileUploadArea = document.getElementById('file-upload-area');
          
          if (!fileInput) {
            console.error('File input element not found in modal!');
            return;
          }
          
            // Show selected file name
            fileInput.addEventListener('change', function(e) {
              if (e.target.files && e.target.files.length > 0) {
              const file = e.target.files[0];
              const fileName = file.name;
              const fileSize = (file.size / 1024 / 1024).toFixed(2);
              if (fileNameText) {
                fileNameText.textContent = fileName + ' (' + fileSize + ' MB)';
              }
              if (fileNameDiv) {
                fileNameDiv.style.display = 'block';
              }
                if (fileUploadArea) {
                  fileUploadArea.style.borderColor = 'rgba(34, 197, 94, 0.6)';
                  fileUploadArea.style.background = 'rgba(34, 197, 94, 0.1)';
                fileUploadArea.style.borderStyle = 'solid';
                }
              console.log('File selected:', fileName, fileSize, 'MB');
              } else {
                if (fileNameDiv) fileNameDiv.style.display = 'none';
                if (fileUploadArea) {
                  fileUploadArea.style.borderColor = 'rgba(37, 99, 235, 0.5)';
                fileUploadArea.style.background = 'rgba(37, 99, 235, 0.05)';
                fileUploadArea.style.borderStyle = 'dashed';
                }
              }
            });
            
            // Drag and drop functionality
            if (fileUploadArea) {
              fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.style.borderColor = 'rgba(37, 99, 235, 0.8)';
                fileUploadArea.style.background = 'rgba(37, 99, 235, 0.15)';
              fileUploadArea.style.borderStyle = 'solid';
              });
              
              fileUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!fileInput.files || fileInput.files.length === 0) {
                  fileUploadArea.style.borderColor = 'rgba(37, 99, 235, 0.5)';
                fileUploadArea.style.background = 'rgba(37, 99, 235, 0.05)';
                fileUploadArea.style.borderStyle = 'dashed';
                }
              });
              
              fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                // Create a new FileList-like object
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(e.dataTransfer.files[0]);
                fileInput.files = dataTransfer.files;
                  fileInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
              });
            }
            
            console.log('File input element ready for upload');
        }, 100);
      }
      
      async function processUploadedDocument(unmatchedType, unmatchedIndex, documentType) {
        const fileInput = document.getElementById('document-upload-input');
        const processBtn = document.getElementById('process-document-btn');
        const statusDiv = document.getElementById('document-processing-status');
        const containerDiv = document.getElementById('extracted-transactions-container');
        const transactionsListDiv = document.getElementById('extracted-transactions-list');
        
        if (!fileInput.files || !fileInput.files[0]) {
          alert('Please select a file first.');
          return;
        }
        
        const file = fileInput.files[0];
        
        // Show processing status
        processBtn.disabled = true;
        processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<div style="color: #60a5fa; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #3b82f6;"><i class="fas fa-spinner fa-spin"></i> Processing document and extracting transactions...</div>';
        containerDiv.style.display = 'none';
        
        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('document_type', documentType);
          
          const response = await fetch('/api/process-document', {
            method: 'POST',
            body: formData
          });
          
          let result;
          try {
            result = await response.json();
          } catch (jsonErr) {
            console.error("Failed to parse JSON response:", jsonErr);
            const text = await response.text();
            console.error("Response text:", text);
            statusDiv.innerHTML = `<div style="color: #f87171; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;"><i class="fas fa-exclamation-circle"></i> Error: Server returned invalid response (${response.status}). Check console for details.</div>`;
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="fas fa-cog"></i> Process Document & Extract Transactions';
            return;
          }
          
          if (!response.ok) {
            statusDiv.innerHTML = `<div style="color: #f87171; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;"><i class="fas fa-exclamation-circle"></i> Error: ${result.error || 'Unknown error'}</div>`;
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="fas fa-cog"></i> Process Document & Extract Transactions';
            return;
          }
          
          // Show success and display extracted transactions
          statusDiv.innerHTML = `<div style="color: #4ade80; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 4px solid #22c55e;"><i class="fas fa-check-circle"></i> Successfully extracted ${result.transaction_count} transaction(s) from ${result.file_name}</div>`;
          
          // Display extracted transactions
          if (result.transactions && result.transactions.length > 0) {
            const unmatchedItem = unmatchedType === 'invoice' 
              ? currentReconciliationData.reconciliation.only_in_invoices[unmatchedIndex]
              : currentReconciliationData.reconciliation.only_in_bank[unmatchedIndex];
            
            // Try to auto-match based on amount similarity
            const unmatchedAmount = Math.abs(unmatchedItem.amount || 0);
            let bestMatch = null;
            let bestMatchIndex = -1;
            let bestMatchScore = 0;
            
            result.transactions.forEach((tx, idx) => {
              const txAmount = Math.abs(tx.amount || 0);
              const amountDiff = Math.abs(unmatchedAmount - txAmount);
              const matchScore = unmatchedAmount > 0 ? 1 - (amountDiff / unmatchedAmount) : 0;
              
              // If amounts are very close (within 1% or â‚¹1), consider it a match
              if (amountDiff < Math.max(1, unmatchedAmount * 0.01) && matchScore > bestMatchScore) {
                bestMatch = tx;
                bestMatchIndex = idx;
                bestMatchScore = matchScore;
              }
            });
            
            // Auto-match if found, otherwise show list for manual selection
            if (bestMatch && bestMatchScore > 0.99) {
              // Automatically match without confirmation
              statusDiv.innerHTML = `<div style="color: #4ade80; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 4px solid #22c55e;"><i class="fas fa-spinner fa-spin"></i> Auto-match found! Matching transactions automatically...</div>`;
              
              // Automatically create the match
              const unmatchedData = encodeURIComponent(JSON.stringify(unmatchedItem));
              const bestMatchData = encodeURIComponent(JSON.stringify(bestMatch));
              
              // Call match function directly without confirmation
              try {
                await autoMatchWithUploadedTransaction(unmatchedType, unmatchedIndex, bestMatchIndex, unmatchedData, bestMatchData);
                // Function will close modal and refresh, so we don't need to do anything else
                return;
              } catch (error) {
                console.error('Error in auto-match:', error);
                statusDiv.innerHTML = `<div style="color: #f87171; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;"><i class="fas fa-exclamation-circle"></i> Error during auto-match. Please try manual matching below.</div>`;
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-cog"></i> Process Document & Extract Transactions';
                // Continue to show the list below
              }
            }
            
            transactionsListDiv.innerHTML = `
              ${bestMatch ? `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(34, 197, 94, 0.15); border-radius: 10px; border-left: 4px solid #22c55e;">
                  <div style="color: #4ade80; font-weight: 600; margin-bottom: 10px;">
                    <i class="fas fa-magic"></i> Potential Match Found!
                  </div>
                  <div style="color: #1e3a5f; margin-bottom: 12px;">
                    System found a potential match. Click below to confirm or select another transaction:
                  </div>
                  <button 
                    type="button" 
                    class="submit-btn" 
                    style="width: 100%; padding: 12px; font-size: 0.95rem;"
                    onclick="matchWithUploadedTransactionHandler(document.querySelector('[data-tx-index=\"${bestMatchIndex}\"]'))"
                    data-unmatched-type="${unmatchedType}"
                    data-unmatched-index="${unmatchedIndex}"
                    data-tx-index="${bestMatchIndex}"
                    data-unmatched-data="${encodeURIComponent(JSON.stringify(unmatchedItem))}"
                    data-tx-data="${encodeURIComponent(JSON.stringify(bestMatch))}"
                  >
                    <i class="fas fa-check-circle"></i> Confirm Match (Amount: ${formatCurrency(bestMatch.amount)})
                  </button>
                </div>
              ` : `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(37, 99, 235, 0.15); border-radius: 10px; border-left: 4px solid #2563eb;">
                  <div style="color: #2563eb; font-weight: 600; margin-bottom: 10px;">
                    <i class="fas fa-info-circle"></i> No Auto-Match Found
                  </div>
                  <div style="color: #1e3a5f; margin-bottom: 12px;">
                    No automatic match was found. Please manually select a transaction from the list below to match, or close this window to keep it unmatched.
                  </div>
                </div>
              `}
              <div style="margin-bottom: 10px; color: #1e40af; font-weight: 600;">
                All Extracted Transactions (${result.transactions.length}):
              </div>
              <table class="unmatched-table" style="width: 100%;">
                <thead>
                  <tr>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.transactions.map((tx, idx) => {
                    // Store transaction data in data attributes to avoid JSON escaping issues
                    const txData = encodeURIComponent(JSON.stringify(tx));
                    const unmatchedData = encodeURIComponent(JSON.stringify(unmatchedItem));
                    const isBestMatch = idx === bestMatchIndex;
                    return `
                    <tr ${isBestMatch ? 'style="background: rgba(34, 197, 94, 0.1);"' : ''}>
                      <td class="description-cell" title="${(tx.description || '').replace(/"/g, '&quot;')}">${truncateText(tx.description, 50)}${isBestMatch ? ' <span style="color: #4ade80; font-size: 0.8rem;">(Auto-Match)</span>' : ''}</td>
                      <td class="amount-cell">${formatCurrency(tx.amount || 0)}</td>
                      <td>${formatDate(tx.date)}</td>
                      <td>
                        <button 
                          type="button" 
                          class="json-toggle" 
                          style="padding: 6px 12px; font-size: 0.8rem; background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #4ade80;"
                          data-unmatched-type="${unmatchedType}"
                          data-unmatched-index="${unmatchedIndex}"
                          data-tx-index="${idx}"
                          data-unmatched-data="${unmatchedData}"
                          data-tx-data="${txData}"
                          onclick="matchWithUploadedTransactionHandler(this)"
                        >
                          <i class="fas fa-check"></i> Match This
                        </button>
                      </td>
                    </tr>
                  `;
                  }).join('')}
                </tbody>
              </table>
            `;
            containerDiv.style.display = 'block';
          } else {
            transactionsListDiv.innerHTML = '<div style="text-align: center; padding: 30px; color: #64748b;"><i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i><div>No transactions found in the uploaded document.</div><div style="font-size: 0.85rem; margin-top: 10px;">Please check the file format and try again.</div></div>';
            containerDiv.style.display = 'block';
          }
          
          processBtn.disabled = false;
          processBtn.innerHTML = '<i class="fas fa-check"></i> Document Processed';
          
        } catch (error) {
          console.error('Error processing document:', error);
          statusDiv.innerHTML = `<div style="color: #f87171; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;"><i class="fas fa-exclamation-circle"></i> Error processing document. Please try again.</div>`;
          processBtn.disabled = false;
          processBtn.innerHTML = '<i class="fas fa-cog"></i> Process Document & Extract Transactions';
        }
      }
      
      function matchWithUploadedTransactionHandler(button) {
        const unmatchedType = button.getAttribute('data-unmatched-type');
        const unmatchedIndex = parseInt(button.getAttribute('data-unmatched-index'));
        const uploadedTxIndex = parseInt(button.getAttribute('data-tx-index'));
        const unmatchedItemJson = decodeURIComponent(button.getAttribute('data-unmatched-data'));
        const uploadedTxJson = decodeURIComponent(button.getAttribute('data-tx-data'));
        
        matchWithUploadedTransaction(unmatchedType, unmatchedIndex, uploadedTxIndex, unmatchedItemJson, uploadedTxJson);
      }
      
      async function autoMatchWithUploadedTransaction(unmatchedType, unmatchedIndex, uploadedTxIndex, unmatchedItemJson, uploadedTxJson) {
        try {
          const unmatchedItem = JSON.parse(unmatchedItemJson);
          const uploadedTx = JSON.parse(uploadedTxJson);
          const recon = currentReconciliationData.reconciliation || {};
          const reconciliationId = recon.reconciliation_id;
          
          if (!reconciliationId) {
            alert('Reconciliation ID not found.');
            return;
          }
          
          // Prepare data for matching
          let invoiceData, bankData;
          if (unmatchedType === 'invoice') {
            invoiceData = unmatchedItem;
            bankData = uploadedTx;
          } else {
            invoiceData = uploadedTx;
            bankData = unmatchedItem;
          }
          
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Auto-matching transactions...";
          statusEl.className = "status processing show";
          
          // Create manual match automatically
          const requestBody = {
            invoice: invoiceData,
            bank: bankData
          };
          console.log('Sending manual match request:', {
            reconciliationId,
            invoiceData,
            bankData
          });
          const response = await fetch(`/api/reconciliations/${reconciliationId}/manual-match`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
          });
          
          let result;
          try {
            result = await response.json();
          } catch (jsonErr) {
            console.error("Failed to parse JSON response:", jsonErr);
            const text = await response.text();
            console.error("Response text:", text);
            statusEl.textContent = `Error: Server returned invalid response (${response.status})`;
            statusEl.className = "status error show";
            alert(`Error creating auto-match: Server returned status ${response.status}. Check console for details.`);
            return;
          }
          
          if (!response.ok) {
            const errorMsg = result.error || 'Unknown error';
            const errorDetails = result.errors ? `\n\nValidation errors:\n${result.errors.join('\n')}` : '';
            const warningsDetails = result.warnings ? `\n\nWarnings:\n${result.warnings.join('\n')}` : '';
            console.error('Manual match error:', result);
            statusEl.textContent = `Error: ${errorMsg}`;
            statusEl.className = "status error show";
            alert(`Error creating auto-match: ${errorMsg}${errorDetails}${warningsDetails}`);
            return;
          }
          
          statusEl.textContent = "âœ“ Auto-match created successfully! Refreshing reconciliation...";
          statusEl.className = "status success show";
          
          closeDocumentUploadModal();
          
          // Reload reconciliation
          await refreshReconciliation(reconciliationId);
          
        } catch (error) {
          console.error('Error auto-matching with uploaded transaction:', error);
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Error creating auto-match. Please try again.";
          statusEl.className = "status error show";
          alert('Error creating auto-match. Please try again.');
        }
      }
      
      async function matchWithUploadedTransaction(unmatchedType, unmatchedIndex, uploadedTxIndex, unmatchedItemJson, uploadedTxJson) {
        try {
          const unmatchedItem = JSON.parse(unmatchedItemJson);
          const uploadedTx = JSON.parse(uploadedTxJson);
          const recon = currentReconciliationData.reconciliation || {};
          const reconciliationId = recon.reconciliation_id;
          
          if (!reconciliationId) {
            alert('Reconciliation ID not found.');
            return;
          }
          
          // Prepare data for matching
          let invoiceData, bankData;
          if (unmatchedType === 'invoice') {
            invoiceData = unmatchedItem;
            bankData = uploadedTx;
          } else {
            invoiceData = uploadedTx;
            bankData = unmatchedItem;
          }
          
          // Confirm match
          if (!confirm(`Match this ${unmatchedType === 'invoice' ? 'invoice' : 'bank transaction'} with the uploaded ${unmatchedType === 'invoice' ? 'bank' : 'invoice'} transaction?\n\n${unmatchedType === 'invoice' ? 'Invoice' : 'Bank'}: ${unmatchedItem.description}\nAmount: ${formatCurrency(unmatchedItem.amount)}\n\n${unmatchedType === 'invoice' ? 'Bank' : 'Invoice'} (from uploaded doc): ${uploadedTx.description}\nAmount: ${formatCurrency(uploadedTx.amount)}`)) {
            return;
          }
          
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Creating manual match...";
          statusEl.className = "status processing show";
          
          // Create manual match
          const requestBody = {
            invoice: invoiceData,
            bank: bankData
          };
          console.log('Sending manual match request:', {
            reconciliationId,
            invoiceData,
            bankData
          });
          const response = await fetch(`/api/reconciliations/${reconciliationId}/manual-match`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
          });
          
          let result;
          try {
            result = await response.json();
          } catch (jsonErr) {
            console.error("Failed to parse JSON response:", jsonErr);
            const text = await response.text();
            console.error("Response text:", text);
            statusEl.textContent = `Error: Server returned invalid response (${response.status})`;
            statusEl.className = "status error show";
            alert(`Error creating manual match: Server returned status ${response.status}. Check console for details.`);
            return;
          }
          
          if (!response.ok) {
            const errorMsg = result.error || 'Unknown error';
            const errorDetails = result.errors ? `\n\nValidation errors:\n${result.errors.join('\n')}` : '';
            const warningsDetails = result.warnings ? `\n\nWarnings:\n${result.warnings.join('\n')}` : '';
            console.error('Manual match error:', result);
            statusEl.textContent = `Error: ${errorMsg}`;
            statusEl.className = "status error show";
            alert(`Error creating manual match: ${errorMsg}${errorDetails}${warningsDetails}`);
            return;
          }
          
          statusEl.textContent = "âœ“ Manual match created successfully! Refreshing reconciliation...";
          statusEl.className = "status success show";
          
          closeDocumentUploadModal();
          
          // Reload reconciliation
          await refreshReconciliation(reconciliationId);
          
        } catch (error) {
          console.error('Error matching with uploaded transaction:', error);
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Error creating manual match. Please try again.";
          statusEl.className = "status error show";
          alert('Error creating manual match. Please try again.');
        }
      }
      
      function closeDocumentUploadModal() {
        const modal = document.getElementById('document-upload-modal');
        if (modal) {
          modal.remove();
        }
      }
      
      // View invoice image function
      function viewInvoiceImage(filePath, invoiceNumber) {
        if (!filePath) {
          alert('Invoice image not available');
          return;
        }
        
        // Create modal to show invoice image
        const modal = document.createElement('div');
        modal.id = 'invoice-image-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.9);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
        `;
        
        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 8px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            position: relative;
          ">
            <div style="
              padding: 20px;
              border-bottom: 1px solid #e5e7eb;
              display: flex;
              justify-content: space-between;
              align-items: center;
            ">
              <h3 style="margin: 0; color: #1f2937;">Invoice #${invoiceNumber}</h3>
              <button 
                onclick="closeInvoiceImageModal()"
                style="
                  background: none;
                  border: none;
                  font-size: 24px;
                  cursor: pointer;
                  color: #6b7280;
                "
              >
                Ã—
              </button>
            </div>
            <div style="padding: 20px; text-align: center;">
              <img 
                src="/uploads/${filePath.split('/').pop()}" 
                alt="Invoice ${invoiceNumber}"
                style="
                  max-width: 100%;
                  max-height: 70vh;
                  object-fit: contain;
                  border: 1px solid #e5e7eb;
                  border-radius: 4px;
                "
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
              />
              <div style="display: none; color: #ef4444; padding: 20px;">
                Failed to load invoice image. The file may not exist or may be corrupted.
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }
      
      function closeInvoiceImageModal() {
        const modal = document.getElementById('invoice-image-modal');
        if (modal) {
          modal.remove();
        }
      }
      
      // Close modal when clicking outside
      document.addEventListener('click', function(event) {
        const modal = document.getElementById('invoice-image-modal');
        if (modal && event.target === modal) {
          closeInvoiceImageModal();
        }
      });
      
      // Close modal when clicking outside (only if clicking on backdrop, not on modal content)
      document.addEventListener('click', function(event) {
        const modal = document.getElementById('document-upload-modal');
        if (modal && event.target === modal) {
          closeDocumentUploadModal();
        }
      });
      
      // Make functions globally accessible for onclick handlers
      window.uploadDocumentToMatch = uploadDocumentToMatch;
      window.processUploadedDocument = processUploadedDocument;
      window.closeDocumentUploadModal = closeDocumentUploadModal;
      window.matchWithUploadedTransactionHandler = matchWithUploadedTransactionHandler;
      window.autoMatchWithUploadedTransaction = autoMatchWithUploadedTransaction;
      window.viewInvoiceImage = viewInvoiceImage;
      window.closeInvoiceImageModal = closeInvoiceImageModal;
      window.deleteMatch = deleteMatch;
      
      function showBankSelectionModal(invoice, bankTransactions) {
        const modal = document.createElement('div');
        modal.id = 'manual-match-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: #ffffff;
          border-radius: 20px;
          padding: 30px;
          max-width: 900px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          border: 1px solid rgba(37, 99, 235, 0.3);
          box-shadow: 0 20px 60px rgba(37, 99, 235, 0.2);
        `;
        
        modalContent.innerHTML = `
          <h2 style="color: #2563eb; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <span><i class="fas fa-link"></i> Select Bank Transaction to Match</span>
            <button onclick="closeManualMatchModal()" style="background: transparent; border: none; color: #1e3a5f; font-size: 1.5rem; cursor: pointer;">Ã—</button>
          </h2>
          <div style="background: rgba(37, 99, 235, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2563eb;">
            <div style="font-weight: 600; color: #2563eb; margin-bottom: 8px;">Selected Invoice:</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Description:</strong> ${invoice.description || 'N/A'}</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Amount:</strong> ${formatCurrency(invoice.amount || 0)}</div>
            <div style="color: #1e3a5f;"><strong>Date:</strong> ${formatDate(invoice.date)}</div>
          </div>
          <div style="max-height: 400px; overflow-y: auto;">
            <table class="unmatched-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${bankTransactions.map((bank, idx) => `
                  <tr>
                    <td class="description-cell" title="${(bank.description || '').replace(/"/g, '&quot;')}">${truncateText(bank.description, 50)}</td>
                    <td class="amount-cell">${formatCurrency(bank.amount || 0)}</td>
                    <td>${formatDate(bank.date)}</td>
                    <td>
                      <button 
                        type="button" 
                        class="json-toggle" 
                        style="padding: 6px 12px; font-size: 0.8rem;"
                        onclick="confirmManualMatch(${selectedInvoiceIndex}, ${idx})"
                      >
                        <i class="fas fa-check"></i> Select
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
      }
      
      function showInvoiceSelectionModal(bank, invoices) {
        const modal = document.createElement('div');
        modal.id = 'manual-match-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: #ffffff;
          border-radius: 20px;
          padding: 30px;
          max-width: 900px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          border: 1px solid rgba(37, 99, 235, 0.3);
          box-shadow: 0 20px 60px rgba(37, 99, 235, 0.2);
        `;
        
        modalContent.innerHTML = `
          <h2 style="color: #2563eb; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <span><i class="fas fa-link"></i> Select Invoice to Match</span>
            <button onclick="closeManualMatchModal()" style="background: transparent; border: none; color: #1e3a5f; font-size: 1.5rem; cursor: pointer;">Ã—</button>
          </h2>
          <div style="background: rgba(37, 99, 235, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2563eb;">
            <div style="font-weight: 600; color: #2563eb; margin-bottom: 8px;">Selected Bank Transaction:</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Description:</strong> ${bank.description || 'N/A'}</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Amount:</strong> ${formatCurrency(bank.amount || 0)}</div>
            <div style="color: #1e3a5f;"><strong>Date:</strong> ${formatDate(bank.date)}</div>
          </div>
          <div style="max-height: 400px; overflow-y: auto;">
            <table class="unmatched-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${invoices.map((inv, idx) => `
                  <tr>
                    <td class="description-cell" title="${(inv.description || '').replace(/"/g, '&quot;')}">${truncateText(inv.description, 50)}</td>
                    <td class="amount-cell">${formatCurrency(inv.amount || 0)}</td>
                    <td>${formatDate(inv.date)}</td>
                    <td>
                      <button 
                        type="button" 
                        class="json-toggle" 
                        style="padding: 6px 12px; font-size: 0.8rem;"
                        onclick="confirmManualMatch(${idx}, ${selectedBankIndex})"
                      >
                        <i class="fas fa-check"></i> Select
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
      }
      
      async function confirmManualMatch(invoiceIndex, bankIndex) {
        if (!currentReconciliationData) {
          alert('No reconciliation data available.');
          return;
        }
        
        const recon = currentReconciliationData.reconciliation || {};
        const onlyInv = recon.only_in_invoices || [];
        const onlyBank = recon.only_in_bank || [];
        const reconciliationId = recon.reconciliation_id;
        
        if (!reconciliationId) {
          alert('Reconciliation ID not found.');
          return;
        }
        
        const invoice = onlyInv[invoiceIndex];
        const bank = onlyBank[bankIndex];
        
        if (!invoice || !bank) {
          alert('Invalid selection.');
          return;
        }
        
        // Confirm with user
        if (!confirm(`Match this invoice with this bank transaction?\n\nInvoice: ${invoice.description}\nAmount: ${formatCurrency(invoice.amount)}\n\nBank: ${bank.description}\nAmount: ${formatCurrency(bank.amount)}`)) {
          return;
        }
        
        try {
          // Show loading state
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Creating manual match...";
          statusEl.className = "status processing show";
          
          const requestBody = {
            invoice_index: invoiceIndex,
            bank_index: bankIndex,
            invoice: invoice,
            bank: bank
          };
          console.log('Sending manual match request:', {
            reconciliationId,
            invoiceIndex,
            bankIndex,
            invoice,
            bank
          });
          const response = await fetch(`/api/reconciliations/${reconciliationId}/manual-match`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
          });
          
          let result;
          try {
            result = await response.json();
          } catch (jsonErr) {
            console.error("Failed to parse JSON response:", jsonErr);
            const text = await response.text();
            console.error("Response text:", text);
            statusEl.textContent = `Error: Server returned invalid response (${response.status})`;
            statusEl.className = "status error show";
            alert(`Error creating manual match: Server returned status ${response.status}. Check console for details.`);
            return;
          }
          
          if (!response.ok) {
            const errorMsg = result.error || 'Unknown error';
            const errorDetails = result.errors ? `\n\nValidation errors:\n${result.errors.join('\n')}` : '';
            const warningsDetails = result.warnings ? `\n\nWarnings:\n${result.warnings.join('\n')}` : '';
            console.error('Manual match error:', result);
            statusEl.textContent = `Error: ${errorMsg}`;
            statusEl.className = "status error show";
            alert(`Error creating manual match: ${errorMsg}${errorDetails}${warningsDetails}`);
            return;
          }
          
          statusEl.textContent = "âœ“ Manual match created successfully! Refreshing reconciliation...";
          statusEl.className = "status success show";
          closeManualMatchModal();
          
          // Reload reconciliation to get updated data from server
          await refreshReconciliation(reconciliationId);
          
        } catch (error) {
          console.error('Error creating manual match:', error);
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Error creating manual match. Please try again.";
          statusEl.className = "status error show";
          alert('Error creating manual match. Please try again.');
        }
      }
      
      // Function to refresh reconciliation data from server
      async function refreshReconciliation(reconciliationId) {
        try {
          // Fetch updated matches
          const matchesResponse = await fetch(`/api/reconciliations/${reconciliationId}/matches`);
          const matchesData = await matchesResponse.json();
          
          if (!matchesResponse.ok) {
            console.error('Error fetching updated matches:', matchesData);
            return;
          }
          
          // Reconstruct reconciliation data structure
          if (currentReconciliationData && currentReconciliationData.reconciliation) {
            // Update matches with IDs from server
            const updatedMatches = matchesData.matches.map(match => ({
              invoice: {
                description: match.invoice_description,
                amount: match.invoice_amount,
                date: match.invoice_date,
                vendor_name: match.invoice_vendor_name,
                invoice_number: (match.invoice_number || match.invoice_invoice_number || '')
              },
              bank: {
                description: match.bank_description,
                amount: match.bank_amount,
                date: match.bank_date,
                vendor_name: match.bank_vendor_name,
                invoice_number: match.bank_invoice_number
              },
              match_score: match.match_score,
              is_manual_match: match.is_manual_match,
              match_id: match.id,
              id: match.id,
              invoice_id: match.invoice_id,
              transaction_id: match.transaction_id,
              invoice_number: match.invoice_number || match.invoice_invoice_number
            }));
            
            // Get all matched invoice and bank transaction identifiers
            const matchedInvoiceKeys = new Set();
            const matchedBankKeys = new Set();
            
            updatedMatches.forEach(match => {
              // Create unique keys for matching (amount + description)
              const invKey = `${match.invoice.amount || 0}_${match.invoice.description || ''}`;
              const bankKey = `${match.bank.amount || 0}_${match.bank.description || ''}`;
              matchedInvoiceKeys.add(invKey);
              matchedBankKeys.add(bankKey);
            });
            
            // Filter out matched items from unmatched lists
            const originalOnlyInv = currentReconciliationData.reconciliation.only_in_invoices || [];
            const originalOnlyBank = currentReconciliationData.reconciliation.only_in_bank || [];
            
            const updatedOnlyInv = originalOnlyInv.filter(item => {
              const itemKey = `${item.amount || 0}_${item.description || ''}`;
              return !matchedInvoiceKeys.has(itemKey);
            });
            
            const updatedOnlyBank = originalOnlyBank.filter(item => {
              const itemKey = `${item.amount || 0}_${item.description || ''}`;
              return !matchedBankKeys.has(itemKey);
            });
            
            // Update current data
            currentReconciliationData.reconciliation.matches = updatedMatches;
            currentReconciliationData.reconciliation.only_in_invoices = updatedOnlyInv;
            currentReconciliationData.reconciliation.only_in_bank = updatedOnlyBank;
            
            // Update accuracy percentages
            const totalInvoiceTxs = updatedMatches.length + updatedOnlyInv.length;
            const totalBankTxs = updatedMatches.length + updatedOnlyBank.length;
            const invoiceMatchPct = totalInvoiceTxs > 0 ? (updatedMatches.length / totalInvoiceTxs) * 100 : 0;
            const bankMatchPct = totalBankTxs > 0 ? (updatedMatches.length / totalBankTxs) * 100 : 0;
            
            if (!currentReconciliationData.reconciliation.accuracy) {
              currentReconciliationData.reconciliation.accuracy = {};
            }
            currentReconciliationData.reconciliation.accuracy.invoice_match_percentage = invoiceMatchPct;
            currentReconciliationData.reconciliation.accuracy.bank_match_percentage = bankMatchPct;
            
            // Show success message
            const statusEl = document.getElementById("status");
            statusEl.textContent = `âœ“ Match created successfully! Updated: ${updatedMatches.length} matches, ${updatedOnlyInv.length} unmatched invoices, ${updatedOnlyBank.length} unmatched bank transactions.`;
            statusEl.className = "status success show";
            
            // Re-render summary with updated data
            renderSummary(currentReconciliationData);
          }
        } catch (error) {
          console.error('Error refreshing reconciliation:', error);
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Match created, but error refreshing view. Please refresh the page.";
          statusEl.className = "status warning show";
        }
      }
      
      // Function to delete/remove a match and update all counts dynamically
      async function unmatchTransaction(reconciliationId, matchId, event) {
        event.stopPropagation();
        
        if (!confirm('Are you sure you want to DELETE this match?\n\nThis will permanently remove the match between the invoice and bank transaction. This action cannot be undone.\n\nThe counts and unmatched sections will be updated automatically.')) {
          return;
        }
        
        try {
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Deleting match...";
          statusEl.className = "status processing show";
          
          // Get the match data before deleting (from the row)
          const row = document.querySelector(`tr[data-match-id="${matchId}"]`);
          if (!row) {
            alert('Match row not found in UI.');
            return;
          }
          
          // Extract invoice and bank data from the row
          const cells = row.querySelectorAll('td');
          const invoiceDesc = cells[0]?.textContent?.trim() || '';
          const invoiceAmount = cells[1]?.textContent?.trim() || '';
          const bankDesc = cells[2]?.textContent?.trim() || '';
          const bankAmount = cells[3]?.textContent?.trim() || '';
          
          // Try to get full data from currentReconciliationData
          let invoiceData = null;
          let bankData = null;
          if (currentReconciliationData && currentReconciliationData.reconciliation) {
            const matches = currentReconciliationData.reconciliation.matches || [];
            const match = matches.find(m => {
              const mId = m.match_id !== undefined && m.match_id !== null ? m.match_id : null;
              return mId === matchId;
            });
            if (match) {
              invoiceData = match.invoice || {};
              bankData = match.bank || {};
            }
          }
          
          // If we couldn't get full data, create basic objects from row data
          if (!invoiceData) {
            invoiceData = {
              description: invoiceDesc,
              amount: parseFloat(invoiceAmount.replace(/[â‚¹,\s]/g, '')) || 0,
              date: null
            };
          }
          if (!bankData) {
            bankData = {
              description: bankDesc,
              amount: parseFloat(bankAmount.replace(/[â‚¹,\s]/g, '')) || 0,
              date: null
            };
          }
          
          // Delete the match from backend
          const response = await fetch(`/api/reconciliations/${reconciliationId}/matches/${matchId}`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            statusEl.textContent = `Error: ${result.error || 'Unknown error'}`;
            statusEl.className = "status error show";
            alert(`Error deleting match: ${result.error || 'Unknown error'}`);
            return;
          }
          
          // Update currentReconciliationData
          if (currentReconciliationData && currentReconciliationData.reconciliation) {
            const recon = currentReconciliationData.reconciliation;
            
            // Remove match from matches array
            recon.matches = (recon.matches || []).filter(m => {
              const mId = m.match_id !== undefined && m.match_id !== null ? m.match_id : null;
              return mId !== matchId;
            });
            
            // Add invoice to unmatched invoices
            if (!recon.only_in_invoices) {
              recon.only_in_invoices = [];
            }
            recon.only_in_invoices.push(invoiceData);
            
            // Add bank transaction to unmatched bank
            if (!recon.only_in_bank) {
              recon.only_in_bank = [];
            }
            recon.only_in_bank.push(bankData);
            
            // Recalculate accuracy percentages
            const totalInvoiceTxs = recon.matches.length + recon.only_in_invoices.length;
            const totalBankTxs = recon.matches.length + recon.only_in_bank.length;
            const invAcc = totalInvoiceTxs > 0 ? (recon.matches.length / totalInvoiceTxs * 100) : 0;
            const bankAcc = totalBankTxs > 0 ? (recon.matches.length / totalBankTxs * 100) : 0;
            
            // Update accuracy in reconciliation data
            if (!recon.accuracy) {
              recon.accuracy = {};
            }
            recon.accuracy.invoice_match_percentage = invAcc;
            recon.accuracy.bank_match_percentage = bankAcc;
          }
          
          // Remove the row from matched table
          row.remove();
          
          // Re-render the entire reconciliation display with updated data
          if (currentReconciliationData) {
            renderSummary(currentReconciliationData);
          }
          
          statusEl.textContent = "âœ“ Match deleted successfully! Counts and unmatched sections have been updated automatically.";
          statusEl.className = "status success show";
          
        } catch (error) {
          console.error('Error deleting match:', error);
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Error deleting match. Please try again.";
          statusEl.className = "status error show";
          alert('Error deleting match. Please try again.');
        }
      }
      
      function closeManualMatchModal() {
        const modal = document.getElementById('manual-match-modal');
        if (modal) {
          modal.remove();
        }
        selectedInvoiceIndex = null;
        selectedBankIndex = null;
      }
      
      // Delete match function
      async function deleteMatch(reconciliationId, matchId) {
        if (!confirm('Are you sure you want to delete this match?')) {
          return;
        }
        
        try {
          const response = await fetch(`/api/reconciliation/${reconciliationId}/matches/${matchId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            // Reload the page to show updated matches
            window.location.reload();
          } else {
            alert('Failed to delete match');
          }
        } catch (error) {
          console.error('Error deleting match:', error);
          alert('Error deleting match');
        }
      }
      
      // Wrap renderSummary to store data
      const originalRenderSummaryFunction = renderSummary;
      renderSummary = function(data) {
        currentReconciliationData = data;
        return originalRenderSummaryFunction(data);
      };
    </script>
  </body>
</html>
