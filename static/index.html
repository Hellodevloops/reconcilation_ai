<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Invoice vs Bank Reconciliation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      :root {
        --bg: #f5f6f8;
        --surface: rgba(255, 255, 255, 0.80);
        --surface-solid: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: rgba(17, 24, 39, 0.10);
        --primary: #714b67;
        --primary-2: #875a7b;
        --shadow: 0 22px 55px rgba(17, 24, 39, 0.10);
        --shadow-soft: 0 10px 22px rgba(17, 24, 39, 0.08);
        --card-pad: 16px;
        --card-pad-lg: 20px;
        --radius-xl: 22px;
        --radius-lg: 16px;
        --radius-md: 12px;
        --space-1: 6px;
        --space-2: 10px;
        --space-3: 14px;
        --space-4: 18px;
        --space-5: 22px;
        --space-6: 28px;
        --space-7: 40px;
      }

      * {
        box-sizing: border-box;
      }

      :focus-visible {
        outline: 3px solid rgba(113, 75, 103, 0.35);
        outline-offset: 2px;
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
          scroll-behavior: auto !important;
        }
      }
      
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        background:
          radial-gradient(980px 420px at 16% 10%, rgba(113, 75, 103, 0.08), transparent 62%),
          radial-gradient(860px 380px at 86% 20%, rgba(135, 90, 123, 0.06), transparent 60%),
          radial-gradient(980px 420px at 52% 96%, rgba(148, 163, 184, 0.10), transparent 62%),
          var(--bg);
        min-height: 100vh;
        padding: 20px 16px 48px;
        color: var(--text);
        position: relative;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
          radial-gradient(circle at 18% 38%, rgba(255, 255, 255, 0.48) 0%, transparent 56%),
          radial-gradient(circle at 80% 78%, rgba(255, 255, 255, 0.30) 0%, transparent 56%);
        pointer-events: none;
        z-index: 0;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }

      #recon-form {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-5);
      }

      @media (min-width: 980px) {
        #recon-form {
          grid-template-columns: 1fr 1fr;
          align-items: start;
        }

        #recon-form > .upload-section {
          margin-bottom: 0;
        }

        #recon-form > .upload-hint,
        #recon-form > .submit-section {
          grid-column: 1 / -1;
        }
      }

      @media (max-width: 640px) {
        body {
          padding: 14px 12px 34px;
        }

        .container {
          max-width: 100%;
        }
      }
      
      .header {
        text-align: center;
        margin-bottom: var(--space-6);
        color: var(--text);
        position: relative;
      }

      .header {
        margin-bottom: var(--space-5);
      }
      
      .header h1 {
        font-size: 2.25rem;
        font-weight: 800;
        margin: 0 0 10px 0;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 55%, #a06b95 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.5px;
      }
      
      .header .subtitle {
        font-size: 1.02rem;
        opacity: 0.85;
        font-weight: 500;
        color: var(--muted);
        margin-bottom: 10px;
      }
      
      .badge {
        display: inline-block;
        background: rgba(113, 75, 103, 0.08);
        padding: 9px 14px;
        border-radius: 25px;
        border: 1px solid rgba(113, 75, 103, 0.16);
        color: var(--primary);
        font-size: 0.9rem;
        font-weight: 600;
        backdrop-filter: blur(10px);
        font-weight: 600;
        letter-spacing: 0.2px;
      }
      
      .main-card {
        background: var(--surface-solid);
        border-radius: var(--radius-xl);
        padding: var(--card-pad-lg);
        box-shadow: var(--shadow);
        margin-bottom: var(--space-6);
        border: 1px solid var(--border);
      }

      @media (max-width: 968px) {
        .header h1 {
          font-size: 1.85rem;
        }

        .main-card {
          padding: var(--card-pad);
        }
      }
      
      .section-title {
        font-size: 1.02rem;
        font-weight: 850;
        color: var(--text);
        letter-spacing: -0.2px;
        margin-bottom: 16px;
        display: flex;
        align-items: baseline;
        gap: 10px;
        line-height: 1.25;
      }
      
      .section-title i {
        color: var(--primary-2);
        font-size: 1.1rem;
      }
      
      .upload-section {
        margin-bottom: var(--space-5);
      }
      
      .drop-zone {
        border: 1.5px dashed rgba(15, 23, 42, 0.22);
        border-radius: var(--radius-lg);
        padding: 28px 18px;
        background: rgba(255, 255, 255, 0.85);
        cursor: pointer;
        transition: all 0.25s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
      }
      
      .drop-zone::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(113, 75, 103, 0.10), transparent);
        transition: left 0.6s;
      }
      
      .drop-zone:hover::before {
        left: 100%;
      }
      
      .drop-zone:hover {
        border-color: rgba(113, 75, 103, 0.34);
        background: rgba(255, 255, 255, 0.92);
        transform: translateY(-1px);
        box-shadow: 0 12px 26px rgba(2, 6, 23, 0.08);
      }
      
      .drop-zone.dragover {
        border-color: var(--primary-2);
        background: rgba(113, 75, 103, 0.10);
        box-shadow: 0 0 0 4px rgba(113, 75, 103, 0.12);
        transform: translateY(-1px);
      }
      
      .drop-zone-icon {
        font-size: 2.6rem;
        margin-bottom: 12px;
        color: var(--primary-2);
        opacity: 0.95;
        transition: all 0.2s ease;
      }
      
      .drop-zone:hover .drop-zone-icon {
        transform: scale(1.1);
        opacity: 1;
      }
      
      .drop-zone-text {
        color: var(--text);
        font-size: 0.98rem;
        font-weight: 750;
        margin: 8px 0 6px;
      }
      
      .drop-zone-hint {
        color: #64748b;
        font-size: 0.86rem;
        margin-top: 4px;
      }
      
      .file-list {
        margin-top: 14px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .file-item {
        background: rgba(255, 255, 255, 0.92);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.88rem;
        box-shadow: 
          0 2px 8px rgba(17, 24, 39, 0.08),
          0 0 0 1px rgba(17, 24, 39, 0.10);
        animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid var(--border);
      }
      
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-15px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      
      .file-item-icon {
        font-size: 1.05rem;
        color: var(--primary-2);
      }
      
      .file-item-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 300px;
        font-weight: 500;
        color: #1e3a5f;
      }

      .file-item-name {
        max-width: 260px;
        font-weight: 650;
        color: var(--text);
      }
      
      .file-item-remove {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        transition: all 0.2s;
        font-weight: bold;
      }

      .file-item-remove {
        width: 24px;
        height: 24px;
      }
      
      .file-item-remove:hover {
        background: rgba(220, 38, 38, 0.9);
        border-color: rgba(220, 38, 38, 1);
        color: white;
        transform: scale(1.15);
      }
      
      .submit-section {
        text-align: center;
        margin-top: var(--space-4);
      }
      
      .submit-btn {
        background: linear-gradient(135deg, var(--primary-2) 0%, var(--primary) 100%);
        color: #ffffff;
        border: none;
        padding: 12px 22px;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 12px 26px rgba(113, 75, 103, 0.22);
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        letter-spacing: 0.2px;
      }
      
      .submit-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 14px 32px rgba(113, 75, 103, 0.24);
        background: linear-gradient(135deg, #956689 0%, var(--primary) 100%);
      }
      
      .submit-btn:active:not(:disabled) {
        transform: translateY(-1px);
      }
      
      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .btn-delete, .btn-view {
        width: 34px;
        height: 34px;
        padding: 0;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s ease;
        background: #ffffff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .match-actions {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        flex-wrap: nowrap;
        white-space: nowrap;
      }

      .matches-table th.actions-col,
      .matches-table td.actions-col {
        width: 96px;
        text-align: center;
      }

      .matches-table thead th,
      .unmatched-table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #ffffff;
      }

      .matches-table th.actions-col,
      .matches-table td.actions-col {
        position: sticky;
        right: 0;
        z-index: 3;
        background: #ffffff;
        box-shadow: -10px 0 14px rgba(15, 23, 42, 0.06);
      }

      .delta-cell {
        font-weight: 800;
        font-size: 0.85rem;
        white-space: nowrap;
      }

      .delta-ok {
        color: #059669;
      }

      .delta-warn {
        color: #b45309;
      }

      .delta-bad {
        color: #dc2626;
      }
      
      .btn-delete {
        color: #ef4444;
        border-color: #fecaca;
      }
      
      .btn-delete:hover {
        background: #fef2f2;
        border-color: #ef4444;
      }
      
      .btn-view {
        color: var(--primary);
        border-color: rgba(113, 75, 103, 0.22);
      }
      
      .btn-view:hover {
        background: rgba(113, 75, 103, 0.08);
        border-color: rgba(113, 75, 103, 0.35);
      }
      
      .status {
        margin-top: 25px;
        padding: 16px 24px;
        border-radius: 12px;
        font-weight: 600;
        text-align: center;
        display: none;
        border: 1px solid;
      }
      
      .status.show {
        display: block;
        animation: fadeIn 0.4s ease;
      }
      
      @keyframes fadeIn {
        from { 
          opacity: 0; 
          transform: translateY(-10px);
        }
        to { 
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .status.processing {
        background: rgba(113, 75, 103, 0.12);
        color: var(--primary);
        border-color: rgba(113, 75, 103, 0.22);
        border-left: 4px solid var(--primary-2);
      }
      
      .progress-container {
        margin-top: 15px;
        display: none;
      }
      
      .progress-container.show {
        display: block;
      }
      
      .progress-bar-wrapper {
        width: 100%;
        height: 8px;
        background: rgba(113, 75, 103, 0.10);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 8px;
      }
      
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-2) 0%, #a06b95 50%, var(--primary-2) 100%);
        background-size: 200% 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
        animation: progress-shimmer 2s infinite;
      }
      
      @keyframes progress-shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
      
      .progress-text {
        font-size: 0.85rem;
        color: #475569;
        text-align: center;
        margin-top: 5px;
      }
      
      .search-filter-container {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      
      .search-input {
        flex: 1;
        min-width: 200px;
        padding: 10px 15px;
        background: #ffffff;
        font-size: 0.9rem;
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--text);
      }
      
      .search-input:focus {
        outline: none;
        border-color: rgba(113, 75, 103, 0.55);
        background: #ffffff;
        box-shadow: 0 0 0 3px rgba(113, 75, 103, 0.12);
      }
      
      .search-input::placeholder {
        color: #94a3b8;
      }
      
      .status.success {
        background: rgba(34, 197, 94, 0.15);
        color: #4ade80;
        border-color: rgba(34, 197, 94, 0.3);
        border-left: 4px solid #22c55e;
      }
      
      .status.error {
        background: rgba(239, 68, 68, 0.15);
        color: #f87171;
        border-color: rgba(239, 68, 68, 0.3);
        border-left: 4px solid #ef4444;
      }
      
      .results-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-top: 16px;
      }

      @media (min-width: 968px) {
        .results-grid {
          grid-template-columns: 1.15fr 0.85fr;
          align-items: start;
        }
      }
      
      .results-secondary {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-top: 16px;
      }
      
      @media (min-width: 968px) {
        .results-secondary {
          grid-template-columns: 1fr 1fr;
        }
      }
      
      .result-card {
        background: var(--surface-solid);
        border-radius: var(--radius-xl);
        padding: var(--card-pad);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border);
      }
      
      .result-card h2 {
        font-size: 1.05rem;
        font-weight: 850;
        color: var(--text);
        margin: 0 0 14px 0;
        display: flex;
        align-items: baseline;
        gap: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
        letter-spacing: -0.2px;
        line-height: 1.25;
      }
      
      .result-card h2 i {
        color: var(--primary-2);
      }
      
      .result-card--full {
        grid-column: 1 / -1;
        min-height: 300px;
      }
      
      .result-card--full #summary {
        min-height: 240px;
      }
      
      .json-output {
        background: #f8fafc;
        color: #1e3a5f;
        padding: 25px;
        border-radius: 12px;
        max-height: 500px;
        overflow: auto;
        font-family: 'Courier New', 'Fira Code', monospace;
        font-size: 0.875rem;
        line-height: 1.7;
        border: 1px solid rgba(37, 99, 235, 0.2);
        box-shadow: inset 0 2px 8px rgba(37, 99, 235, 0.05);
      }
      
      .json-toggle {
        background: rgba(113, 75, 103, 0.10);
        border: 1px solid rgba(113, 75, 103, 0.24);
        color: var(--primary);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      
      .json-toggle:hover {
        background: rgba(113, 75, 103, 0.14);
        border-color: rgba(113, 75, 103, 0.40);
      }
      
      .json-container {
        display: none;
      }
      
      .json-container.show {
        display: block;
      }
      
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
        margin-bottom: 18px;
      }

      @media (min-width: 968px) {
        .summary-grid {
          grid-template-columns: repeat(4, minmax(0, 1fr));
          gap: 14px;
          margin-bottom: 18px;
        }
      }
      .summary-item {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(59, 130, 246, 0.08) 100%);
        padding: var(--card-pad);
        border-radius: 14px;
        border: 1px solid rgba(37, 99, 235, 0.15);
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.08);
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
        border-left: 4px solid var(--primary-2);
      }

      .summary-item {
        border: 1px solid var(--border);
        border-left: 0;
        background: rgba(248, 250, 252, 0.95);
        box-shadow: 0 12px 26px rgba(2, 6, 23, 0.06);
      }
      
      .summary-item:hover {
        transform: translateY(-3px);
        box-shadow: 
          0 8px 25px rgba(37, 99, 235, 0.15),
          0 0 0 1px rgba(37, 99, 235, 0.2);
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(59, 130, 246, 0.12) 100%);
      }

      .summary-item:hover {
        box-shadow:
          0 10px 22px rgba(17, 24, 39, 0.10),
          0 0 0 1px rgba(113, 75, 103, 0.12);
        background: rgba(255, 255, 255, 0.98);
      }
      
      .summary-label {
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        margin-bottom: 10px;
      }

      .summary-label {
        font-size: 0.72rem;
        letter-spacing: 0.6px;
        margin-bottom: 8px;
      }
      
      .summary-value {
        font-size: 2rem;
        font-weight: 800;
        color: #1e40af;
        letter-spacing: -0.5px;
      }

      .summary-value {
        font-size: 1.4rem;
        font-weight: 850;
        color: var(--text);
      }

      .summary-value.highlight {
        color: var(--primary);
      }

      .side-panels {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-top: 16px;
        margin-bottom: 16px;
      }

      @media (min-width: 968px) {
        .side-panels {
          grid-template-columns: 1fr 1fr;
        }
      }

      .side-panel {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-soft);
        padding: var(--card-pad);
      }

      .side-panel-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
      }

      .side-panel-title {
        font-weight: 850;
        color: var(--text);
        letter-spacing: -0.2px;
        font-size: 0.95rem;
      }

      .side-panel-sub {
        font-size: 0.82rem;
        color: var(--muted);
      }

      .segbar {
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: rgba(17, 24, 39, 0.08);
        overflow: hidden;
        display: flex;
      }

      .segbar > span {
        height: 100%;
        display: block;
      }

      .segbar .seg-not {
        background: rgba(17, 24, 39, 0.30);
      }

      .segbar .seg-match {
        background: var(--primary-2);
      }

      .segbar .seg-exc {
        background: #dc2626;
      }

      .segbar-scale {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--muted);
        margin-top: 8px;
      }

      .segbar-scale span {
        font-variant-numeric: tabular-nums;
      }

      .segbar-legend {
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        margin-top: 10px;
        color: var(--muted);
        font-size: 0.78rem;
      }

      .segbar-legend span {
        display: inline-flex;
        align-items: center;
        gap: 0;
        font-variant-numeric: tabular-nums;
      }

      .segbar-legend .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        display: inline-block;
        margin-right: 8px;
      }

      .segbar-legend .dot-not {
        background: rgba(17, 24, 39, 0.30);
      }

      .segbar-legend .dot-match {
        background: var(--primary-2);
      }

      .segbar-legend .dot-exc {
        background: #dc2626;
      }

      .data-area {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-top: 16px;
      }

      .data-area.single-view {
        grid-template-columns: 1fr !important;
      }

      @media (min-width: 968px) {
        .data-area {
          grid-template-columns: 1fr 1fr;
          align-items: start;
        }

        .data-area > .results-section--full {
          grid-column: 1 / -1;
        }
      }

      .results-section {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-soft);
        padding: var(--card-pad);
        overflow-x: auto;
      }

      .results-filter {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 12px;
        margin-bottom: 12px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow-soft);
        position: sticky;
        top: 86px;
        z-index: 4;
      }

      .results-filter-right {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 10px;
        flex: 1;
      }

      .results-search {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        min-width: 280px;
        max-width: 440px;
        width: 100%;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(113, 75, 103, 0.18);
        border-radius: 12px;
      }

      .results-search i {
        color: rgba(113, 75, 103, 0.85);
        font-size: 0.9rem;
      }

      .results-search input {
        border: none;
        outline: none;
        width: 100%;
        font-size: 0.9rem;
        color: #0f172a;
        background: transparent;
      }

      .results-search input::placeholder {
        color: #94a3b8;
      }

      .results-filter-tabs {
        display: inline-flex;
        gap: 6px;
        padding: 4px;
        background: rgba(113, 75, 103, 0.06);
        border: 1px solid rgba(113, 75, 103, 0.12);
        border-radius: 12px;
      }

      .results-filter-btn {
        border: 1px solid transparent;
        background: transparent;
        color: #334155;
        font-weight: 700;
        font-size: 0.82rem;
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
        white-space: nowrap;
      }

      .results-filter-btn:hover {
        background: rgba(113, 75, 103, 0.08);
        border-color: rgba(113, 75, 103, 0.18);
      }

      .results-filter-btn.active {
        background: rgba(113, 75, 103, 0.16);
        border-color: rgba(113, 75, 103, 0.28);
        color: var(--primary);
      }

      .results-section-title {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        padding-bottom: 12px;
        margin-bottom: 14px;
        border-bottom: 1px solid var(--border);
        font-weight: 850;
        color: var(--text);
        letter-spacing: -0.2px;
        line-height: 1.25;
      }

      .results-section-title i {
        color: var(--primary-2);
      }

      .results-section .matches-table,
      .results-section .unmatched-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        overflow: hidden;
        border-radius: 14px;
        min-width: 720px;
      }

      .matches-table th,
      .unmatched-table th {
        padding: 10px 12px;
        text-align: left;
        font-weight: 750;
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #334155;
        border-bottom: 1px solid rgba(15, 23, 42, 0.10);
        white-space: nowrap;
      }

      .matches-table td,
      .unmatched-table td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        color: #0f172a;
        font-size: 0.87rem;
        line-height: 1.35;
        vertical-align: middle;
      }

      .matches-table tbody tr:hover,
      .unmatched-table tbody tr:hover {
        background: rgba(113, 75, 103, 0.05);
      }

      .matches-table tbody tr:last-child td,
      .unmatched-table tbody tr:last-child td {
        border-bottom: none;
      }

      .results-section .matches-table thead th,
      .results-section .unmatched-table thead th {
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 1;
      }

      .results-section > table,
      .results-section > div {
        min-width: 0;
      }

      .summary-value.success {
        color: #22c55e;
      }

      .summary-value.warning {
        color: #f59e0b;
      }
      
      .unmatched-row:hover {
        background: rgba(113, 75, 103, 0.08) !important;
        transform: translateX(2px);
        transition: all 0.2s ease;
      }
      
      .unmatched-row.selected {
        background: rgba(113, 75, 103, 0.14) !important;
        border-left: 4px solid var(--primary-2);
      }
      
      .matches-table tbody tr:last-child td, .unmatched-table tbody tr:last-child td {
        border-bottom: none;
      }
      
      .amount-cell {
        font-weight: 700;
        color: var(--primary-2);
        font-family: 'Courier New', monospace;
      }
      
      .description-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .match-score {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 700;
        background: rgba(34, 197, 94, 0.2);
        color: #4ade80;
        border: 1px solid rgba(34, 197, 94, 0.3);
      }
      
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #64748b;
        font-size: 0.95rem;
      }
      
      .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.3;
        color: var(--primary-2);
      }
      
      .section-toggle {
        background: transparent;
        border: 1px solid rgba(113, 75, 103, 0.22);
        color: var(--primary);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: 15px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      
      .section-toggle:hover {
        background: rgba(113, 75, 103, 0.10);
        border-color: rgba(113, 75, 103, 0.35);
        color: var(--primary);
      }
      
      .toggleable-section {
        display: none;
        margin-top: 15px;
      }
      
      .toggleable-section.show {
        display: block;
      }
      
      input[type="file"] {
        display: none;
      }
      
      .upload-hint {
        background: rgba(113, 75, 103, 0.06);
        padding: 18px 20px;
        border-radius: 12px;
        margin-top: 25px;
        font-size: 0.9rem;
        color: #475569;
        line-height: 1.7;
        border: 1px solid rgba(113, 75, 103, 0.16);
      }
      
      .upload-hint strong {
        color: var(--primary);
        font-weight: 700;
      }
      
      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      
      ::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 5px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }
      
      /* Modal styles */
      .modal-overlay {
        scrollbar-width: thin;
        scrollbar-color: #94a3b8 #f1f5f9;
      }
      
      .modal-overlay::-webkit-scrollbar {
        width: 8px;
      }
      
      .modal-overlay::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }
      
      .modal-overlay::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 4px;
      }
      
      .modal-overlay::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-file-invoice-dollar"></i> Invoice Reconciliation</h1>
        <div class="subtitle">Automated Invoice vs Bank Statement Matching</div>
        <div class="badge">
          <i class="fas fa-robot"></i> AI-Powered OCR & Matching
        </div>
      </div>

      <div class="main-card">
        <form id="recon-form">
          <div class="upload-section">
            <div class="section-title">
              <i class="fas fa-file-invoice"></i>
              Invoice Files
            </div>
            <div class="drop-zone" id="invoice-drop-zone">
              <div class="drop-zone-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <div class="drop-zone-text">
                Drag & Drop Invoice Files Here
              </div>
              <div class="drop-zone-hint">or click to browse</div>
              <input
                id="invoice"
                name="invoice"
                type="file"
                multiple
                accept="application/pdf,image/*,.xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
              />
            </div>
            <div id="invoice-file-list" class="file-list"></div>
          </div>

          <div class="upload-section">
            <div class="section-title">
              <i class="fas fa-university"></i>
              Bank Statement File(s) <span style="font-size: 0.85rem; color: #64748b; font-weight: 400;">(Multiple files supported)</span>
            </div>
            <div class="drop-zone" id="bank-drop-zone">
              <div class="drop-zone-icon">
                <i class="fas fa-file-alt"></i>
              </div>
              <div class="drop-zone-text">
                Drag & Drop Bank Statement(s) Here
              </div>
              <div class="drop-zone-hint">or click to browse (you can select multiple files)</div>
              <input
                id="bank"
                name="bank"
                type="file"
                multiple
                accept=".csv,application/pdf,image/*,.xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
              />
            </div>
            <div id="bank-file-list" class="file-list"></div>
          </div>

          <div class="upload-hint">
            <strong>Supported Formats:</strong> PDF, Excel (.xlsx, .xls), CSV, Images (PNG, JPG, etc.)
          </div>

          <div class="submit-section">
            <button type="submit" id="submit-btn" class="submit-btn">
              <i class="fas fa-play"></i>
              Run Reconciliation
            </button>
            <div id="status" class="status"></div>
            <div id="progress-container" class="progress-container">
              <div class="progress-bar-wrapper">
                <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
              </div>
              <div id="progress-text" class="progress-text">0%</div>
            </div>
          </div>
        </form>
      </div>

      <div class="results-grid">
        <div class="result-card result-card--full">
          <h2>
            <i class="fas fa-chart-line"></i>
            Reconciliation Summary
          </h2>
          <div id="summary">
            <div style="text-align: center; color: #64748b; padding: 50px;">
              <i class="fas fa-chart-bar" style="font-size: 3.5rem; opacity: 0.2; margin-bottom: 20px; color: var(--primary-2);"></i>
              <div style="font-size: 1rem; font-weight: 500;">Run reconciliation to see results</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="results-secondary" id="results-secondary" style="display: none;">
        <div class="result-card">
          <h2>
            <i class="fas fa-code"></i>
            JSON Response
          </h2>
          <button class="json-toggle" id="json-toggle">
            <i class="fas fa-chevron-down"></i>
            <span>Show JSON</span>
          </button>
          <div class="json-container" id="json-container">
            <pre id="json-output" class="json-output">{}</pre>
          </div>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("recon-form");
      const statusEl = document.getElementById("status");
      const jsonOutput = document.getElementById("json-output");
      const summaryEl = document.getElementById("summary");
      const submitBtn = document.getElementById("submit-btn");

      let currentResultsFilter = "matched";
      let currentResultsSearch = "";

      function applyResultsFilter() {
        const filter = currentResultsFilter || "matched";
        const filterBar = document.getElementById("results-filter");
        if (filterBar) {
          filterBar.querySelectorAll(".results-filter-btn").forEach((btn) => {
            const btnFilter = btn.getAttribute("data-filter");
            btn.classList.toggle("active", btnFilter === filter);
          });
        }

        const dataArea = document.querySelector(".data-area");
        if (dataArea) {
          dataArea.classList.toggle("single-view", true);
        }

        const sections = document.querySelectorAll("[data-results-section]");
        sections.forEach((el) => {
          const type = el.getAttribute("data-results-section");
          let show = true;

          if (filter === "matched") {
            show = type === "matched";
          } else if (filter === "unmatched_invoices") {
            show = type === "unmatched_invoices";
          } else if (filter === "unmatched_bank") {
            show = type === "unmatched_bank";
          } else if (filter === "exceptions") {
            show = type === "unmatched_invoices" || type === "unmatched_bank";
          } else {
            show = type === "matched";
          }

          el.style.display = show ? "" : "none";

          if (dataArea) {
            el.style.gridColumn = show ? "1 / -1" : "";
          }
        });

        applyResultsSearch();
      }

      function applyResultsSearch() {
        const q = (currentResultsSearch || "").trim().toLowerCase();
        const filterVisibleTables = () => {
          const visibleSections = Array.from(document.querySelectorAll("[data-results-section]"))
            .filter((el) => el.style.display !== "none");

          visibleSections.forEach((section) => {
            const tables = section.querySelectorAll("table");
            tables.forEach((table) => {
              const rows = table.querySelectorAll("tbody tr");
              rows.forEach((row) => {
                if (!q) {
                  row.style.display = "";
                  return;
                }
                const text = (row.textContent || "").toLowerCase();
                row.style.display = text.includes(q) ? "" : "none";
              });
            });
          });
        };

        filterVisibleTables();
      }

      function setResultsSearch(value) {
        currentResultsSearch = value || "";
        applyResultsSearch();
      }

      function setResultsFilter(filter) {
        currentResultsFilter = filter;
        applyResultsFilter();

        const searchInput = document.getElementById('results-search-input');
        if (searchInput) {
          searchInput.value = currentResultsSearch;
        }
      }
      

      // Prevent default drag behavior
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        document.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      function getFileIcon(fileName) {
        const ext = fileName.split('.').pop().toLowerCase();
        if (['pdf'].includes(ext)) return 'fa-file-pdf';
        if (['xlsx', 'xls'].includes(ext)) return 'fa-file-excel';
        if (['csv'].includes(ext)) return 'fa-file-csv';
        if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'fa-file-image';
        return 'fa-file';
      }

      function setupDragAndDrop(dropZoneId, inputId, fileListId, allowMultiple = false) {
        const dropZone = document.getElementById(dropZoneId);
        const input = document.getElementById(inputId);
        const fileList = document.getElementById(fileListId);

        if (!dropZone || !input || !fileList) return;

        dropZone.addEventListener("click", (e) => {
          e.stopPropagation();
          input.click();
        });

        dropZone.addEventListener("dragenter", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.add("dragover");
        });

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.add("dragover");
        });

        dropZone.addEventListener("dragleave", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!dropZone.contains(e.relatedTarget)) {
            dropZone.classList.remove("dragover");
          }
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.remove("dragover");

          const files = Array.from(e.dataTransfer.files);
          if (files.length === 0) return;

          try {
            if (allowMultiple) {
              const existingFiles = Array.from(input.files);
              const allFiles = [...existingFiles, ...files];
              const dataTransfer = new DataTransfer();
              allFiles.forEach((file) => dataTransfer.items.add(file));
              input.files = dataTransfer.files;
            } else {
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(files[0]);
              input.files = dataTransfer.files;
            }
            updateFileList(input, fileList, allowMultiple);
          } catch (err) {
            console.error("Error handling dropped files:", err);
            alert("Error adding files. Please try again.");
          }
        });

        input.addEventListener("change", () => {
          updateFileList(input, fileList, allowMultiple);
        });

        updateFileList(input, fileList, allowMultiple);
      }

      function updateFileList(input, fileListEl, allowMultiple) {
        const files = Array.from(input.files);
        if (files.length === 0) {
          fileListEl.innerHTML = "";
          return;
        }

        if (allowMultiple) {
          fileListEl.innerHTML = files
            .map(
              (file, index) => `
            <div class="file-item">
              <i class="fas ${getFileIcon(file.name)} file-item-icon"></i>
              <span class="file-item-name" title="${file.name}">${file.name}</span>
              <button type="button" class="file-item-remove" data-index="${index}">×</button>
            </div>
          `
            )
            .join("");

          fileListEl.querySelectorAll(".file-item-remove").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const index = parseInt(btn.dataset.index);
              const dataTransfer = new DataTransfer();
              Array.from(input.files)
                .filter((_, i) => i !== index)
                .forEach((file) => dataTransfer.items.add(file));
              input.files = dataTransfer.files;
              updateFileList(input, fileListEl, allowMultiple);
            });
          });
        } else {
          fileListEl.innerHTML = `
            <div class="file-item">
              <i class="fas ${getFileIcon(files[0].name)} file-item-icon"></i>
              <span class="file-item-name" title="${files[0].name}">${files[0].name}</span>
              <button type="button" class="file-item-remove">×</button>
            </div>
          `;
          fileListEl.querySelector(".file-item-remove").addEventListener("click", () => {
            input.value = "";
            fileListEl.innerHTML = "";
          });
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          setupDragAndDrop("invoice-drop-zone", "invoice", "invoice-file-list", true);
          setupDragAndDrop("bank-drop-zone", "bank", "bank-file-list", true); // Enable multiple bank files
          
        });
      } else {
        setupDragAndDrop("invoice-drop-zone", "invoice", "invoice-file-list", true);
        setupDragAndDrop("bank-drop-zone", "bank", "bank-file-list", false);
        
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        statusEl.className = "status";
        statusEl.textContent = "";
        summaryEl.innerHTML = "";
        jsonOutput.textContent = "{}";
        document.getElementById("results-secondary").style.display = "none";

        const invoiceFiles = document.getElementById("invoice").files;
        const bankFiles = document.getElementById("bank").files;

        if (!invoiceFiles.length || !bankFiles.length) {
          statusEl.textContent = "Please select at least one invoice file and one bank file.";
          statusEl.className = "status error show";
          return;
        }

        const formData = new FormData();
        for (const file of invoiceFiles) {
          formData.append("invoice", file);
        }
        for (const file of bankFiles) {
          formData.append("bank", file);
        }

        submitBtn.disabled = true;
        const startTime = Date.now();
        let statusUpdateInterval;
        
        // Calculate PRE-PROCESSING estimate based on file sizes and types
        let totalFileSize = 0;
        let invoiceFileSizes = [];
        let invoiceFileTypes = [];
        let bankFileSizes = [];
        let bankFileTypes = [];
        
        for (const file of invoiceFiles) {
          totalFileSize += file.size;
          invoiceFileSizes.push(file.size);
          const fileName = file.name.toLowerCase();
          if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            invoiceFileTypes.push('.xlsx');
          } else if (fileName.endsWith('.csv')) {
            invoiceFileTypes.push('.csv');
          } else if (fileName.endsWith('.pdf')) {
            invoiceFileTypes.push('.pdf');
          } else {
            invoiceFileTypes.push('.image');
          }
        }
        
        for (const file of bankFiles) {
          totalFileSize += file.size;
          bankFileSizes.push(file.size);
          const bankFileName = file.name.toLowerCase();
          if (bankFileName.endsWith('.xlsx') || bankFileName.endsWith('.xls')) {
            bankFileTypes.push('.xlsx');
          } else if (bankFileName.endsWith('.csv')) {
            bankFileTypes.push('.csv');
          } else if (bankFileName.endsWith('.pdf')) {
            bankFileTypes.push('.pdf');
          } else {
            bankFileTypes.push('.image');
          }
        }
        
        const bankFileType = bankFileTypes[0] || '.pdf'; // Use first bank file type for estimation
        
        // Smart estimation based on file types
        let estimatedTimeSeconds = 0;
        let invoiceTxEstimate = 0;
        let bankTxEstimate = 0;
        
        // Estimate transactions and time based on file type
        for (let i = 0; i < invoiceFileSizes.length; i++) {
          const sizeMB = invoiceFileSizes[i] / (1024 * 1024);
          const fileType = invoiceFileTypes[i];
          
          if (fileType === '.xlsx') {
            invoiceTxEstimate += sizeMB * 800;
            estimatedTimeSeconds += sizeMB * 0.2; // Parsing
          } else if (fileType === '.csv') {
            invoiceTxEstimate += sizeMB * 1500;
            estimatedTimeSeconds += sizeMB * 0.1;
          } else if (fileType === '.pdf') {
            invoiceTxEstimate += sizeMB * 80;
            estimatedTimeSeconds += sizeMB * 0.5;
          } else {
            invoiceTxEstimate += sizeMB * 20;
            estimatedTimeSeconds += sizeMB * 5.0; // OCR is slow
          }
        }
        
        const totalBankSizeMB = bankFileSizes.reduce((sum, size) => sum + size, 0) / (1024 * 1024);
        if (bankFileType === '.xlsx') {
          bankTxEstimate = totalBankSizeMB * 800;
          estimatedTimeSeconds += totalBankSizeMB * 0.2;
        } else if (bankFileType === '.csv') {
          bankTxEstimate = totalBankSizeMB * 1500;
          estimatedTimeSeconds += totalBankSizeMB * 0.1;
        } else if (bankFileType === '.pdf') {
          bankTxEstimate = totalBankSizeMB * 80;
          estimatedTimeSeconds += totalBankSizeMB * 0.5;
        } else {
          bankTxEstimate = totalBankSizeMB * 20;
          estimatedTimeSeconds += totalBankSizeMB * 5.0;
        }
        
        // Estimate reconciliation time (based on transaction counts)
        // Rough formula: ~0.0006 seconds per comparison, but with optimization ~85% reduction
        const totalComparisons = invoiceTxEstimate * bankTxEstimate;
        const optimizedComparisons = totalComparisons * 0.15; // 85% reduction
        const reconciliationTime = 0.5 + (optimizedComparisons * 0.0006) + ((invoiceTxEstimate + bankTxEstimate) * 0.0002);
        estimatedTimeSeconds += reconciliationTime;
        
        // Minimum time
        estimatedTimeSeconds = Math.max(3, estimatedTimeSeconds);
        
        let estimatedTimeDisplay = estimatedTimeSeconds < 60 
          ? `${estimatedTimeSeconds.toFixed(0)} seconds` 
          : `${Math.floor(estimatedTimeSeconds / 60)} minute${Math.floor(estimatedTimeSeconds / 60) !== 1 ? 's' : ''} ${Math.floor(estimatedTimeSeconds % 60)} second${Math.floor(estimatedTimeSeconds % 60) !== 1 ? 's' : ''}`;
        
        // Show pre-processing estimate immediately
        statusEl.textContent = `⏱️ Estimated processing time: ${estimatedTimeDisplay} (${Math.round(invoiceTxEstimate)} invoices, ${Math.round(bankTxEstimate)} bank transactions estimated). Starting processing...`;
        statusEl.className = "status processing show";
        
        // Update status message periodically to show it's still processing
        let statusCounter = 0;
        const statusMessages = [
          `Processing files and running reconciliation... (Estimated: ${estimatedTimeDisplay})`,
          "Reading invoice files...",
          "Reading bank statement...",
          "Extracting transactions...",
          "Matching transactions...",
          "Finalizing results...",
        ];
        
        const updateStatusMessage = () => {
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
          const msgIndex = Math.min(statusCounter, statusMessages.length - 1);
          let msg = statusMessages[msgIndex];
          if (msgIndex > 0) {
            msg += ` (Elapsed: ${elapsed}s, Estimated: ${estimatedTimeDisplay})`;
          }
          statusEl.textContent = msg;
          statusCounter++;
        };
        
        // Start updating after 2 seconds
        setTimeout(() => {
          statusUpdateInterval = setInterval(updateStatusMessage, 3000);
        }, 2000);

        // Progress tracking variables
        let progressId = null;
        let progressInterval = null;
        const progressContainer = document.getElementById("progress-container");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");
        
        // Function to poll progress
        const pollProgress = async (id) => {
          try {
            const response = await fetch(`/api/progress/${id}`);
            if (!response.ok) return;
            
            const progress = await response.json();
            
            if (progress.status === "completed" || progress.status === "error") {
              clearInterval(progressInterval);
              progressContainer.classList.remove("show");
              return;
            }
            
            // Update progress bar
            const progressPercent = Math.round(progress.progress * 100);
            progressBar.style.width = `${progressPercent}%`;
            progressText.textContent = `${progressPercent}% - ${progress.message || "Processing..."}`;
            progressContainer.classList.add("show");
          } catch (error) {
            console.error("Error polling progress:", error);
          }
        };
        
        try {
          // Generate progress ID
          progressId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          
          // Start polling progress (will start after response)
          const res = await fetch(`/api/reconcile?progress_id=${progressId}`, {
            method: "POST",
            body: formData,
          });
          
          // Start polling progress immediately
          if (progressId) {
            progressInterval = setInterval(() => pollProgress(progressId), 1000); // Poll every second
          }

          clearInterval(statusUpdateInterval);
          
          // Stop progress polling
          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
          
          // Hide progress bar
          if (progressContainer) {
            progressContainer.classList.remove("show");
          }
          
          let data;
          try {
            data = await res.json();
          } catch (jsonErr) {
            console.error("Failed to parse JSON response:", jsonErr);
            const text = await res.text();
            console.error("Response text:", text.substring(0, 500));
            statusEl.textContent = "Error: Server returned invalid response. Check console for details.";
            statusEl.className = "status error show";
            submitBtn.disabled = false;
            return;
          }
          
          // Update detected currency from response
          if (data.currency) {
            detectedCurrency = data.currency;
            console.log(`Currency detected: ${detectedCurrency}`);
          }
          
          // Always show JSON output for debugging
          try {
            jsonOutput.textContent = JSON.stringify(data, null, 2);
          } catch (jsonErr) {
            console.error("Failed to stringify JSON:", jsonErr);
            jsonOutput.textContent = "Error displaying JSON output";
          }

          // Check if response has progress_id
          if (data.progress_id && progressId !== data.progress_id) {
            progressId = data.progress_id;
            // Continue polling with new ID
            if (progressId) {
              progressInterval = setInterval(() => pollProgress(progressId), 1000);
            }
          }
          
          if (!res.ok) {
            const processingTime = data.processing_time_seconds 
              ? ` (took ${data.processing_time_seconds.toFixed(2)}s)` 
              : "";
            statusEl.textContent = (data.error || "Something went wrong.") + processingTime;
            statusEl.className = "status error show";
            // Still try to show results if available
            if (data.reconciliation) {
              renderSummary(data);
              document.getElementById("results-secondary").style.display = "grid";
            }
            submitBtn.disabled = false;
            return;
          }

          // Get processing time from response
          const processingTime = data.reconciliation?.processing_time_formatted 
            || (data.reconciliation?.processing_time_seconds 
              ? `${data.reconciliation.processing_time_seconds.toFixed(2)} seconds` 
              : "");
          
          // Get pre-processing estimate (from file sizes)
          const preEstimate = data.pre_processing_estimate || {};
          const preEstTime = preEstimate.total_estimated_time_formatted || '';
          
          // Get estimated time (after parsing, more accurate)
          const estimatedTime = data.reconciliation?.estimated_time_formatted 
            || (data.reconciliation?.estimated_time_seconds 
              ? `${data.reconciliation.estimated_time_seconds.toFixed(2)} seconds` 
              : "");
          
          let timeComparison = "";
          if (preEstTime && processingTime) {
            const preEstSeconds = preEstimate.total_estimated_time || 0;
            const actSeconds = data.reconciliation?.processing_time_seconds || 0;
            if (preEstSeconds > 0 && actSeconds > 0) {
              const diff = ((actSeconds - preEstSeconds) / preEstSeconds * 100).toFixed(0);
              if (Math.abs(diff) > 5) {
                timeComparison = ` (Pre-estimate: ${preEstTime}, ${diff > 0 ? '+' : ''}${diff}% ${diff > 0 ? 'slower' : 'faster'})`;
              } else {
                timeComparison = ` (Pre-estimate: ${preEstTime}, very accurate!)`;
              }
            }
          }
          
          statusEl.textContent = `✓ Reconciliation completed successfully! ${processingTime ? `(Processing time: ${processingTime}${timeComparison})` : ''}`;
          statusEl.className = "status success show";
          
          // Store reconciliation data for manual matching
          currentReconciliationData = data;
          
          // Always render summary - even if empty
          try {
            renderSummary(data);
            // After initial render, refresh using DB-joined matches so invoice numbers/IDs are authoritative
            try {
              const rid = data?.reconciliation?.reconciliation_id || data?.reconciliation?.id;
              if (rid) {
                await refreshReconciliation(rid);
              }
            } catch (refreshErr) {
              console.warn('Could not refresh reconciliation from DB:', refreshErr);
            }
          } catch (renderErr) {
            console.error("Error rendering summary:", renderErr);
            summaryEl.innerHTML = `
              <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <div>Error displaying results. Check console for details.</div>
                <div style="font-size: 0.8rem; margin-top: 10px; color: #64748b;">
                  Data received: ${data ? 'Yes' : 'No'}
                </div>
              </div>
            `;
          }
          
          document.getElementById("results-secondary").style.display = "grid";
        } catch (err) {
          clearInterval(statusUpdateInterval);
          console.error("Reconciliation error:", err);
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
          statusEl.textContent = `Network error. Please check the server connection. (Took ${elapsed}s)`;
          statusEl.className = "status error show";
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Global currency variable (set from API response)
      let detectedCurrency = '₹'; // Default to ₹
      
      function formatCurrency(amount, currency = null) {
        const curr = currency || detectedCurrency;
        if (amount === null || amount === undefined) return curr + '0.00';
        const num = parseFloat(amount);
        if (isNaN(num)) return curr + '0.00';
        const sign = num < 0 ? '-' : '';
        const absNum = Math.abs(num);
        return sign + curr + absNum.toLocaleString('en-IN', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }
      
            
      function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
          const tryFormat = (d) => d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });

          // First try native Date parsing
          let date = new Date(dateStr);
          if (!Number.isNaN(date.getTime())) {
            return tryFormat(date);
          }

          // Try common non-ISO formats that native Date() often fails on
          const s = String(dateStr).trim();

          // DD-MM-YYYY or DD/MM/YYYY
          let m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
          if (m) {
            const dd = parseInt(m[1], 10);
            const mm = parseInt(m[2], 10);
            const yyyy = parseInt(m[3], 10);
            date = new Date(yyyy, mm - 1, dd);
            if (!Number.isNaN(date.getTime())) return tryFormat(date);
          }

          // YYYY-MM-DD
          m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
          if (m) {
            const yyyy = parseInt(m[1], 10);
            const mm = parseInt(m[2], 10);
            const dd = parseInt(m[3], 10);
            date = new Date(yyyy, mm - 1, dd);
            if (!Number.isNaN(date.getTime())) return tryFormat(date);
          }

          return s || '-';
        } catch {
          return dateStr;
        }
      }
      
      function truncateText(text, maxLength = 50) {
        if (!text) return '-';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
      }

      function renderSummary(data) {
        const recon = data.reconciliation || {};
        const matches = recon.matches || [];
        const onlyInv = recon.only_in_invoices || [];
        const onlyBank = recon.only_in_bank || [];
        const acc = recon.accuracy || {};
        const invAcc = acc.invoice_match_percentage ?? 0;
        const bankAcc = acc.bank_match_percentage ?? 0;
        const reconId = recon.reconciliation_id ?? "-";
        const processingTime = recon.processing_time_formatted || 
          (recon.processing_time_seconds ? `${recon.processing_time_seconds.toFixed(2)} seconds` : "");

        const invAccClass = invAcc >= 80 ? "success" : invAcc >= 50 ? "warning" : "";
        const bankAccClass = bankAcc >= 80 ? "success" : bankAcc >= 50 ? "warning" : "";
        
        // Pre-processing estimate (from file sizes, before parsing)
        const preEstimate = data.pre_processing_estimate || {};
        const preEstTime = preEstimate.total_estimated_time_formatted || '';
        const preEstParsing = preEstimate.estimated_parsing_time || 0;
        const preEstRecon = preEstimate.estimated_reconciliation_time || 0;
        const preEstTx = preEstimate.estimated_transactions || {};
        
        // Post-parsing estimate (more accurate, after we know actual transaction counts)
        const estimatedTime = recon.estimated_time_formatted || 
          (recon.estimated_time_seconds ? `${recon.estimated_time_seconds.toFixed(2)} seconds` : "");

        let matchesTableHTML = '';
        if (matches.length > 0) {
          matchesTableHTML = `
            <table class="matches-table">
              <thead>
                <tr>
                  <th>Invoice ID</th>
                  <th>Invoice Number</th>
                  <th>Invoice Date</th>
                  <th>Invoice Description</th>
                  <th>Invoice Amount</th>
                  <th>Transaction ID</th>
                  <th>Bank Date</th>
                  <th>Bank Description</th>
                  <th>Bank Amount</th>
                  <th>Amount Δ</th>
                  <th>Balance</th>
                  <th>Credit/Debit</th>
                  <th>Match Score</th>
                  <th class="actions-col">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${matches.map((match, matchIndex) => {
                  const inv = match.invoice || {};
                  const bank = match.bank || {};
                  const invAmt = Number(inv.amount) || 0;
                  const bankAmt = Number(bank.amount) || 0;
                  const delta = invAmt - bankAmt;
                  const absDelta = Math.abs(delta);
                  const deltaClass = absDelta <= 0.01 ? 'delta-ok' : (absDelta <= 1 ? 'delta-warn' : 'delta-bad');
                  const score = (match.match_score * 100).toFixed(1);
                  const isManual = match.is_manual_match || false;
                  // Use match_id from database (can be 0, which is valid)
                  // Fallback to matchIndex only if match_id is truly missing (undefined/null)
                  let matchId;
                  if (match.match_id !== undefined && match.match_id !== null) {
                    matchId = match.match_id;
                  } else {
                    matchId = matchIndex;
                    console.warn(`Match at index ${matchIndex} missing match_id. Using index ${matchIndex} as fallback. This may cause delete to fail.`);
                  }
                  
                  // Get invoice_id, transaction_id, and invoice_file_id from match
                  const invoiceId = match.invoice_id || inv.id || 'N/A';
                  const transactionId = match.transaction_id || bank.id || 'N/A';
                  const invoiceFileId = match.invoice_file_id;
                  const hasInvoiceImage = invoiceFileId !== null && invoiceFileId !== undefined;

                  let pageFragment = '';
                  if (inv.file_name && inv.file_name.includes('#')) {
                    pageFragment = '#' + inv.file_name.split('#')[1];
                  }
                  
                  const bankDirection = bank.direction || (bank.amount && bank.amount > 0 ? 'credit' : 'debit');
                  const bankBalance = bank.balance || 'N/A';

                  return `
                    <tr data-match-id="${match.id || ''}">
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${invoiceId}</td>
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${inv.invoice_number || match.invoice_number || 'N/A'}</td>
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${formatDate(inv.date)}</td>
                      <td class="description-cell" title="${(inv.description || '').replace(/"/g, '&quot;')}">${truncateText(inv.description, 30)}</td>
                      <td class="amount-cell">${formatCurrency(inv.amount || 0)}</td>
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${transactionId}</td>
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${formatDate(bank.date)}</td>
                      <td class="description-cell" title="${(bank.description || '').replace(/"/g, '&quot;')}">${truncateText(bank.description, 30)}</td>
                      <td class="amount-cell">${formatCurrency(bank.amount || 0)}</td>
                      <td class="delta-cell ${deltaClass}">${formatCurrency(delta)}</td>
                      <td style="font-size: 0.85rem; color: #64748b; font-weight: 600;">${bankBalance}</td>
                      <td style="font-size: 0.85rem; color: ${bankDirection === 'credit' ? '#059669' : '#dc2626'}; font-weight: 600;">
                        <i class="fas fa-arrow-${bankDirection === 'credit' ? 'up' : 'down'}" style="margin-right: 4px;"></i>
                        ${bankDirection.toUpperCase()}
                      </td>
                      <td>
                        <span class="match-score">${score}%</span>
                        ${isManual ? '<span style="margin-left: 6px; font-size: 0.7rem; color: #2563eb; font-weight: 600;" title="Manual Match">(Manual)</span>' : ''}
                      </td>
                      <td class="actions-col">
                        <div class="match-actions">
                          <button 
                            class="btn-view" 
                            onclick="viewInvoiceImage('${inv.file_path || ''}', '${inv.invoice_number || 'N/A'}')"
                            title="View Invoice Image"
                          >
                            <i class="fas fa-eye"></i>
                          </button>
                          <button 
                            class="btn-delete" 
                            onclick="deleteMatch(${recon.id}, ${match.id || 'null'})"
                            title="Delete match"
                          >
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        }

        let unmatchedInvHTML = '';
        if (onlyInv.length > 0) {
          unmatchedInvHTML = `
            <table class="unmatched-table" id="unmatched-invoices-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${onlyInv.map((item, index) => `
                  <tr class="unmatched-row" data-type="invoice" data-index="${index}" style="cursor: pointer;">
                    <td class="description-cell" title="${(item.description || '').replace(/"/g, '&quot;')}">${truncateText(item.description, 50)}</td>
                    <td class="amount-cell">${formatCurrency(item.amount || 0)}</td>
                    <td>${formatDate(item.date)}</td>
                    <td>
                      <div style="display: flex; gap: 6px;">
                        <button 
                          type="button" 
                          class="json-toggle" 
                          style="padding: 6px 12px; font-size: 0.8rem;"
                          onclick="selectForManualMatch('invoice', ${index}, event)"
                          title="Match with existing bank transaction"
                        >
                          <i class="fas fa-link"></i> Match Existing
                        </button>
                        <button 
                          type="button" 
                          class="json-toggle" 
                          style="padding: 6px 12px; font-size: 0.8rem; background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #4ade80;"
                          onclick="uploadDocumentToMatch('invoice', ${index}, event)"
                          title="Upload bank statement document to match"
                        >
                          <i class="fas fa-upload"></i> Upload Bank Doc
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }

        let unmatchedBankHTML = '';
        if (onlyBank.length > 0) {
          unmatchedBankHTML = `
            <table class="unmatched-table" id="unmatched-bank-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${onlyBank.map((item, index) => `
                  <tr class="unmatched-row" data-type="bank" data-index="${index}" style="cursor: pointer;">
                    <td class="description-cell" title="${(item.description || '').replace(/"/g, '&quot;')}">${truncateText(item.description, 50)}</td>
                    <td class="amount-cell">${formatCurrency(item.amount || 0)}</td>
                    <td>${formatDate(item.date)}</td>
                    <td>
                      <div style="display: flex; gap: 6px;">
                        <button 
                          type="button" 
                          class="json-toggle" 
                          style="padding: 6px 12px; font-size: 0.8rem;"
                          onclick="selectForManualMatch('bank', ${index}, event)"
                          title="Match with existing invoice"
                        >
                          <i class="fas fa-link"></i> Match Existing
                        </button>
                        <button 
                          type="button" 
                          class="json-toggle" 
                          style="padding: 6px 12px; font-size: 0.8rem; background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #4ade80;"
                          onclick="uploadDocumentToMatch('bank', ${index}, event)"
                          title="Upload invoice document to match"
                        >
                          <i class="fas fa-upload"></i> Upload Invoice Doc
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }

        const totalInvoiceTxs = matches.length + onlyInv.length;
        const totalBankTxs = matches.length + onlyBank.length;

        const totalTransactions = totalInvoiceTxs + totalBankTxs;

        const overdueDays = 30;
        const nowTs = Date.now();
        const msPerDay = 24 * 60 * 60 * 1000;
        const parseDateTs = (v) => {
          if (!v) return null;
          const d = new Date(v);
          const t = d.getTime();
          return Number.isFinite(t) ? t : null;
        };

        const overdueInvoices = onlyInv.filter((item) => {
          const ts = parseDateTs(item.date);
          if (!ts) return false;
          return (nowTs - ts) > (overdueDays * msPerDay);
        });

        const overdueInvoiceCount = overdueInvoices.length;
        const overdueInvoiceAmount = overdueInvoices.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);

        const totalInvoiceAmount = (
          matches.reduce((sum, m) => sum + (Number((m.invoice || {}).amount) || 0), 0) +
          onlyInv.reduce((sum, item) => sum + (Number(item.amount) || 0), 0)
        );

        const totalBankAmount = (
          matches.reduce((sum, m) => sum + (Number((m.bank || {}).amount) || 0), 0) +
          onlyBank.reduce((sum, item) => sum + (Number(item.amount) || 0), 0)
        );

        const unmatchedInvoiceAmount = onlyInv.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
        const unmatchedBankAmount = onlyBank.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);

        const invNotProcessed = 0;
        const bankNotProcessed = 0;
        const invMatched = matches.length;
        const invExceptions = onlyInv.length;
        const bankMatched = matches.length;
        const bankExceptions = onlyBank.length;

        const invTotal = Math.max(1, totalInvoiceTxs);
        const bankTotal = Math.max(1, totalBankTxs);

        const invNotPct = Math.max(0, Math.min(100, (invNotProcessed / invTotal) * 100));
        const invMatchPct = Math.max(0, Math.min(100, (invMatched / invTotal) * 100));
        const invExcPct = Math.max(0, Math.min(100, (invExceptions / invTotal) * 100));

        const bankNotPct = Math.max(0, Math.min(100, (bankNotProcessed / bankTotal) * 100));
        const bankMatchPct = Math.max(0, Math.min(100, (bankMatched / bankTotal) * 100));
        const bankExcPct = Math.max(0, Math.min(100, (bankExceptions / bankTotal) * 100));
        
        summaryEl.innerHTML = `
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">Reconciliation ID</div>
              <div class="summary-value highlight">#${reconId}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total Matches</div>
              <div class="summary-value ${matches.length > 0 ? 'success' : ''}">${matches.length}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Only in Invoices</div>
              <div class="summary-value">${onlyInv.length}</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
                ${formatCurrency(unmatchedInvoiceAmount)}
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Only in Bank</div>
              <div class="summary-value">${onlyBank.length}</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
                ${formatCurrency(unmatchedBankAmount)}
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total Invoice Tx</div>
              <div class="summary-value">${totalInvoiceTxs}</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
                ${formatCurrency(totalInvoiceAmount)}
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total Bank Tx</div>
              <div class="summary-value">${totalBankTxs}</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
                ${formatCurrency(totalBankAmount)}
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total Transactions</div>
              <div class="summary-value">${totalTransactions}</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
                ${formatCurrency(totalInvoiceAmount)} · ${formatCurrency(totalBankAmount)}
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Overdue Invoices (${overdueDays}d+)</div>
              <div class="summary-value ${overdueInvoiceCount > 0 ? 'warning' : ''}">${overdueInvoiceCount}</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
                ${formatCurrency(overdueInvoiceAmount)}
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Invoice Accuracy</div>
              <div class="summary-value ${invAccClass}">${invAcc.toFixed(2)}%</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
                ${matches.length} of ${totalInvoiceTxs} matched
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Bank Accuracy</div>
              <div class="summary-value ${bankAccClass}">${bankAcc.toFixed(2)}%</div>
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
                ${matches.length} of ${totalBankTxs} matched
              </div>
            </div>
          </div>

          <div class="side-panels">
            <div class="side-panel">
              <div class="side-panel-head">
                <div>
                  <div class="side-panel-title">Side A: Bank Data Source</div>
                  <div class="side-panel-sub">Total items: ${invTotal}</div>
                </div>
              </div>
              <div class="segbar" role="img" aria-label="Bank data source progress">
                <span class="seg-not" style="width: ${invNotPct.toFixed(2)}%"></span>
                <span class="seg-match" style="width: ${invMatchPct.toFixed(2)}%"></span>
                <span class="seg-exc" style="width: ${invExcPct.toFixed(2)}%"></span>
              </div>
              <div class="segbar-scale">
                <span>0</span>
                <span>${invTotal}</span>
              </div>
              <div class="segbar-legend">
                <span><span class="dot dot-not"></span>Not processed (${invNotProcessed})</span>
                <span><span class="dot dot-match"></span>Matched (${invMatched})</span>
                <span><span class="dot dot-exc"></span>Exceptions (${invExceptions})</span>
              </div>
            </div>

            <div class="side-panel">
              <div class="side-panel-head">
                <div>
                  <div class="side-panel-title">Side B: Ledger</div>
                  <div class="side-panel-sub">Total items: ${bankTotal}</div>
                </div>
              </div>
              <div class="segbar" role="img" aria-label="Ledger progress">
                <span class="seg-not" style="width: ${bankNotPct.toFixed(2)}%"></span>
                <span class="seg-match" style="width: ${bankMatchPct.toFixed(2)}%"></span>
                <span class="seg-exc" style="width: ${bankExcPct.toFixed(2)}%"></span>
              </div>
              <div class="segbar-scale">
                <span>0</span>
                <span>${bankTotal}</span>
              </div>
              <div class="segbar-legend">
                <span><span class="dot dot-not"></span>Not processed (${bankNotProcessed})</span>
                <span><span class="dot dot-match"></span>Matched (${bankMatched})</span>
                <span><span class="dot dot-exc"></span>Exceptions (${bankExceptions})</span>
              </div>
            </div>
          </div>

          ${(matches.length > 0 || onlyInv.length > 0 || onlyBank.length > 0) ? `
            <div class="data-area">
              <div class="results-filter" id="results-filter">
                <div class="results-filter-tabs" role="tablist" aria-label="Results filter">
                  <button type="button" class="results-filter-btn" data-filter="matched" onclick="setResultsFilter('matched')">Matched (${matches.length})</button>
                  <button type="button" class="results-filter-btn" data-filter="unmatched_invoices" onclick="setResultsFilter('unmatched_invoices')">Unmatched Invoices (${onlyInv.length})</button>
                  <button type="button" class="results-filter-btn" data-filter="unmatched_bank" onclick="setResultsFilter('unmatched_bank')">Unmatched Bank (${onlyBank.length})</button>
                  <button type="button" class="results-filter-btn" data-filter="exceptions" onclick="setResultsFilter('exceptions')">Exceptions (${onlyInv.length + onlyBank.length})</button>
                </div>
                <div class="results-filter-right">
                  <div class="results-search" role="search">
                    <i class="fas fa-search"></i>
                    <input id="results-search-input" type="text" placeholder="Search transactions…" oninput="setResultsSearch(this.value)" />
                  </div>
                </div>
              </div>
              ${matches.length > 0 ? `
                <div class="results-section results-section--full" data-results-section="matched">
                  <div class="results-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <i class="fas fa-check-circle"></i>
                      Matched Transactions (${matches.length})
                    </div>
                    <div style="display: flex; gap: 8px;">
                      <button
                        type="button"
                        class="json-toggle"
                        id="export-matches-csv-btn"
                        style="margin: 0; background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #4ade80;"
                        onclick="exportMatches('csv', ${reconId})"
                        title="Export matches to CSV"
                      >
                        <i class="fas fa-file-csv"></i>
                        <span>CSV</span>
                      </button>
                      <button
                        type="button"
                        class="json-toggle"
                        id="export-matches-excel-btn"
                        style="margin: 0; background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #4ade80;"
                        onclick="exportMatches('xlsx', ${reconId})"
                        title="Export matches to Excel"
                      >
                        <i class="fas fa-file-excel"></i>
                        <span>Excel</span>
                      </button>
                      <button
                        type="button"
                        class="json-toggle"
                        id="export-matches-pdf-btn"
                        style="margin: 0; background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.4); color: #f87171;"
                        onclick="exportMatches('pdf', ${reconId})"
                        title="Export matches to PDF"
                      >
                        <i class="fas fa-file-pdf"></i>
                        <span>PDF</span>
                      </button>
                    </div>
                  </div>
                  ${matchesTableHTML}
                </div>
              ` : ''}

              ${onlyInv.length > 0 ? `
                <div class="results-section" data-results-section="unmatched_invoices">
                  <div class="results-section-title">
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <i class="fas fa-exclamation-triangle"></i>
                      Unmatched Invoices (${onlyInv.length})
                    </div>
                  </div>
                  <div style="margin-bottom: 15px; font-size: 0.9rem; color: #475569; padding: 12px; background: rgba(113, 75, 103, 0.1); border-radius: 8px; border-left: 4px solid var(--primary);">
                    <i class="fas fa-info-circle" style="margin-right: 6px; color: var(--primary);"></i>
                    <strong style="color: var(--primary);">Manual Matching Options:</strong><br>
                    • <strong>Match Existing:</strong> Match with existing unmatched bank transactions<br>
                    • <strong>Upload Bank Doc:</strong> Upload a bank statement document to extract and match transactions<br>
                    • <strong>Add Manual Entry:</strong> Create a new invoice entry manually
                  </div>
                  <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <button
                      type="button"
                      class="submit-btn"
                      style="padding: 8px 16px; font-size: 0.85rem; background: var(--primary); border-color: var(--primary);"
                      onclick="showManualEntryModal('invoice', ${reconId})"
                      title="Add a new invoice entry manually"
                    >
                      <i class="fas fa-plus"></i>
                      Add Manual Invoice Entry
                    </button>
                  </div>
                  ${unmatchedInvHTML}
                </div>
              ` : ''}

              ${onlyBank.length > 0 ? `
                <div class="results-section" data-results-section="unmatched_bank">
                  <div class="results-section-title">
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <i class="fas fa-exclamation-triangle"></i>
                      Unmatched Bank Transactions (${onlyBank.length})
                    </div>
                  </div>
                  <div style="margin-bottom: 15px; font-size: 0.9rem; color: #475569; padding: 12px; background: rgba(113, 75, 103, 0.1); border-radius: 8px; border-left: 4px solid var(--primary);">
                    <i class="fas fa-info-circle" style="margin-right: 6px; color: var(--primary);"></i>
                    <strong style="color: var(--primary);">Manual Matching Options:</strong><br>
                    • <strong>Match Existing:</strong> Match with existing unmatched invoices<br>
                    • <strong>Upload Invoice Doc:</strong> Upload an invoice document to extract and match transactions<br>
                    • <strong>Add Manual Entry:</strong> Create a new bank transaction entry manually
                  </div>
                  <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <button
                      type="button"
                      class="submit-btn"
                      style="padding: 8px 16px; font-size: 0.85rem; background: var(--primary); border-color: var(--primary);"
                      onclick="showManualEntryModal('bank', ${reconId})"
                      title="Add a new bank transaction entry manually"
                    >
                      <i class="fas fa-plus"></i>
                      Add Manual Bank Entry
                    </button>
                  </div>
                  ${unmatchedBankHTML}
                </div>
              ` : ''}
            </div>
          ` : ''}
          
          ${matches.length === 0 && onlyInv.length === 0 && onlyBank.length === 0 ? `
            <div class="empty-state">
              <i class="fas fa-info-circle"></i>
              <div>No transactions found. Please check your uploaded files.</div>
            </div>
          ` : ''}
        `;

        // Choose a sensible default tab if the current one would show nothing.
        // Priority: matched -> unmatched invoices -> unmatched bank -> exceptions
        if (currentResultsFilter === "matched" && matches.length === 0) {
          currentResultsFilter = onlyInv.length > 0
            ? "unmatched_invoices"
            : (onlyBank.length > 0 ? "unmatched_bank" : "exceptions");
        }

        if (currentResultsFilter === "unmatched_invoices" && onlyInv.length === 0) {
          currentResultsFilter = matches.length > 0
            ? "matched"
            : (onlyBank.length > 0 ? "unmatched_bank" : "exceptions");
        }

        if (currentResultsFilter === "unmatched_bank" && onlyBank.length === 0) {
          currentResultsFilter = matches.length > 0
            ? "matched"
            : (onlyInv.length > 0 ? "unmatched_invoices" : "exceptions");
        }

        if (currentResultsFilter === "exceptions" && (onlyInv.length + onlyBank.length) === 0) {
          currentResultsFilter = matches.length > 0
            ? "matched"
            : (onlyInv.length > 0 ? "unmatched_invoices" : (onlyBank.length > 0 ? "unmatched_bank" : "matched"));
        }

        applyResultsFilter();
      }
      
      // JSON toggle functionality
      function initJsonToggle() {
        const jsonToggle = document.getElementById('json-toggle');
        const jsonContainer = document.getElementById('json-container');
        
        if (jsonToggle && jsonContainer) {
          jsonToggle.addEventListener('click', () => {
            const isShowing = jsonContainer.classList.contains('show');
            if (isShowing) {
              jsonContainer.classList.remove('show');
              jsonToggle.querySelector('span').textContent = 'Show JSON';
              jsonToggle.querySelector('i').className = 'fas fa-chevron-down';
            } else {
              jsonContainer.classList.add('show');
              jsonToggle.querySelector('span').textContent = 'Hide JSON';
              jsonToggle.querySelector('i').className = 'fas fa-chevron-up';
            }
          });
        }
      }
      
      // Initialize JSON toggle when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initJsonToggle);
      } else {
        initJsonToggle();
      }
      
      // Global variables for manual matching
      let currentReconciliationData = null;
      let selectedInvoiceIndex = null;
      let selectedBankIndex = null;
      
      // Export matches to CSV, Excel, or PDF
      async function exportMatches(format, reconciliationId) {
        const formatNames = {
          'csv': 'CSV',
          'xlsx': 'Excel',
          'pdf': 'PDF'
        };
        const formatIcons = {
          'csv': 'fa-file-csv',
          'xlsx': 'fa-file-excel',
          'pdf': 'fa-file-pdf'
        };
        const formatColors = {
          'csv': { bg: 'rgba(34, 197, 94, 0.2)', border: 'rgba(34, 197, 94, 0.4)', text: '#4ade80' },
          'xlsx': { bg: 'rgba(34, 197, 94, 0.2)', border: 'rgba(34, 197, 94, 0.4)', text: '#4ade80' },
          'pdf': { bg: 'rgba(239, 68, 68, 0.2)', border: 'rgba(239, 68, 68, 0.4)', text: '#f87171' }
        };
        
        try {
          const btn = document.getElementById(`export-matches-${format}-btn`);
          if (btn) {
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i><span> Exporting...</span>`;
          }
          
          const response = await fetch(`/api/reconciliations/${reconciliationId}/matches/export?format=${format}`);
          
          if (!response.ok) {
            const error = await response.json();
            alert(`Error exporting ${formatNames[format]}: ${error.error || 'Unknown error'}`);
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = `<i class="fas ${formatIcons[format]}"></i><span> ${formatNames[format]}</span>`;
            }
            return;
          }
          
          // Download the file
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const extension = format === 'xlsx' ? 'xlsx' : format;
          a.download = `reconciliation_${reconciliationId}_matches.${extension}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          
          // Show success message
          const statusEl = document.getElementById("status");
          if (statusEl) {
            statusEl.textContent = `✓ Successfully exported to ${formatNames[format]}!`;
            statusEl.className = "status success show";
            setTimeout(() => {
              statusEl.className = "status success";
            }, 3000);
          }
          
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas ${formatIcons[format]}"></i><span> ${formatNames[format]}</span>`;
          }
        } catch (error) {
          console.error(`Error exporting ${formatNames[format]}:`, error);
          alert(`Error exporting ${formatNames[format]}. Please try again.`);
          const btn = document.getElementById(`export-matches-${format}-btn`);
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas ${formatIcons[format]}"></i><span> ${formatNames[format]}</span>`;
          }
        }
      }
      
      // Keep old function for backward compatibility
      async function exportMatchesToCSV(reconciliationId) {
        return exportMatches('csv', reconciliationId);
      }
      
      // Manual matching functionality
      function selectForManualMatch(type, index, event) {
        event.stopPropagation();
        
        if (!currentReconciliationData) {
          alert('No reconciliation data available. Please run a reconciliation first.');
          return;
        }
        
        const recon = currentReconciliationData.reconciliation || {};
        const onlyInv = recon.only_in_invoices || [];
        const onlyBank = recon.only_in_bank || [];
        
        if (type === 'invoice') {
          selectedInvoiceIndex = index;
          const invoice = onlyInv[index];
          
          // Show bank transactions for selection
          showBankSelectionModal(invoice, onlyBank);
        } else if (type === 'bank') {
          selectedBankIndex = index;
          const bank = onlyBank[index];
          
          // Show invoices for selection
          showInvoiceSelectionModal(bank, onlyInv);
        }
      }
      
      // Upload document to match functionality
      function uploadDocumentToMatch(type, index, event) {
        event.stopPropagation();
        event.preventDefault();
        
        console.log('uploadDocumentToMatch called', type, index);
        
        if (!currentReconciliationData) {
          alert('No reconciliation data available. Please run a reconciliation first.');
          return;
        }
        
        const recon = currentReconciliationData.reconciliation || {};
        const onlyInv = recon.only_in_invoices || [];
        const onlyBank = recon.only_in_bank || [];
        
        const documentType = type === 'invoice' ? 'bank' : 'invoice'; // Opposite type
        const unmatchedItem = type === 'invoice' ? onlyInv[index] : onlyBank[index];
        
        if (!unmatchedItem) {
          alert('Selected item not found. Please try again.');
          return;
        }
        
        console.log('Showing upload modal for:', documentType, unmatchedItem);
        showDocumentUploadModal(type, index, unmatchedItem, documentType);
      }
      
      function showDocumentUploadModal(unmatchedType, unmatchedIndex, unmatchedItem, documentType) {
        const modal = document.createElement('div');
        modal.id = 'document-upload-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 10001;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: #ffffff;
          border-radius: 20px;
          padding: 30px;
          max-width: 900px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          border: 1px solid rgba(37, 99, 235, 0.3);
          box-shadow: 0 20px 60px rgba(37, 99, 235, 0.2);
        `;
        
        const documentTypeLabel = documentType === 'invoice' ? 'Invoice' : 'Bank Statement';
        const unmatchedTypeLabel = unmatchedType === 'invoice' ? 'Invoice' : 'Bank Transaction';
        
        modalContent.innerHTML = `
          <h2 style="color: #2563eb; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <span><i class="fas fa-upload"></i> Upload ${documentTypeLabel} Document to Match</span>
            <button onclick="closeDocumentUploadModal()" style="background: transparent; border: none; color: #1e3a5f; font-size: 1.5rem; cursor: pointer;">×</button>
          </h2>
          <div style="background: rgba(37, 99, 235, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2563eb;">
            <div style="font-weight: 600; color: #2563eb; margin-bottom: 8px;">Unmatched ${unmatchedTypeLabel}:</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Description:</strong> ${unmatchedItem.description || 'N/A'}</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Amount:</strong> ${formatCurrency(unmatchedItem.amount || 0)}</div>
            <div style="color: #1e3a5f;"><strong>Date:</strong> ${formatDate(unmatchedItem.date)}</div>
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #1e40af; font-weight: 600; margin-bottom: 10px;">
              <i class="fas fa-file-upload"></i> Select ${documentTypeLabel} Document (PDF, Excel, CSV, Image):
            </label>
            <div id="file-upload-area" style="position: relative; border: 2px dashed rgba(37, 99, 235, 0.5); border-radius: 8px; padding: 20px; background: rgba(37, 99, 235, 0.05); transition: all 0.3s ease; cursor: pointer;" onclick="document.getElementById('document-upload-input').click();">
            <input 
              type="file" 
              id="document-upload-input" 
              accept="${documentType === 'invoice' ? 'application/pdf,image/*,.xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel' : 'application/pdf,image/*,.xlsx,.xls,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel'}"
                style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; z-index: 1;"
              />
              <div style="text-align: center; pointer-events: none;">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #2563eb; margin-bottom: 10px; opacity: 0.7;"></i>
                <div style="color: #1e40af; font-weight: 600; margin-bottom: 5px;">Click to Upload or Drag & Drop</div>
                <div style="color: #64748b; font-size: 0.85rem;">PDF, Excel, CSV, or Image files</div>
              </div>
              <div id="selected-file-name" style="margin-top: 12px; padding: 10px; background: rgba(37, 99, 235, 0.15); border-radius: 6px; color: #2563eb; font-size: 0.9rem; display: none; text-align: center; border: 1px solid rgba(37, 99, 235, 0.3);">
                <i class="fas fa-file-check"></i> <span id="file-name-text"></span>
            </div>
            </div>
            <div style="margin-top: 10px; font-size: 0.85rem; color: #64748b; padding: 8px; background: rgba(37, 99, 235, 0.05); border-radius: 6px;">
              <i class="fas fa-info-circle"></i> Supported formats: PDF, Excel (.xlsx, .xls), ${documentType === 'bank' ? 'CSV, ' : ''}Images (PNG, JPG, etc.)
            </div>
          </div>
          <button 
            type="button" 
            id="process-document-btn"
            class="submit-btn" 
            style="width: 100%; padding: 14px; font-size: 1rem;"
            onclick="processUploadedDocument('${unmatchedType}', ${unmatchedIndex}, '${documentType}')"
          >
            <i class="fas fa-cog"></i> Process Document & Extract Transactions
          </button>
          <div id="document-processing-status" style="margin-top: 15px; display: none;"></div>
          <div id="extracted-transactions-container" style="margin-top: 20px; display: none;">
            <h3 style="color: #2563eb; margin-bottom: 15px;">Extracted Transactions:</h3>
            <div id="extracted-transactions-list"></div>
          </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Add event listeners for file input (after modal is added to DOM)
        setTimeout(() => {
          const fileInput = document.getElementById('document-upload-input');
          const fileNameDiv = document.getElementById('selected-file-name');
          const fileNameText = document.getElementById('file-name-text');
          const fileUploadArea = document.getElementById('file-upload-area');
          
          if (!fileInput) {
            console.error('File input element not found in modal!');
            return;
          }
          
            // Show selected file name
            fileInput.addEventListener('change', function(e) {
              if (e.target.files && e.target.files.length > 0) {
              const file = e.target.files[0];
              const fileName = file.name;
              const fileSize = (file.size / 1024 / 1024).toFixed(2);
              if (fileNameText) {
                fileNameText.textContent = fileName + ' (' + fileSize + ' MB)';
              }
              if (fileNameDiv) {
                fileNameDiv.style.display = 'block';
              }
                if (fileUploadArea) {
                  fileUploadArea.style.borderColor = 'rgba(34, 197, 94, 0.6)';
                  fileUploadArea.style.background = 'rgba(34, 197, 94, 0.1)';
                fileUploadArea.style.borderStyle = 'solid';
                }
              console.log('File selected:', fileName, fileSize, 'MB');
              } else {
                if (fileNameDiv) fileNameDiv.style.display = 'none';
                if (fileUploadArea) {
                  fileUploadArea.style.borderColor = 'rgba(37, 99, 235, 0.5)';
                fileUploadArea.style.background = 'rgba(37, 99, 235, 0.05)';
                fileUploadArea.style.borderStyle = 'dashed';
                }
              }
            });
            
            // Drag and drop functionality
            if (fileUploadArea) {
              fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.style.borderColor = 'rgba(37, 99, 235, 0.8)';
                fileUploadArea.style.background = 'rgba(37, 99, 235, 0.15)';
              fileUploadArea.style.borderStyle = 'solid';
              });
              
              fileUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!fileInput.files || fileInput.files.length === 0) {
                  fileUploadArea.style.borderColor = 'rgba(37, 99, 235, 0.5)';
                fileUploadArea.style.background = 'rgba(37, 99, 235, 0.05)';
                fileUploadArea.style.borderStyle = 'dashed';
                }
              });
              
              fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                // Create a new FileList-like object
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(e.dataTransfer.files[0]);
                fileInput.files = dataTransfer.files;
                  fileInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
              });
            }
            
            console.log('File input element ready for upload');
        }, 100);
      }
      
      async function processUploadedDocument(unmatchedType, unmatchedIndex, documentType) {
        const fileInput = document.getElementById('document-upload-input');
        const processBtn = document.getElementById('process-document-btn');
        const statusDiv = document.getElementById('document-processing-status');
        const containerDiv = document.getElementById('extracted-transactions-container');
        const transactionsListDiv = document.getElementById('extracted-transactions-list');
        
        if (!fileInput.files || !fileInput.files[0]) {
          alert('Please select a file first.');
          return;
        }
        
        const file = fileInput.files[0];
        
        // Show processing status
        processBtn.disabled = true;
        processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<div style="color: #60a5fa; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #3b82f6;"><i class="fas fa-spinner fa-spin"></i> Processing document and extracting transactions...</div>';
        containerDiv.style.display = 'none';
        
        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('document_type', documentType);
          
          const response = await fetch('/api/process-document', {
            method: 'POST',
            body: formData
          });
          
          let result;
          try {
            result = await response.json();
          } catch (jsonErr) {
            console.error("Failed to parse JSON response:", jsonErr);
            const text = await response.text();
            console.error("Response text:", text);
            statusDiv.innerHTML = `<div style="color: #f87171; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;"><i class="fas fa-exclamation-circle"></i> Error: Server returned invalid response (${response.status}). Check console for details.</div>`;
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="fas fa-cog"></i> Process Document & Extract Transactions';
            return;
          }
          
          if (!response.ok) {
            statusDiv.innerHTML = `<div style="color: #f87171; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;"><i class="fas fa-exclamation-circle"></i> Error: ${result.error || 'Unknown error'}</div>`;
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="fas fa-cog"></i> Process Document & Extract Transactions';
            return;
          }
          
          // Show success and display extracted transactions
          statusDiv.innerHTML = `<div style="color: #4ade80; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 4px solid #22c55e;"><i class="fas fa-check-circle"></i> Successfully extracted ${result.transaction_count} transaction(s) from ${result.file_name}</div>`;
          
          // Display extracted transactions
          if (result.transactions && result.transactions.length > 0) {
            const unmatchedItem = unmatchedType === 'invoice' 
              ? currentReconciliationData.reconciliation.only_in_invoices[unmatchedIndex]
              : currentReconciliationData.reconciliation.only_in_bank[unmatchedIndex];
            
            // Try to auto-match based on amount similarity
            const unmatchedAmount = Math.abs(unmatchedItem.amount || 0);
            let bestMatch = null;
            let bestMatchIndex = -1;
            let bestMatchScore = 0;
            
            result.transactions.forEach((tx, idx) => {
              const txAmount = Math.abs(tx.amount || 0);
              const amountDiff = Math.abs(unmatchedAmount - txAmount);
              const matchScore = unmatchedAmount > 0 ? 1 - (amountDiff / unmatchedAmount) : 0;
              
              // If amounts are very close (within 1% or ₹1), consider it a match
              if (amountDiff < Math.max(1, unmatchedAmount * 0.01) && matchScore > bestMatchScore) {
                bestMatch = tx;
                bestMatchIndex = idx;
                bestMatchScore = matchScore;
              }
            });
            
            // Auto-match if found, otherwise show list for manual selection
            if (bestMatch && bestMatchScore > 0.99) {
              // Automatically match without confirmation
              statusDiv.innerHTML = `<div style="color: #4ade80; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 4px solid #22c55e;"><i class="fas fa-spinner fa-spin"></i> Auto-match found! Matching transactions automatically...</div>`;
              
              // Automatically create the match
              const unmatchedData = encodeURIComponent(JSON.stringify(unmatchedItem));
              const bestMatchData = encodeURIComponent(JSON.stringify(bestMatch));
              
              // Call match function directly without confirmation
              try {
                await autoMatchWithUploadedTransaction(unmatchedType, unmatchedIndex, bestMatchIndex, unmatchedData, bestMatchData);
                // Function will close modal and refresh, so we don't need to do anything else
                return;
              } catch (error) {
                console.error('Error in auto-match:', error);
                statusDiv.innerHTML = `<div style="color: #f87171; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;"><i class="fas fa-exclamation-circle"></i> Error during auto-match. Please try manual matching below.</div>`;
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-cog"></i> Process Document & Extract Transactions';
                // Continue to show the list below
              }
            }
            
            transactionsListDiv.innerHTML = `
              ${bestMatch ? `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(34, 197, 94, 0.15); border-radius: 10px; border-left: 4px solid #22c55e;">
                  <div style="color: #4ade80; font-weight: 600; margin-bottom: 10px;">
                    <i class="fas fa-magic"></i> Potential Match Found!
                  </div>
                  <div style="color: #1e3a5f; margin-bottom: 12px;">
                    System found a potential match. Click below to confirm or select another transaction:
                  </div>
                  <button 
                    type="button" 
                    class="submit-btn" 
                    style="width: 100%; padding: 12px; font-size: 0.95rem;"
                    onclick="matchWithUploadedTransactionHandler(document.querySelector('[data-tx-index=\"${bestMatchIndex}\"]'))"
                    data-unmatched-type="${unmatchedType}"
                    data-unmatched-index="${unmatchedIndex}"
                    data-tx-index="${bestMatchIndex}"
                    data-unmatched-data="${encodeURIComponent(JSON.stringify(unmatchedItem))}"
                    data-tx-data="${encodeURIComponent(JSON.stringify(bestMatch))}"
                  >
                    <i class="fas fa-check-circle"></i> Confirm Match (Amount: ${formatCurrency(bestMatch.amount)})
                  </button>
                </div>
              ` : `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(37, 99, 235, 0.15); border-radius: 10px; border-left: 4px solid #2563eb;">
                  <div style="color: #2563eb; font-weight: 600; margin-bottom: 10px;">
                    <i class="fas fa-info-circle"></i> No Auto-Match Found
                  </div>
                  <div style="color: #1e3a5f; margin-bottom: 12px;">
                    No automatic match was found. Please manually select a transaction from the list below to match, or close this window to keep it unmatched.
                  </div>
                </div>
              `}
              <div style="margin-bottom: 10px; color: #1e40af; font-weight: 600;">
                All Extracted Transactions (${result.transactions.length}):
              </div>
              <table class="unmatched-table" style="width: 100%;">
                <thead>
                  <tr>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.transactions.map((tx, idx) => {
                    // Store transaction data in data attributes to avoid JSON escaping issues
                    const txData = encodeURIComponent(JSON.stringify(tx));
                    const unmatchedData = encodeURIComponent(JSON.stringify(unmatchedItem));
                    const isBestMatch = idx === bestMatchIndex;
                    return `
                    <tr ${isBestMatch ? 'style="background: rgba(34, 197, 94, 0.1);"' : ''}>
                      <td class="description-cell" title="${(tx.description || '').replace(/"/g, '&quot;')}">${truncateText(tx.description, 50)}${isBestMatch ? ' <span style="color: #4ade80; font-size: 0.8rem;">(Auto-Match)</span>' : ''}</td>
                      <td class="amount-cell">${formatCurrency(tx.amount || 0)}</td>
                      <td>${formatDate(tx.date)}</td>
                      <td>
                        <button 
                          type="button" 
                          class="json-toggle" 
                          style="padding: 6px 12px; font-size: 0.8rem; background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #4ade80;"
                          data-unmatched-type="${unmatchedType}"
                          data-unmatched-index="${unmatchedIndex}"
                          data-tx-index="${idx}"
                          data-unmatched-data="${unmatchedData}"
                          data-tx-data="${txData}"
                          onclick="matchWithUploadedTransactionHandler(this)"
                        >
                          <i class="fas fa-check"></i> Match This
                        </button>
                      </td>
                    </tr>
                  `;
                  }).join('')}
                </tbody>
              </table>
            `;
            containerDiv.style.display = 'block';
          } else {
            transactionsListDiv.innerHTML = '<div style="text-align: center; padding: 30px; color: #64748b;"><i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i><div>No transactions found in the uploaded document.</div><div style="font-size: 0.85rem; margin-top: 10px;">Please check the file format and try again.</div></div>';
            containerDiv.style.display = 'block';
          }
          
          processBtn.disabled = false;
          processBtn.innerHTML = '<i class="fas fa-check"></i> Document Processed';
          
        } catch (error) {
          console.error('Error processing document:', error);
          statusDiv.innerHTML = `<div style="color: #f87171; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;"><i class="fas fa-exclamation-circle"></i> Error processing document. Please try again.</div>`;
          processBtn.disabled = false;
          processBtn.innerHTML = '<i class="fas fa-cog"></i> Process Document & Extract Transactions';
        }
      }
      
      function matchWithUploadedTransactionHandler(button) {
        const unmatchedType = button.getAttribute('data-unmatched-type');
        const unmatchedIndex = parseInt(button.getAttribute('data-unmatched-index'));
        const uploadedTxIndex = parseInt(button.getAttribute('data-tx-index'));
        const unmatchedItemJson = decodeURIComponent(button.getAttribute('data-unmatched-data'));
        const uploadedTxJson = decodeURIComponent(button.getAttribute('data-tx-data'));
        
        matchWithUploadedTransaction(unmatchedType, unmatchedIndex, uploadedTxIndex, unmatchedItemJson, uploadedTxJson);
      }
      
      async function autoMatchWithUploadedTransaction(unmatchedType, unmatchedIndex, uploadedTxIndex, unmatchedItemJson, uploadedTxJson) {
        try {
          const unmatchedItem = JSON.parse(unmatchedItemJson);
          const uploadedTx = JSON.parse(uploadedTxJson);
          const recon = currentReconciliationData.reconciliation || {};
          const reconciliationId = recon.reconciliation_id;
          
          if (!reconciliationId) {
            alert('Reconciliation ID not found.');
            return;
          }
          
          // Prepare data for matching
          let invoiceData, bankData;
          if (unmatchedType === 'invoice') {
            invoiceData = unmatchedItem;
            bankData = uploadedTx;
          } else {
            invoiceData = uploadedTx;
            bankData = unmatchedItem;
          }
          
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Auto-matching transactions...";
          statusEl.className = "status processing show";
          
          // Create manual match automatically
          const requestBody = {
            invoice: invoiceData,
            bank: bankData
          };
          console.log('Sending manual match request:', {
            reconciliationId,
            invoiceData,
            bankData
          });
          const response = await fetch(`/api/reconciliations/${reconciliationId}/manual-match`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
          });
          
          let result;
          try {
            result = await response.json();
          } catch (jsonErr) {
            console.error("Failed to parse JSON response:", jsonErr);
            const text = await response.text();
            console.error("Response text:", text);
            statusEl.textContent = `Error: Server returned invalid response (${response.status})`;
            statusEl.className = "status error show";
            alert(`Error creating auto-match: Server returned status ${response.status}. Check console for details.`);
            return;
          }
          
          if (!response.ok) {
            const errorMsg = result.error || 'Unknown error';
            const errorDetails = result.errors ? `\n\nValidation errors:\n${result.errors.join('\n')}` : '';
            const warningsDetails = result.warnings ? `\n\nWarnings:\n${result.warnings.join('\n')}` : '';
            console.error('Manual match error:', result);
            statusEl.textContent = `Error: ${errorMsg}`;
            statusEl.className = "status error show";
            alert(`Error creating auto-match: ${errorMsg}${errorDetails}${warningsDetails}`);
            return;
          }
          
          statusEl.textContent = "✓ Auto-match created successfully! Refreshing reconciliation...";
          statusEl.className = "status success show";
          
          closeDocumentUploadModal();
          
          // Reload reconciliation
          await refreshReconciliation(reconciliationId);
          
        } catch (error) {
          console.error('Error auto-matching with uploaded transaction:', error);
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Error creating auto-match. Please try again.";
          statusEl.className = "status error show";
          alert('Error creating auto-match. Please try again.');
        }
      }
      
      async function matchWithUploadedTransaction(unmatchedType, unmatchedIndex, uploadedTxIndex, unmatchedItemJson, uploadedTxJson) {
        try {
          const unmatchedItem = JSON.parse(unmatchedItemJson);
          const uploadedTx = JSON.parse(uploadedTxJson);
          const recon = currentReconciliationData.reconciliation || {};
          const reconciliationId = recon.reconciliation_id;
          
          if (!reconciliationId) {
            alert('Reconciliation ID not found.');
            return;
          }
          
          // Prepare data for matching
          let invoiceData, bankData;
          if (unmatchedType === 'invoice') {
            invoiceData = unmatchedItem;
            bankData = uploadedTx;
          } else {
            invoiceData = uploadedTx;
            bankData = unmatchedItem;
          }
          
          // Confirm match
          if (!confirm(`Match this ${unmatchedType === 'invoice' ? 'invoice' : 'bank transaction'} with the uploaded ${unmatchedType === 'invoice' ? 'bank' : 'invoice'} transaction?\n\n${unmatchedType === 'invoice' ? 'Invoice' : 'Bank'}: ${unmatchedItem.description}\nAmount: ${formatCurrency(unmatchedItem.amount)}\n\n${unmatchedType === 'invoice' ? 'Bank' : 'Invoice'} (from uploaded doc): ${uploadedTx.description}\nAmount: ${formatCurrency(uploadedTx.amount)}`)) {
            return;
          }
          
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Creating manual match...";
          statusEl.className = "status processing show";
          
          // Create manual match
          const requestBody = {
            invoice: invoiceData,
            bank: bankData
          };
          console.log('Sending manual match request:', {
            reconciliationId,
            invoiceData,
            bankData
          });
          const response = await fetch(`/api/reconciliations/${reconciliationId}/manual-match`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
          });
          
          let result;
          try {
            result = await response.json();
          } catch (jsonErr) {
            console.error("Failed to parse JSON response:", jsonErr);
            const text = await response.text();
            console.error("Response text:", text);
            statusEl.textContent = `Error: Server returned invalid response (${response.status})`;
            statusEl.className = "status error show";
            alert(`Error creating manual match: Server returned status ${response.status}. Check console for details.`);
            return;
          }
          
          if (!response.ok) {
            const errorMsg = result.error || 'Unknown error';
            const errorDetails = result.errors ? `\n\nValidation errors:\n${result.errors.join('\n')}` : '';
            const warningsDetails = result.warnings ? `\n\nWarnings:\n${result.warnings.join('\n')}` : '';
            console.error('Manual match error:', result);
            statusEl.textContent = `Error: ${errorMsg}`;
            statusEl.className = "status error show";
            alert(`Error creating manual match: ${errorMsg}${errorDetails}${warningsDetails}`);
            return;
          }
          
          statusEl.textContent = "✓ Manual match created successfully! Refreshing reconciliation...";
          statusEl.className = "status success show";
          
          closeDocumentUploadModal();
          
          // Reload reconciliation
          await refreshReconciliation(reconciliationId);
          
        } catch (error) {
          console.error('Error matching with uploaded transaction:', error);
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Error creating manual match. Please try again.";
          statusEl.className = "status error show";
          alert('Error creating manual match. Please try again.');
        }
      }
      
      function closeDocumentUploadModal() {
        const modal = document.getElementById('document-upload-modal');
        if (modal) {
          modal.remove();
        }
      }
      
      // View invoice image function
      function viewInvoiceImage(filePath, invoiceNumber) {
        if (!filePath) {
          alert('Invoice image not available');
          return;
        }
        
        // Create modal to show invoice image
        const modal = document.createElement('div');
        modal.id = 'invoice-image-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.9);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
        `;
        
        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 8px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            position: relative;
          ">
            <div style="
              padding: 20px;
              border-bottom: 1px solid #e5e7eb;
              display: flex;
              justify-content: space-between;
              align-items: center;
            ">
              <h3 style="margin: 0; color: #1f2937;">Invoice #${invoiceNumber}</h3>
              <button 
                onclick="closeInvoiceImageModal()"
                style="
                  background: none;
                  border: none;
                  font-size: 24px;
                  cursor: pointer;
                  color: #6b7280;
                "
              >
                ×
              </button>
            </div>
            <div style="padding: 20px; text-align: center;">
              <img 
                src="/uploads/${filePath.split('/').pop()}" 
                alt="Invoice ${invoiceNumber}"
                style="
                  max-width: 100%;
                  max-height: 70vh;
                  object-fit: contain;
                  border: 1px solid #e5e7eb;
                  border-radius: 4px;
                "
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
              />
              <div style="display: none; color: #ef4444; padding: 20px;">
                Failed to load invoice image. The file may not exist or may be corrupted.
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }
      
      function closeInvoiceImageModal() {
        const modal = document.getElementById('invoice-image-modal');
        if (modal) {
          modal.remove();
        }
      }
      
      // Close modal when clicking outside
      document.addEventListener('click', function(event) {
        const modal = document.getElementById('invoice-image-modal');
        if (modal && event.target === modal) {
          closeInvoiceImageModal();
        }
      });
      
      // Close modal when clicking outside (only if clicking on backdrop, not on modal content)
      document.addEventListener('click', function(event) {
        const modal = document.getElementById('document-upload-modal');
        if (modal && event.target === modal) {
          closeDocumentUploadModal();
        }
      });
      
      // Make functions globally accessible for onclick handlers
      window.uploadDocumentToMatch = uploadDocumentToMatch;
      window.processUploadedDocument = processUploadedDocument;
      window.closeDocumentUploadModal = closeDocumentUploadModal;
      window.matchWithUploadedTransactionHandler = matchWithUploadedTransactionHandler;
      window.autoMatchWithUploadedTransaction = autoMatchWithUploadedTransaction;
      window.viewInvoiceImage = viewInvoiceImage;
      window.closeInvoiceImageModal = closeInvoiceImageModal;
      window.deleteMatch = deleteMatch;
      
      function showBankSelectionModal(invoice, bankTransactions) {
        const modal = document.createElement('div');
        modal.id = 'manual-match-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: #ffffff;
          border-radius: 20px;
          padding: 30px;
          max-width: 900px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          border: 1px solid rgba(37, 99, 235, 0.3);
          box-shadow: 0 20px 60px rgba(37, 99, 235, 0.2);
        `;
        
        modalContent.innerHTML = `
          <h2 style="color: #2563eb; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <span><i class="fas fa-link"></i> Select Bank Transaction to Match</span>
            <button onclick="closeManualMatchModal()" style="background: transparent; border: none; color: #1e3a5f; font-size: 1.5rem; cursor: pointer;">×</button>
          </h2>
          <div style="background: rgba(37, 99, 235, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2563eb;">
            <div style="font-weight: 600; color: #2563eb; margin-bottom: 8px;">Selected Invoice:</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Description:</strong> ${invoice.description || 'N/A'}</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Amount:</strong> ${formatCurrency(invoice.amount || 0)}</div>
            <div style="color: #1e3a5f;"><strong>Date:</strong> ${formatDate(invoice.date)}</div>
          </div>
          <div style="max-height: 400px; overflow-y: auto;">
            <table class="unmatched-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${bankTransactions.map((bank, idx) => `
                  <tr>
                    <td class="description-cell" title="${(bank.description || '').replace(/"/g, '&quot;')}">${truncateText(bank.description, 50)}</td>
                    <td class="amount-cell">${formatCurrency(bank.amount || 0)}</td>
                    <td>${formatDate(bank.date)}</td>
                    <td>
                      <button 
                        type="button" 
                        class="json-toggle" 
                        style="padding: 6px 12px; font-size: 0.8rem;"
                        onclick="confirmManualMatch(${selectedInvoiceIndex}, ${idx})"
                      >
                        <i class="fas fa-check"></i> Select
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
      }
      
      function showInvoiceSelectionModal(bank, invoices) {
        const modal = document.createElement('div');
        modal.id = 'manual-match-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: #ffffff;
          border-radius: 20px;
          padding: 30px;
          max-width: 900px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          border: 1px solid rgba(37, 99, 235, 0.3);
          box-shadow: 0 20px 60px rgba(37, 99, 235, 0.2);
        `;
        
        modalContent.innerHTML = `
          <h2 style="color: #2563eb; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <span><i class="fas fa-link"></i> Select Invoice to Match</span>
            <button onclick="closeManualMatchModal()" style="background: transparent; border: none; color: #1e3a5f; font-size: 1.5rem; cursor: pointer;">×</button>
          </h2>
          <div style="background: rgba(37, 99, 235, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2563eb;">
            <div style="font-weight: 600; color: #2563eb; margin-bottom: 8px;">Selected Bank Transaction:</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Description:</strong> ${bank.description || 'N/A'}</div>
            <div style="color: #1e3a5f; margin-bottom: 4px;"><strong>Amount:</strong> ${formatCurrency(bank.amount || 0)}</div>
            <div style="color: #1e3a5f;"><strong>Date:</strong> ${formatDate(bank.date)}</div>
          </div>
          <div style="max-height: 400px; overflow-y: auto;">
            <table class="unmatched-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${invoices.map((inv, idx) => `
                  <tr>
                    <td class="description-cell" title="${(inv.description || '').replace(/"/g, '&quot;')}">${truncateText(inv.description, 50)}</td>
                    <td class="amount-cell">${formatCurrency(inv.amount || 0)}</td>
                    <td>${formatDate(inv.date)}</td>
                    <td>
                      <button 
                        type="button" 
                        class="json-toggle" 
                        style="padding: 6px 12px; font-size: 0.8rem;"
                        onclick="confirmManualMatch(${idx}, ${selectedBankIndex})"
                      >
                        <i class="fas fa-check"></i> Select
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
      }
      
      async function confirmManualMatch(invoiceIndex, bankIndex) {
        if (!currentReconciliationData) {
          alert('No reconciliation data available.');
          return;
        }
        
        const recon = currentReconciliationData.reconciliation || {};
        const onlyInv = recon.only_in_invoices || [];
        const onlyBank = recon.only_in_bank || [];
        const reconciliationId = recon.reconciliation_id;
        
        if (!reconciliationId) {
          alert('Reconciliation ID not found.');
          return;
        }
        
        const invoice = onlyInv[invoiceIndex];
        const bank = onlyBank[bankIndex];
        
        if (!invoice || !bank) {
          alert('Invalid selection.');
          return;
        }
        
        // Confirm with user
        if (!confirm(`Match this invoice with this bank transaction?\n\nInvoice: ${invoice.description}\nAmount: ${formatCurrency(invoice.amount)}\n\nBank: ${bank.description}\nAmount: ${formatCurrency(bank.amount)}`)) {
          return;
        }
        
        try {
          // Show loading state
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Creating manual match...";
          statusEl.className = "status processing show";
          
          const requestBody = {
            invoice_index: invoiceIndex,
            bank_index: bankIndex,
            invoice: invoice,
            bank: bank
          };
          console.log('Sending manual match request:', {
            reconciliationId,
            invoiceIndex,
            bankIndex,
            invoice,
            bank
          });
          const response = await fetch(`/api/reconciliations/${reconciliationId}/manual-match`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
          });
          
          let result;
          try {
            result = await response.json();
          } catch (jsonErr) {
            console.error("Failed to parse JSON response:", jsonErr);
            const text = await response.text();
            console.error("Response text:", text);
            statusEl.textContent = `Error: Server returned invalid response (${response.status})`;
            statusEl.className = "status error show";
            alert(`Error creating manual match: Server returned status ${response.status}. Check console for details.`);
            return;
          }
          
          if (!response.ok) {
            const errorMsg = result.error || 'Unknown error';
            const errorDetails = result.errors ? `\n\nValidation errors:\n${result.errors.join('\n')}` : '';
            const warningsDetails = result.warnings ? `\n\nWarnings:\n${result.warnings.join('\n')}` : '';
            console.error('Manual match error:', result);
            statusEl.textContent = `Error: ${errorMsg}`;
            statusEl.className = "status error show";
            alert(`Error creating manual match: ${errorMsg}${errorDetails}${warningsDetails}`);
            return;
          }
          
          statusEl.textContent = "✓ Manual match created successfully! Refreshing reconciliation...";
          statusEl.className = "status success show";
          closeManualMatchModal();
          
          // Reload reconciliation to get updated data from server
          await refreshReconciliation(reconciliationId);
          
        } catch (error) {
          console.error('Error creating manual match:', error);
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Error creating manual match. Please try again.";
          statusEl.className = "status error show";
          alert('Error creating manual match. Please try again.');
        }
      }
      
      // Function to refresh reconciliation data from server
      async function refreshReconciliation(reconciliationId) {
        try {
          // Fetch updated matches
          const matchesResponse = await fetch(`/api/reconciliations/${reconciliationId}/matches`);
          const matchesData = await matchesResponse.json();
          
          if (!matchesResponse.ok) {
            console.error('Error fetching updated matches:', matchesData);
            return;
          }
          
          // Reconstruct reconciliation data structure
          if (currentReconciliationData && currentReconciliationData.reconciliation) {
            // Update matches with IDs from server
            const updatedMatches = matchesData.matches.map(match => ({
              invoice: {
                description: match.invoice_description,
                amount: match.invoice_amount,
                date: match.invoice_date,
                vendor_name: match.invoice_vendor_name,
                invoice_number: (match.invoice_number || match.invoice_invoice_number || '')
              },
              bank: {
                description: match.bank_description,
                amount: match.bank_amount,
                date: match.bank_date,
                vendor_name: match.bank_vendor_name,
                invoice_number: match.bank_invoice_number
              },
              match_score: match.match_score,
              is_manual_match: match.is_manual_match,
              match_id: match.id,
              id: match.id,
              invoice_id: match.invoice_id,
              transaction_id: match.transaction_id,
              invoice_number: match.invoice_number || match.invoice_invoice_number
            }));
            
            // Get all matched invoice and bank transaction identifiers
            const matchedInvoiceKeys = new Set();
            const matchedBankKeys = new Set();
            
            updatedMatches.forEach(match => {
              // Create unique keys for matching (amount + description)
              const invKey = `${match.invoice.amount || 0}_${match.invoice.description || ''}`;
              const bankKey = `${match.bank.amount || 0}_${match.bank.description || ''}`;
              matchedInvoiceKeys.add(invKey);
              matchedBankKeys.add(bankKey);
            });
            
            // Filter out matched items from unmatched lists
            const originalOnlyInv = currentReconciliationData.reconciliation.only_in_invoices || [];
            const originalOnlyBank = currentReconciliationData.reconciliation.only_in_bank || [];
            
            const updatedOnlyInv = originalOnlyInv.filter(item => {
              const itemKey = `${item.amount || 0}_${item.description || ''}`;
              return !matchedInvoiceKeys.has(itemKey);
            });
            
            const updatedOnlyBank = originalOnlyBank.filter(item => {
              const itemKey = `${item.amount || 0}_${item.description || ''}`;
              return !matchedBankKeys.has(itemKey);
            });
            
            // Update current data
            currentReconciliationData.reconciliation.matches = updatedMatches;
            currentReconciliationData.reconciliation.only_in_invoices = updatedOnlyInv;
            currentReconciliationData.reconciliation.only_in_bank = updatedOnlyBank;
            
            // Update accuracy percentages
            const totalInvoiceTxs = updatedMatches.length + updatedOnlyInv.length;
            const totalBankTxs = updatedMatches.length + updatedOnlyBank.length;
            const invoiceMatchPct = totalInvoiceTxs > 0 ? (updatedMatches.length / totalInvoiceTxs) * 100 : 0;
            const bankMatchPct = totalBankTxs > 0 ? (updatedMatches.length / totalBankTxs) * 100 : 0;
            
            if (!currentReconciliationData.reconciliation.accuracy) {
              currentReconciliationData.reconciliation.accuracy = {};
            }
            currentReconciliationData.reconciliation.accuracy.invoice_match_percentage = invoiceMatchPct;
            currentReconciliationData.reconciliation.accuracy.bank_match_percentage = bankMatchPct;
            
            // Show success message
            const statusEl = document.getElementById("status");
            statusEl.textContent = `✓ Match created successfully! Updated: ${updatedMatches.length} matches, ${updatedOnlyInv.length} unmatched invoices, ${updatedOnlyBank.length} unmatched bank transactions.`;
            statusEl.className = "status success show";
            
            // Re-render summary with updated data
            renderSummary(currentReconciliationData);
          }
        } catch (error) {
          console.error('Error refreshing reconciliation:', error);
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Match created, but error refreshing view. Please refresh the page.";
          statusEl.className = "status warning show";
        }
      }
      
      // Function to delete/remove a match and update all counts dynamically
      async function unmatchTransaction(reconciliationId, matchId, event) {
        event.stopPropagation();
        
        if (!confirm('Are you sure you want to DELETE this match?\n\nThis will permanently remove the match between the invoice and bank transaction. This action cannot be undone.\n\nThe counts and unmatched sections will be updated automatically.')) {
          return;
        }
        
        try {
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Deleting match...";
          statusEl.className = "status processing show";
          
          // Get the match data before deleting (from the row)
          const row = document.querySelector(`tr[data-match-id="${matchId}"]`);
          if (!row) {
            alert('Match row not found in UI.');
            return;
          }
          
          // Extract invoice and bank data from the row
          const cells = row.querySelectorAll('td');
          const invoiceDesc = cells[0]?.textContent?.trim() || '';
          const invoiceAmount = cells[1]?.textContent?.trim() || '';
          const bankDesc = cells[2]?.textContent?.trim() || '';
          const bankAmount = cells[3]?.textContent?.trim() || '';
          
          // Try to get full data from currentReconciliationData
          let invoiceData = null;
          let bankData = null;
          if (currentReconciliationData && currentReconciliationData.reconciliation) {
            const matches = currentReconciliationData.reconciliation.matches || [];
            const match = matches.find(m => {
              const mId = m.match_id !== undefined && m.match_id !== null ? m.match_id : null;
              return mId === matchId;
            });
            if (match) {
              invoiceData = match.invoice || {};
              bankData = match.bank || {};
            }
          }
          
          // If we couldn't get full data, create basic objects from row data
          if (!invoiceData) {
            invoiceData = {
              description: invoiceDesc,
              amount: parseFloat(invoiceAmount.replace(/[₹,\s]/g, '')) || 0,
              date: null
            };
          }
          if (!bankData) {
            bankData = {
              description: bankDesc,
              amount: parseFloat(bankAmount.replace(/[₹,\s]/g, '')) || 0,
              date: null
            };
          }
          
          // Delete the match from backend
          const response = await fetch(`/api/reconciliations/${reconciliationId}/matches/${matchId}`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            statusEl.textContent = `Error: ${result.error || 'Unknown error'}`;
            statusEl.className = "status error show";
            alert(`Error deleting match: ${result.error || 'Unknown error'}`);
            return;
          }
          
          // Update currentReconciliationData
          if (currentReconciliationData && currentReconciliationData.reconciliation) {
            const recon = currentReconciliationData.reconciliation;
            
            // Remove match from matches array
            recon.matches = (recon.matches || []).filter(m => {
              const mId = m.match_id !== undefined && m.match_id !== null ? m.match_id : null;
              return mId !== matchId;
            });
            
            // Add invoice to unmatched invoices
            if (!recon.only_in_invoices) {
              recon.only_in_invoices = [];
            }
            recon.only_in_invoices.push(invoiceData);
            
            // Add bank transaction to unmatched bank
            if (!recon.only_in_bank) {
              recon.only_in_bank = [];
            }
            recon.only_in_bank.push(bankData);
            
            // Recalculate accuracy percentages
            const totalInvoiceTxs = recon.matches.length + recon.only_in_invoices.length;
            const totalBankTxs = recon.matches.length + recon.only_in_bank.length;
            const invAcc = totalInvoiceTxs > 0 ? (recon.matches.length / totalInvoiceTxs * 100) : 0;
            const bankAcc = totalBankTxs > 0 ? (recon.matches.length / totalBankTxs * 100) : 0;
            
            // Update accuracy in reconciliation data
            if (!recon.accuracy) {
              recon.accuracy = {};
            }
            recon.accuracy.invoice_match_percentage = invAcc;
            recon.accuracy.bank_match_percentage = bankAcc;
          }
          
          // Remove the row from matched table
          row.remove();
          
          // Re-render the entire reconciliation display with updated data
          if (currentReconciliationData) {
            renderSummary(currentReconciliationData);
          }
          
          statusEl.textContent = "✓ Match deleted successfully! Counts and unmatched sections have been updated automatically.";
          statusEl.className = "status success show";
          
        } catch (error) {
          console.error('Error deleting match:', error);
          const statusEl = document.getElementById("status");
          statusEl.textContent = "Error deleting match. Please try again.";
          statusEl.className = "status error show";
          alert('Error deleting match. Please try again.');
        }
      }
      
      function closeManualMatchModal() {
        const modal = document.getElementById('manual-match-modal');
        if (modal) {
          modal.remove();
        }
        selectedInvoiceIndex = null;
        selectedBankIndex = null;
      }
      
      // Delete match function
      async function deleteMatch(reconciliationId, matchId) {
        if (!confirm('Are you sure you want to delete this match?')) {
          return;
        }
        
        try {
          const response = await fetch(`/api/reconciliation/${reconciliationId}/matches/${matchId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            // Reload the page to show updated matches
            window.location.reload();
          } else {
            alert('Failed to delete match');
          }
        } catch (error) {
          console.error('Error deleting match:', error);
          alert('Error deleting match');
        }
      }
      
      // Manual Entry Functions
      function showManualEntryModal(type, reconciliationId) {
        const modalTitle = type === 'invoice' ? 'Add Manual Invoice Entry' : 'Add Manual Bank Transaction Entry';
        const modalContent = `
          <div id="manual-entry-modal" class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; box-sizing: border-box;">
            <div class="modal-content" style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 100%; max-height: calc(100vh - 40px); overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); margin: auto; position: relative;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: var(--text); font-size: 1.2rem; font-weight: 700;">
                  <i class="fas fa-${type === 'invoice' ? 'file-invoice' : 'university'}" style="margin-right: 8px; color: var(--primary);"></i>
                  ${modalTitle}
                </h3>
                <button type="button" onclick="closeManualEntryModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <form id="manual-entry-form" onsubmit="submitManualEntry(event, '${type}', ${reconciliationId})">
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text); font-size: 0.9rem;">
                    Description <span style="color: #ef4444;">*</span>
                  </label>
                  <input
                    type="text"
                    name="description"
                    required
                    style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; transition: border-color 0.2s;"
                    placeholder="Enter description"
                    onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'"
                  />
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text); font-size: 0.9rem;">
                    Amount <span style="color: #ef4444;">*</span>
                  </label>
                  <input
                    type="number"
                    name="amount"
                    step="0.01"
                    required
                    style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; transition: border-color 0.2s;"
                    placeholder="0.00"
                    onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'"
                  />
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text); font-size: 0.9rem;">
                    Date <span style="color: #ef4444;">*</span>
                  </label>
                  <input
                    type="date"
                    name="date"
                    required
                    style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; transition: border-color 0.2s;"
                    onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'"
                  />
                </div>
                
                ${type === 'invoice' ? `
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text); font-size: 0.9rem;">
                      Invoice Number
                    </label>
                    <input
                      type="text"
                      name="invoice_number"
                      style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; transition: border-color 0.2s;"
                      placeholder="INV-001"
                      onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'"
                    />
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text); font-size: 0.9rem;">
                      Vendor Name
                    </label>
                    <input
                      type="text"
                      name="vendor_name"
                      style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; transition: border-color 0.2s;"
                      placeholder="Vendor Ltd"
                      onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'"
                    />
                  </div>
                ` : `
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text); font-size: 0.9rem;">
                      Reference ID
                    </label>
                    <input
                      type="text"
                      name="reference_id"
                      style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; transition: border-color 0.2s;"
                      placeholder="REF-001"
                      onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'"
                    />
                  </div>
                `}
                
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text); font-size: 0.9rem;">
                    Currency
                  </label>
                  <select
                    name="currency"
                    style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; transition: border-color 0.2s;"
                    onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'"
                  >
                    <option value="GBP">GBP (£)</option>
                    <option value="USD">USD ($)</option>
                    <option value="EUR">EUR (€)</option>
                  </select>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border);">
                  <button
                    type="button"
                    onclick="closeManualEntryModal()"
                    style="padding: 10px 20px; border: 1px solid var(--border); background: white; color: var(--text); border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s;"
                    onmouseover="this.style.background='#f8fafc'"
                    onmouseout="this.style.background='white'"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    class="submit-btn"
                    style="padding: 10px 20px; border: 1px solid var(--primary); background: var(--primary); color: white; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s;"
                    onmouseover="this.style.background='var(--primary-hover)'"
                    onmouseout="this.style.background='var(--primary)'"
                  >
                    <i class="fas fa-plus"></i>
                    Add Entry
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalContent);
        
        // Set today's date as default
        const dateInput = document.querySelector('#manual-entry-form input[name="date"]');
        if (dateInput) {
          dateInput.value = new Date().toISOString().split('T')[0];
        }
      }
      
      function closeManualEntryModal() {
        const modal = document.getElementById('manual-entry-modal');
        if (modal) {
          modal.remove();
        }
      }
      
      async function submitManualEntry(event, type, reconciliationId) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        
        const data = {
          type: type,
          description: formData.get('description').trim(),
          amount: parseFloat(formData.get('amount')),
          date: formData.get('date'),
          currency: formData.get('currency')
        };
        
        if (type === 'invoice') {
          data.invoice_number = formData.get('invoice_number')?.trim() || '';
          data.vendor_name = formData.get('vendor_name')?.trim() || '';
        } else {
          data.reference_id = formData.get('reference_id')?.trim() || '';
        }
        
        try {
          const statusEl = document.getElementById("status");
          if (statusEl) {
            statusEl.textContent = `Creating manual ${type} entry...`;
            statusEl.className = "status processing show";
          }
          
          const response = await fetch(`/api/reconciliations/${reconciliationId}/manual-entry`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            if (statusEl) {
              statusEl.textContent = `Error: ${result.error || 'Unknown error'}`;
              statusEl.className = "status error show";
            }
            alert(`Error creating manual entry: ${result.error || 'Unknown error'}`);
            return;
          }
          
          if (statusEl) {
            statusEl.textContent = `✓ Manual ${type} entry created successfully! Refreshing results...`;
            statusEl.className = "status success show";
            setTimeout(() => {
              statusEl.className = "status success";
            }, 3000);
          }
          
          // Close modal
          closeManualEntryModal();
          
          // Refresh reconciliation results to show the new entry
          if (currentReconciliationData) {
            // Reload the reconciliation data
            try {
              const refreshResponse = await fetch(`/api/reconciliation/${reconciliationId}`);
              const refreshData = await refreshResponse.json();
              if (refreshResponse.ok) {
                currentReconciliationData = refreshData;
                renderSummary(currentReconciliationData);
              }
            } catch (err) {
              console.error('Error refreshing reconciliation data:', err);
              // Fallback: reload the page
              window.location.reload();
            }
          }
          
        } catch (error) {
          console.error('Error creating manual entry:', error);
          const statusEl = document.getElementById("status");
          if (statusEl) {
            statusEl.textContent = "Error creating manual entry. Please try again.";
            statusEl.className = "status error show";
          }
          alert('Error creating manual entry. Please try again.');
        }
      }
      
      // Wrap renderSummary to store data
      const originalRenderSummaryFunction = renderSummary;
      renderSummary = function(data) {
        currentReconciliationData = data;
        return originalRenderSummaryFunction(data);
      };
    </script>
  </body>
</html>
